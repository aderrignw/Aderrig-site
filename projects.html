<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="page:projects" name="anw-acl-key"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<!-- Auth pre-check disabled (temporary public mode) -->
<script>
  (function(){
    try { document.documentElement.classList.remove('anw-preauth-hide'); } catch (_) {}
  })();
</script>
<title>Community Projects — Aderrig NW</title>
<link href="assets/style.css" rel="stylesheet"/>
<style>
    /* Page-local helpers */
    .tiny{ font-size:.86rem; }
    .small{ padding:7px 12px; font-size:.88rem; }
    .grid-2{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media (max-width: 920px){ .grid-2{ grid-template-columns: 1fr; } }

    /* ✅ Tabs: only show the active pane */
    .proj-pane{ display:none; }
    .proj-pane.active{ display:block; }

    .toast{
      position:fixed; right:16px; bottom:16px; z-index:999;
      width:min(440px, calc(100% - 32px));
      background:#fff; color:var(--text);
      border-radius:14px;
      border:1px solid rgba(17,24,39,.10);
      border-left:6px solid var(--green);
      padding:12px 14px;
      box-shadow:0 16px 40px rgba(17,24,39,.10);
      display:none;
    }
    .toast.show{ display:block; animation:toastIn .18s ease-out; }
    @keyframes toastIn{ from{ transform:translateY(8px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
    .toast-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .toast strong{ display:block; margin:0; font-weight:900; }
    .toast .toast-close{
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      width:34px; height:34px; border-radius:10px;
      cursor:pointer;
      font-size:18px; line-height:1;
      color:var(--text);
    }
    .toast .toast-close:hover{ background:rgba(17,24,39,.04); }
    .toast[data-type="success"]{ border-left-color:var(--green); }
    .toast[data-type="info"]{ border-left-color:rgba(15,118,110,.9); }
    .toast[data-type="warning"]{ border-left-color:rgba(217,119,6,.95); }
    .toast[data-type="error"]{ border-left-color:rgba(185,28,28,.95); }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .row{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start; flex-wrap:wrap;
    }
    .row .meta{ color:var(--muted); }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(17,24,39,.10);
      padding:6px 10px; border-radius:999px; background:#fff;
      font-weight:650; font-size:.86rem;
    }
    .chip b{ font-weight:900; }

    .rec-item, .attach-item{
      display:flex; justify-content:space-between; gap:10px;
      align-items:center; flex-wrap:wrap;
      border:1px solid rgba(17,24,39,.08);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .rec-name, .attach-name{ font-weight:850; }
    .rec-meta, .attach-meta{ color:var(--muted); font-size:.88rem; }

    details.acc{
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      margin:10px 0;
    }
    details.acc > summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      font-weight:850;
    }
    details.acc > summary::-webkit-details-marker{ display:none !important; }
    .acc-body{ padding:12px 14px; border-top:1px solid rgba(17,24,39,.08); }

    .select-list{ border:1px solid rgba(17,24,39,.10); border-radius:14px; overflow:hidden; }
    .select-list .item{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; padding:10px 12px; border-bottom:1px solid rgba(17,24,39,.08); background:#fff; }
    .select-list .item:last-child{ border-bottom:none; }
    .select-list .item label{ font-weight:800; }

    .bar{ height:10px; border-radius:999px; background:rgba(31,111,74,.12); overflow:hidden; }
    .bar > div{ height:100%; background:var(--brand); width:0%; }
  
  .btn-danger{ border:1px solid #c62828; color:#c62828; background:#fff; }
  .btn-danger:hover{ background:#fff5f5; }
  .inline-confirm{ margin-top:12px; }
  .inline-confirm__card{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:var(--shadow); }
  .inline-confirm__title{ font-weight:800; margin-bottom:6px; }
  .inline-confirm__body{ color:var(--muted); font-size:.95rem; margin-bottom:12px; }
  .inline-confirm__actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }

</style>
<style id="page-access-style">
  footer.site-footer { position: relative; }
  footer.site-footer .page-access {
    position: absolute;
    left: 0;
    color: green;
    font-weight: normal;
  }
</style>
<style id="anw-flex-layout">
  /* Keep footer at bottom (Home behavior) */
  html, body { height: 100%; }
  body { min-height: 100vh; display: flex; flex-direction: column; }
  main { flex: 1 0 auto; }
</style>
</head>
<body class="page-projects">
<header class="site-header">
<div class="brand">
<a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
<div class="brand-text">
<h1>Aderrig NW</h1>
<p class="muted">Adamstown</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a href="report.html">Report</a>
<a href="alerts.html">Community Alerts</a>
<a class="active" href="projects.html">Community Projects</a>
<a href="handbook.html">Handbook</a>
<a href="login.html">Login / Register</a>
<a href="dashboard.html">Dashboard</a>
<a href="household.html">Household</a>
<a href="admin.html">Admin</a>
</nav>
</header>
<main class="wrap" id="projectsMain">
<section class="card">
<h2>Community Projects</h2>
<p class="muted" style="margin-bottom:.5rem;">Build a project, confirm its delivery to recipients, then track updates over time.</p>
<div class="tiny muted" id="anwAccessNotice" style="margin-top:12px; display:none;">
      You are not logged in. Please <a href="login.html">log in</a> or <a href="login.html#signup">register</a> to continue.
    </div>
<div class="actions proj-tabs" style="justify-content:flex-start; margin-top:.25rem;">
<button class="proj-tab active" data-target="paneBuilder" type="button">Build project</button>
<button class="proj-tab" data-target="paneSend" type="button">Confirm sending</button>
<button class="proj-tab" data-target="paneMonitoring" type="button">Monitoring</button>
</div>
</section>
<!-- ============================ BUILDER ============================ -->
<section class="proj-pane" id="paneBuilder">
<section class="card">
<div class="row">
<div>
<h3>Build project</h3>
<p class="tiny muted" style="margin:0;">Create and edit project details, recipients, and attachments.</p>
</div>
<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
<button class="btn btn-line small" id="btnNewProject" type="button">+ New</button>
<button class="btn btn-line small" id="btnGoSend" type="button">Go to sending →</button>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div>
<div class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end; margin-top:0;">
<div class="field" style="max-width:640px;">
<label>Select a project</label>
<select id="projectSelect">
<option value="">— Select —</option>
<option value="__new__">+ New project</option>
</select>
</div>
<div class="field" style="max-width:420px;">
<label>Category</label>
<select id="projectCategory">
<option selected="" value="">—</option>
<option>Safety &amp; Security</option>
<option>Lighting &amp; Infrastructure</option>
<option>Community Engagement</option>
<option>Environment &amp; Clean-up</option>
<option>Traffic &amp; Parking</option>
<option>Youth &amp; Anti-social Behaviour</option>
<option>Other</option>
</select>
</div>
<div class="field" style="max-width:420px;">
<label>Status</label>
<select id="projectStatus">
<option selected="" value="">—</option>
<option value="draft">Draft</option>
<option value="active">Active</option>
<option value="paused">Paused</option>
<option value="completed">Completed</option>
</select>
</div>
<div class="field" style="max-width:260px;">
<label>Project number</label>
<input id="projectNumber" readonly="" type="text"/>
</div>
</div>
<div class="field">
<label>Project title</label>
<input id="projectTitle" placeholder="Enter a clear project title" type="text"/>
</div>
<div class="proj-accordion open">
<div class="proj-acc-head" data-acc="">Executive summary <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="executive" placeholder="What is the project and why does it matter?"></textarea></div>
</div>
<div class="proj-accordion">
<div class="proj-acc-head" data-acc="">Background <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="background" placeholder="Context, problem statement, any references"></textarea></div>
</div>
<div class="proj-accordion">
<div class="proj-acc-head" data-acc="">Design / Approach <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="design" placeholder="What will be done, and how? Options considered"></textarea></div>
</div>
<div class="proj-accordion">
<div class="proj-acc-head" data-acc="">Implementation plan <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="implementation" placeholder="Milestones, timeline, owners"></textarea></div>
</div>
<div class="proj-accordion">
<div class="proj-acc-head" data-acc="">KPIs / Success criteria <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="kpis" placeholder="How will we measure success?"></textarea></div>
</div>
<div class="proj-accordion">
<div class="proj-acc-head" data-acc="">Additional details <span class="proj-chevron">▾</span></div>
<div class="proj-acc-body"><textarea class="auto-grow" id="annexes" placeholder="Links, supporting information, and extra notes"></textarea></div>
</div>
<div class="actions" style="justify-content:flex-end; margin-top:14px;">
<button class="btn" id="btnSaveProject" type="button">Save project</button>
<button class="btn btn-line" disabled="" id="btnDeleteProject" type="button">Delete project</button>
</div>
<p class="tiny muted" id="builderMsg" style="margin:6px 0 0;"></p>
</div>
<!-- Right column: recipients + attachments + quick summary -->
<div>
<div class="card" style="background:#f9fafb; box-shadow:none; border:1px dashed rgba(17,24,39,.14);">
<div class="row">
<div>
<h4 style="margin:0;">Quick summary</h4>
<div class="tiny muted" style="margin-top:4px;">Live snapshot of what will be sent.</div>
</div>
</div>
<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
<span class="chip"><b id="sumRecipients">0</b> recipients</span>
<span class="chip"><b id="sumAttachments">0</b> attachments</span>
<span class="chip"><b id="sumStatus">—</b></span>
</div>
<div class="tiny muted" id="sumUpdated" style="margin-top:10px;">Not saved yet.</div>
</div>
<div style="height:10px;"></div>
<section class="card">
<h4>Recipients</h4>
<p class="tiny muted">Recipients: add people/organisations who should receive this project.</p>
<div class="field"><label>Name</label><input id="recName" placeholder="e.g. John Smith" type="text"/></div>
<div class="field"><label>Email</label><input id="recEmail" placeholder="name@example.com" type="email"/></div>
<div class="field"><label>Organisation (optional)</label><input id="recOrg" placeholder="e.g. Council" type="text"/></div>
<div class="actions" style="justify-content:flex-end;">
<button class="btn btn-line small" id="btnAddRecipient" type="button">Add recipient</button>
</div>
<div class="list" id="recipientList" style="margin-top:10px;"></div>
</section>
<div style="height:10px;"></div>
<section class="card">
<h4>Attachments</h4>
<p class="tiny muted">Stores file metadata only (name/type/size). Uploads are not stored.</p>
<input id="fileInput" multiple="" style="display:none" type="file"/>
<div class="actions" style="justify-content:flex-end;">
<button class="btn btn-line small" id="btnAddAttach" type="button">Add files</button>
</div>
<div class="list" id="attachList" style="margin-top:10px;"></div>
</section>
</div>
</div>
</section>
</section>
<!-- ============================ SEND (CONFIRM) ============================ -->
<section <div="" class="inline-confirm" hidden="" id="deleteConfirm">
<div class="inline-confirm__card">
<div class="inline-confirm__title">Delete this project?</div>
<div class="inline-confirm__body">This will remove the project and all monitoring records. This can’t be undone.</div>
<div class="inline-confirm__actions">
<button class="btn btn-line" id="btnCancelDelete" type="button">Cancel</button>
<button class="btn btn-danger" id="btnConfirmDelete" type="button">Delete</button>
</div>
</div>

<div class="proj-pane" id="paneSend">
<section class="card">
<div class="row">
<div>
<h3>Confirm sending</h3>
<p class="tiny muted" style="margin:0;">Confirm sending: choose a project, select recipients, and confirm it was sent.</p>
</div>
<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
<button class="btn btn-line small" id="btnGoBuilder" type="button">← Back to builder</button>
<button class="btn btn-line small" id="btnGoMonitoring" type="button">Go to monitoring →</button>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div>
<div class="field">
<label>Select a saved project</label>
<select id="sendProjectSelect">
<option value="">— Select —</option>
</select>
</div>
<div class="card" id="sendProjectCard" style="background:#f9fafb; box-shadow:none; border:1px dashed rgba(17,24,39,.14); display:none !important;">
<div class="row">
<div>
<div id="sendTitle" style="font-weight:900;">—</div>
<div class="muted" id="sendMeta">—</div>
</div>
<div>
<button class="btn btn-line small" id="btnEditFromSend" type="button">Edit</button>
<button class="btn btn-line small" data-proj-delete="">Delete</button>
</div>
</div>
<div style="margin-top:10px;">
<div class="tiny muted" style="margin-bottom:6px;">Message template (optional)</div>
<textarea class="auto-grow" id="sendMessage" placeholder="Short note that was sent with the project (optional)"></textarea>
</div>
</div>
</div>
<div>
<section class="card">
<h4>Recipients to confirm</h4>
<div class="tiny muted" style="margin-bottom:10px;">Tick who received it in this sending batch.</div>
<div class="actions" style="justify-content:flex-start; margin-top:0;">
<button class="btn btn-line small" id="btnSendSelectAll" type="button">Select all</button>
<button class="btn btn-line small" id="btnSendSelectNone" type="button">Select none</button>
</div>
<div class="select-list" id="sendRecipients" style="margin-top:10px;"></div>
<div class="actions" style="justify-content:flex-end; margin-top:14px;">
<button class="btn" id="btnConfirmSend" type="button">Confirm &amp; create monitoring entries</button>
</div>
<p class="tiny muted" id="sendMsg" style="margin:6px 0 0;"></p>
</section>
</div>
</div>
</section>
</div></section>
<!-- ============================ MONITORING ============================ -->
<section class="proj-pane" id="paneMonitoring">
<section class="card">
<div class="row">
<div>
<h3>Monitoring</h3>
<p class="tiny muted" style="margin:0;">Monitoring: track status per recipient, add notes, and keep history.</p>
</div>
<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
<button class="btn btn-line small" id="btnMonRefresh" type="button">Refresh</button>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div class="card" style="background:#f9fafb; box-shadow:none; border:1px dashed rgba(17,24,39,.14);">
<h4 style="margin:0 0 8px;">Overview</h4>
<div style="display:flex; gap:8px; flex-wrap:wrap;">
<span class="chip"><b id="monProjects">0</b> projects</span>
<span class="chip"><b id="monRecipients">0</b> recipients</span>
<span class="chip"><b id="monOpen">0</b> open</span>
<span class="chip"><b id="monDone">0</b> completed</span>
</div>
<div style="margin-top:10px;">
<div class="tiny muted" style="margin-bottom:6px;">Completion</div>
<div class="bar"><div id="monBar"></div></div>
<div class="tiny muted" id="monBarLabel" style="margin-top:6px;">—</div>
</div>
</div>
<div>
<div class="field">
<label>Search</label>
<input id="monSearch" placeholder="Project number, title, recipient, email…" type="text"/>
</div>
<div class="field">
<label>Status filter</label>
<select id="monStatusFilter">
<option value="">All</option>
<option>Sent</option>
<option>Delivered</option>
<option>Read</option>
<option>In progress</option>
<option>Completed</option>
<option>Blocked</option>
<option>Archived</option>
</select>
</div>
</div>
</div>
<div id="monitorList" style="margin-top:12px;"></div>
</section>
</section>
</main>
<footer class="site-footer">
  <div class="footer-row">
    <div class="footer-left">
      <span class="page-status">Exclusive Page</span>
    </div>

    <div class="footer-center">
      © 2025 Aderrig NW · 
      <a href="privacy.html">Privacy Policy</a>
    </div>
  </div>
</footer>
<div aria-live="polite" class="toast" data-type="success" id="toast" role="status">
<div class="toast-head">
<strong id="toastTitle"></strong>
<button aria-label="Close" class="toast-close" id="toastClose" type="button">×</button>
</div>
<div id="toastBody"></div>
</div>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><script src="assets/identity.js"></script><script src="assets/app-core.js"></script>
<script>
(async function(){
  'use strict';
  try { await window.anwInitStore?.(); } catch(_) {}

  // ===== Keys =====
  const PROJECTS_KEY = (window.ANW_KEYS && window.ANW_KEYS.PROJECTS) ? window.ANW_KEYS.PROJECTS : 'anw_projects';
  const PROJECTS_KEY_V = PROJECTS_KEY;
  const MONITORING_KEY = (window.ANW_KEYS && window.ANW_KEYS.MONITORING) ? window.ANW_KEYS.MONITORING : 'anw_project_monitoring';
  const MONITORING_KEY_V = MONITORING_KEY;

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    if(!iso) return '—';
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return '—';
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  }
  function esc(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }
  function isValidEmail(email){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email||'').trim());
  }
  function humanSize(bytes){
    const units = ['B','KB','MB','GB'];
    let i=0, n=bytes||0;
    while(n >= 1024 && i < units.length-1){ n/=1024; i++; }
    return `${n.toFixed(i?1:0)} ${units[i]}`;
  }
  function shortTitle(t, max=70){
    const s = String(t||'').trim();
    return s.length > max ? s.slice(0, max) + '…' : s;
  }
  function norm(v){ return String(v||'').trim().toLowerCase(); }
  function getCreatorEmail(){
    return (window.anwGetLoggedEmail ? window.anwGetLoggedEmail() : '') || '—';
  }

  // ===== Toast =====
  let toastTimer = null;
  function showToast(title, body, type='success'){
    // Toast desativado: não exibe mensagens na tela
    return;
  }


    const toastCloseBtn = $('toastClose');
  toastCloseBtn?.addEventListener('click', () => $('toast')?.classList.remove('show'));
async function loadStore(){
    const p = window.anwLoad ? window.anwLoad(PROJECTS_KEY_V, []) : [];
    const m = window.anwLoad ? window.anwLoad(MONITORING_KEY_V, []) : [];
    return {
      projects: Array.isArray(p) ? p : [],
      monitoring: Array.isArray(m) ? m : []
    };
  }
  async function saveStore(store){
    await window.anwSave?.(PROJECTS_KEY_V, Array.isArray(store?.projects) ? store.projects : []);
    await window.anwSave?.(MONITORING_KEY_V, Array.isArray(store?.monitoring) ? store.monitoring : []);
  }

  // ===== Tabs =====
  const panes = Array.from(document.querySelectorAll('.proj-pane'));
  const tabs = Array.from(document.querySelectorAll('.proj-tab'));
  function setPane(id){
    panes.forEach(p => p.classList.toggle('active', p.id === id));
    tabs.forEach(t => t.classList.toggle('active', t.dataset.target === id));
    if(id === 'paneSend') renderSend();
    if(id === 'paneMonitoring') renderMonitoring();
  }
  tabs.forEach(t => t.addEventListener('click', () => setPane(t.dataset.target || 'paneBuilder')));
  setPane('paneBuilder');

  // ===== Accordion =====
  document.addEventListener('click', (e) => {
    const head = e.target.closest('.proj-acc-head[data-acc], [data-acc].proj-acc-head, [data-acc]');
    if(!head) return;
    const sec = head.closest('.proj-accordion');
    if(!sec) return;
    e.preventDefault();
    e.stopPropagation();
    const pane = sec.closest('.proj-pane') || document;
    pane.querySelectorAll('.proj-accordion.open').forEach(s => { if(s !== sec) s.classList.remove('open'); });
    sec.classList.toggle('open');
    requestAnimationFrame(() => autosizeAll());
  }, true);

  // ===== Auto-grow textareas =====
  const sectionIds = ['executive','background','design','implementation','kpis','annexes','sendMessage'];
  const textareas = sectionIds.map(id => $(id)).filter(Boolean);
  function autosize(el){
    if(!el) return;
    el.style.height = 'auto';
    const max = 560;
    const h = Math.min(el.scrollHeight + 2, max);
    el.style.height = h + 'px';
    el.style.overflow = (el.scrollHeight + 2 > max) ? 'auto' : 'hidden';
  }
  function autosizeAll(){ textareas.forEach(autosize); }
  textareas.forEach(t => t.addEventListener('input', () => autosize(t)));
  autosizeAll();

  // ===== Builder state =====
  const projectSelect = $('projectSelect');
  const projectTitle = $('projectTitle');
  const projectNumber = $('projectNumber');
  const projectCategory = $('projectCategory');
  const projectStatus = $('projectStatus');
  const builderMsg = $('builderMsg');

  const recName = $('recName');
  const recEmail = $('recEmail');
  const recOrg = $('recOrg');
  const btnAddRecipient = $('btnAddRecipient');
  const recipientList = $('recipientList');

  const fileInput = $('fileInput');
  const btnAddAttach = $('btnAddAttach');
  const attachList = $('attachList');

  const btnSaveProject = $('btnSaveProject');
  const btnDeleteProject = $('btnDeleteProject');
  const btnNewProject = $('btnNewProject');
  const btnGoSend = $('btnGoSend');

  let currentRecipients = [];
  let currentAttachments = [];
  let editingProjectId = null;
  let editingProjectNo = null;
  let editingProjectCreatedAt = null;
  let lastSavedAt = null;

  // summary widgets
  const sumRecipients = $('sumRecipients');
  const sumAttachments = $('sumAttachments');
  const sumStatus = $('sumStatus');
  const sumUpdated = $('sumUpdated');

  function setSaveMode(){
    btnSaveProject.textContent = editingProjectId ? 'Update project' : 'Save project';
    if(btnDeleteProject) btnDeleteProject.disabled = !editingProjectId;
    if(editingProjectNo) projectNumber.value = editingProjectNo;
    else if(projectTitle.value.trim()){
      if(!window.__draftProjectNo) window.__draftProjectNo = 'PRJ-' + Date.now().toString();
      projectNumber.value = window.__draftProjectNo;
    } else {
      projectNumber.value = '';
    }
  }

  function updateSummary(){
    if(sumRecipients) sumRecipients.textContent = String(currentRecipients.length);
    if(sumAttachments) sumAttachments.textContent = String(currentAttachments.length);
    if(sumStatus) sumStatus.textContent = projectStatus.value ? projectStatus.value : '—';
    if(sumUpdated) sumUpdated.textContent = lastSavedAt ? ('Last saved: ' + fmtDate(lastSavedAt)) : 'Not saved yet.';
  }

  function resetBuilder(){
    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    lastSavedAt = null;
    window.__draftProjectNo = null;

    projectSelect.value = '';
    projectTitle.value = '';
    projectCategory.value = '';
    projectStatus.value = '';
    projectNumber.value = '';

    ['executive','background','design','implementation','kpis','annexes'].forEach(id => { const el = $(id); if(el) el.value = ''; });
    currentRecipients = [];
    currentAttachments = [];
    renderRecipients();
    renderAttachments();
    setSaveMode();
    autosizeAll();
    updateSummary();
    builderMsg.textContent = '';
  }

  btnNewProject?.addEventListener('click', () => {
    projectSelect.value = '__new__';
    resetBuilder();
    setSaveMode();
    showToast('New project', 'Fill in the details and click Save.');
  });

  btnGoSend?.addEventListener('click', () => setPane('paneSend'));

  // ===== Recipients =====
  function renderRecipients(){
    if(!recipientList) return;
    if(!currentRecipients.length){
      recipientList.innerHTML = '<div class="card" style="padding:12px;"><span class="muted">No recipients yet.</span></div>';
      updateSummary();
      return;
    }
    recipientList.innerHTML = currentRecipients.map((r, idx) => `
      <div class="rec-item">
        <div>
          <div class="rec-name">${esc(r.name || '—')}</div>
          <div class="rec-meta">${esc(r.email || '—')}${r.org ? ' • ' + esc(r.org) : ''}</div>
        </div>
        <button class="btn btn-line small" type="button" data-rec-del="${idx}">Remove</button>
      </div>
    `).join('');
    recipientList.querySelectorAll('[data-rec-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const i = Number(btn.getAttribute('data-rec-del'));
        currentRecipients.splice(i, 1);
        renderRecipients();
        showToast('Recipient removed', 'Updated.');
      });
    });
    updateSummary();
  }

  btnAddRecipient?.addEventListener('click', () => {
    const name = (recName?.value || '').trim();
    const email = (recEmail?.value || '').trim();
    const org = (recOrg?.value || '').trim();

    if(!name || !email){
      showToast('Missing information', 'Please provide at least Name and Email.');
      return;
    }
    if(!isValidEmail(email)){
      showToast('Invalid email', 'Please enter a valid email address.');
      return;
    }
    currentRecipients.push({ name, email, org });
    recName.value = ''; recEmail.value = ''; recOrg.value = '';
    renderRecipients();
  });

  // ===== Attachments (metadata only) =====
  function renderAttachments(){
    if(!attachList) return;
    if(!currentAttachments.length){
      attachList.innerHTML = '<div class="card" style="padding:12px;"><span class="muted">No attachments yet.</span></div>';
      updateSummary();
      return;
    }
    attachList.innerHTML = currentAttachments.map((a, idx) => `
      <div class="attach-item">
        <div>
          <div class="attach-name">${esc(a.name)}</div>
          <div class="attach-meta">${esc([a.type || 'file', humanSize(a.size)].filter(Boolean).join(' • '))}</div>
        </div>
        <button class="btn btn-line small" type="button" data-att-del="${idx}">Remove</button>
      </div>
    `).join('');
    attachList.querySelectorAll('[data-att-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const i = Number(btn.getAttribute('data-att-del'));
        currentAttachments.splice(i, 1);
        renderAttachments();
      });
    });
    updateSummary();
  }
  btnAddAttach?.addEventListener('click', () => fileInput?.click());
  fileInput?.addEventListener('change', () => {
    const files = Array.from(fileInput.files || []);
    if(!files.length) return;
    files.forEach(f => currentAttachments.push({ name: f.name, type: f.type || '', size: f.size || 0 }));
    fileInput.value = '';
    renderAttachments();
    showToast('Attachments added', `${files.length} file(s) added.`);
  });

  // ===== Builder: load project list + edit =====
  async function refreshProjectSelects(){
    const store = await loadStore();
    const projects = store.projects.slice();

    // Builder select
    if(projectSelect){
      const cur = projectSelect.value;
      projectSelect.innerHTML = '<option value="">— Select —</option><option value="__new__">+ New project</option>';
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.projectNo || p.id} • ${shortTitle(p.title)}`;
        projectSelect.appendChild(opt);
      });
      if(cur) projectSelect.value = cur;
    }

    // Send select
    const sendSel = $('sendProjectSelect');
    if(sendSel){
      const cur2 = sendSel.value;
      sendSel.innerHTML = '<option value="">— Select —</option>';
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.projectNo || p.id} • ${shortTitle(p.title)}`;
        sendSel.appendChild(opt);
      });
      if(cur2) sendSel.value = cur2;
    }
  }

  async function editProject(id){
    const store = await loadStore();
    const p = store.projects.find(x => x.id === id);
    if(!p) return;

    editingProjectId = p.id;
    editingProjectNo = p.projectNo || p.id;
    editingProjectCreatedAt = p.createdAt || null;
    lastSavedAt = p.updatedAt || p.createdAt || null;

    projectSelect.value = p.id;
    projectNumber.value = editingProjectNo;
    projectTitle.value = p.title || '';
    projectCategory.value = p.category || '';
    projectStatus.value = p.status || '';

    ['executive','background','design','implementation','kpis','annexes'].forEach(id2 => {
      const el = $(id2);
      if(el) el.value = (p.sections && p.sections[id2]) ? p.sections[id2] : '';
    });

    currentRecipients = Array.isArray(p.recipients) ? JSON.parse(JSON.stringify(p.recipients)) : [];
    currentAttachments = Array.isArray(p.attachments) ? JSON.parse(JSON.stringify(p.attachments)) : [];
    renderRecipients();
    renderAttachments();
    autosizeAll();
    setSaveMode();
    updateSummary();
    builderMsg.textContent = 'Edit mode: update fields and click Update project.';
    setPane('paneBuilder');
  }

  projectSelect?.addEventListener('change', async () => {
    const val = projectSelect.value;
    if(!val){ resetBuilder(); return; }
    if(val === '__new__'){
      resetBuilder();
      setSaveMode();
      return;
    }
    await editProject(val);
  });

  projectTitle?.addEventListener('input', () => { setSaveMode(); });
  projectStatus?.addEventListener('change', updateSummary);

  // ===== Save / Update =====
  function buildProjectPayload(){
    const id = editingProjectId || ('prj_' + Math.random().toString(36).slice(2,10));
    const projectNo = editingProjectNo || (projectNumber.value || window.__draftProjectNo || ('PRJ-' + Date.now().toString()));
    const createdAt = editingProjectCreatedAt || nowISO();
    return {
      id,
      projectNo,
      title: projectTitle.value.trim(),
      category: projectCategory.value || '',
      status: projectStatus.value || '',
      createdBy: getCreatorEmail(),
      createdAt,
      updatedAt: nowISO(),
      sections: {
        executive: ($('executive')?.value || '').trim(),
        background: ($('background')?.value || '').trim(),
        design: ($('design')?.value || '').trim(),
        implementation: ($('implementation')?.value || '').trim(),
        kpis: ($('kpis')?.value || '').trim(),
        annexes: ($('annexes')?.value || '').trim()
      },
      recipients: JSON.parse(JSON.stringify(currentRecipients)),
      attachments: JSON.parse(JSON.stringify(currentAttachments))
    };
  }

  btnSaveProject?.addEventListener('click', async () => {
    const title = projectTitle.value.trim();
    if(!title){
      showToast('Missing information', 'Please enter a project title.');
      return;
    }
    if(currentRecipients.some(r => !isValidEmail(r.email))){
      showToast('Fix recipients', 'One or more recipient emails are invalid.');
      return;
    }

    const store = await loadStore();
    const data = buildProjectPayload();

    let idx = editingProjectId ? store.projects.findIndex(p => p.id === editingProjectId) : -1;
    if(idx < 0 && data.projectNo) idx = store.projects.findIndex(p => (p.projectNo || '') === data.projectNo);

    if(idx >= 0){
      const existing = store.projects[idx];
      data.id = existing.id;
      data.projectNo = existing.projectNo || data.projectNo;
      data.createdAt = existing.createdAt || data.createdAt;
      data.createdBy = existing.createdBy || data.createdBy;
      store.projects[idx] = data;
    } else {
      store.projects.unshift(data);
    }

    await saveStore(store);
    editingProjectId = data.id;
    editingProjectNo = data.projectNo;
    editingProjectCreatedAt = data.createdAt;
    lastSavedAt = data.updatedAt;
    builderMsg.textContent = 'Saved.';
    setSaveMode();
    updateSummary();
    await refreshProjectSelects();
    showToast(idx >= 0 ? 'Project updated' : 'Project saved', 'Saved successfully.');
  });


  // ===== Delete project =====
  const deleteConfirm = $('deleteConfirm');
  const btnCancelDelete = $('btnCancelDelete');
  const btnConfirmDelete = $('btnConfirmDelete');
  let pendingDeleteId = null;

  function openDeleteConfirm(projectId){
    pendingDeleteId = projectId;
    if(deleteConfirm){ deleteConfirm.hidden = false; }
  }
  function closeDeleteConfirm(){
    pendingDeleteId = null;
    if(deleteConfirm){ deleteConfirm.hidden = true; }
  }

  async function deleteProjectById(projectId){
    const store = await loadStore();
    const beforeP = store.projects.length;
    store.projects = store.projects.filter(p => p.id !== projectId);
    const beforeM = store.monitoring.length;
    store.monitoring = store.monitoring.filter(m => m.projectId !== projectId);

    await saveStore(store);
    await refreshProjectSelects();
    await renderMonitoring();
    await renderSend();

    if(editingProjectId === projectId){
      resetBuilder();
    } else {
      setSaveMode();
    }

    const removedProjects = beforeP - store.projects.length;
    const removedMon = beforeM - store.monitoring.length;
    showToast('Project deleted', `Removed ${removedProjects} project and ${removedMon} monitoring record(s).`, 'success');
  }

  btnDeleteProject?.addEventListener('click', () => {
    if(!editingProjectId){
      showToast('Nothing to delete', 'Save the project first, then you can delete it.', 'info');
      return;
    }
    openDeleteConfirm(editingProjectId);
  });
  btnCancelDelete?.addEventListener('click', () => closeDeleteConfirm());
  btnConfirmDelete?.addEventListener('click', async () => {
    if(!pendingDeleteId){ closeDeleteConfirm(); return; }
    const id = pendingDeleteId;
    closeDeleteConfirm();
    await deleteProjectById(id);
  });


  // ===== SEND (confirm) =====
  const sendProjectSelect = $('sendProjectSelect');
  const sendProjectCard = $('sendProjectCard');
  const sendTitle = $('sendTitle');
  const sendMeta = $('sendMeta');
  const sendRecipients = $('sendRecipients');
  const sendMessage = $('sendMessage');
  const btnConfirmSend = $('btnConfirmSend');
  const sendMsg = $('sendMsg');
  const btnEditFromSend = $('btnEditFromSend');
  const btnSendSelectAll = $('btnSendSelectAll');
  const btnSendSelectNone = $('btnSendSelectNone');
  const btnGoBuilder = $('btnGoBuilder');
  const btnGoMonitoring = $('btnGoMonitoring');

  btnGoBuilder?.addEventListener('click', () => setPane('paneBuilder'));
  btnGoMonitoring?.addEventListener('click', () => setPane('paneMonitoring'));
  $('btnMonRefresh')?.addEventListener('click', () => renderMonitoring());

  btnEditFromSend?.addEventListener('click', async () => {
    const pid = sendProjectSelect.value;
    if(pid) await editProject(pid);
  });

  function getCheckedRecipientEmails(){
    const boxes = Array.from(sendRecipients.querySelectorAll('input[type="checkbox"][data-rec-email]'));
    return boxes.filter(b => b.checked).map(b => b.getAttribute('data-rec-email')).filter(Boolean);
  }

  async function renderSend(){
    await refreshProjectSelects();
    sendMsg.textContent = '';
    if(!sendProjectSelect.value){
      sendProjectCard.style.display = 'none';
      sendRecipients.innerHTML = '<div class="item"><span class="muted">Select a project first.</span></div>';
      return;
    }
    await renderSendProject(sendProjectSelect.value);
  }

  async function renderSendProject(projectId){
    const store = await loadStore();
    const p = store.projects.find(x => x.id === projectId);
    if(!p){
      sendProjectCard.style.display = 'none';
      sendRecipients.innerHTML = '<div class="item"><span class="muted">Project not found.</span></div>';
      return;
    }
    sendProjectCard.style.display = 'block';
    sendTitle.textContent = `${p.projectNo || p.id} • ${p.title || 'Project'}`;
    sendMeta.textContent = `${p.category || '—'}${p.status ? ' • Status: ' + p.status : ''} • Last saved: ${fmtDate(p.updatedAt || p.createdAt)}`;
    if(!sendMessage.value.trim()){
      sendMessage.value = `Hello,\n\nPlease find attached / enclosed the project "${p.title}" (${p.projectNo || p.id}).\n\nThank you,\nAderrig NW`;
      autosize(sendMessage);
    }

    const recs = Array.isArray(p.recipients) ? p.recipients : [];
    if(!recs.length){
      sendRecipients.innerHTML = '<div class="item"><span class="muted">This project has no recipients yet. Go back to Build project and add recipients.</span></div>';
      return;
    }

    sendRecipients.innerHTML = recs.map((r, idx) => {
      const ok = isValidEmail(r.email);
      return `
        <div class="item">
          <div style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" ${ok ? 'checked' : ''} data-rec-email="${esc(r.email||'')}" id="send_rec_${idx}" />
            <div>
              <label for="send_rec_${idx}">${esc(r.name || '—')}</label>
              <div class="meta">${esc(r.email || '—')}${r.org ? ' • ' + esc(r.org) : ''}${ok ? '' : ' • (invalid email)'}</div>
            </div>
          </div>
          <div class="meta">${ok ? '' : 'Fix in builder'}</div>
        </div>
      `;
    }).join('');
  }

  sendProjectSelect?.addEventListener('change', async () => {
    sendMsg.textContent = '';
    const pid = sendProjectSelect.value;
    if(!pid){
      sendProjectCard.style.display = 'none';
      sendRecipients.innerHTML = '<div class="item"><span class="muted">Select a project first.</span></div>';
      return;
    }
    await renderSendProject(pid);
  });

  btnSendSelectAll?.addEventListener('click', () => {
    Array.from(sendRecipients.querySelectorAll('input[type="checkbox"][data-rec-email]')).forEach(b => b.checked = true);
  });
  btnSendSelectNone?.addEventListener('click', () => {
    Array.from(sendRecipients.querySelectorAll('input[type="checkbox"][data-rec-email]')).forEach(b => b.checked = false);
  });

  btnConfirmSend?.addEventListener('click', async () => {
    const pid = sendProjectSelect.value;
    if(!pid){ showToast('Select a project', 'Choose a project first.'); return; }

    const store = await loadStore();
    const p = store.projects.find(x => x.id === pid);
    if(!p){ showToast('Project not found', 'Please refresh and try again.'); return; }

    const recs = Array.isArray(p.recipients) ? p.recipients : [];
    const pickedEmails = getCheckedRecipientEmails();
    const picked = recs.filter(r => pickedEmails.includes(r.email));
    if(!picked.length){
      showToast('No recipients selected', 'Tick at least one recipient.');
      return;
    }
    const invalid = picked.filter(r => !isValidEmail(r.email));
    if(invalid.length){
      showToast('Invalid email', 'One or more selected recipients have invalid emails.');
      return;
    }

    const sentAt = nowISO();
    const batchId = 'batch_' + Math.random().toString(36).slice(2,10);
    const msg = (sendMessage?.value || '').trim();

    picked.forEach(r => {
      const existing = store.monitoring.find(m => m.projectId === p.id && norm(m.recipientEmail) === norm(r.email));
      if(existing){
        existing.projectTitle = p.title;
        existing.projectStatus = p.status || existing.projectStatus || 'draft';
        existing.recipientName = r.name || existing.recipientName;
        existing.recipientOrg = r.org || existing.recipientOrg;
        existing.updatedAt = sentAt;
        if(!existing.sentAt) existing.sentAt = sentAt;
        existing.lastBatchId = batchId;
        existing.lastMessage = msg;
        if(!Array.isArray(existing.history)) existing.history = [];
        existing.history.unshift({ at: sentAt, status: 'Sent', notes: msg ? 'Sent (confirmed) + message' : 'Sent (confirmed)' });
        existing.status = existing.status || 'Sent';
      } else {
        store.monitoring.unshift({
          id: 'mon_' + Math.random().toString(36).slice(2,10),
          projectId: p.id,
          projectTitle: p.title,
          projectStatus: p.status || 'draft',
          recipientName: r.name || '',
          recipientEmail: r.email || '',
          recipientOrg: r.org || '',
          status: 'Sent',
          notes: '',
          sentAt,
          updatedAt: sentAt,
          lastBatchId: batchId,
          lastMessage: msg,
          history: [{ at: sentAt, status: 'Sent', notes: msg ? 'Sent (confirmed) + message' : 'Sent (confirmed)' }]
        });
      }
    });

    await saveStore(store);
    sendMsg.textContent = `Confirmed sending to ${picked.length} recipient(s) on ${fmtDate(sentAt)}.`;
    showToast('Sending confirmed', 'Monitoring entries created/updated.');
    await renderMonitoring();
    setPane('paneMonitoring');
  });

  // ===== MONITORING =====
  const monitorList = $('monitorList');
  const monSearch = $('monSearch');
  const monStatusFilter = $('monStatusFilter');
  const monProjects = $('monProjects');
  const monRecipients = $('monRecipients');
  const monOpen = $('monOpen');
  const monDone = $('monDone');
  const monBar = $('monBar');
  const monBarLabel = $('monBarLabel');

  function statusOptions(selected){
    const opts = ['Sent','Delivered','Read','In progress','Completed','Blocked','Archived'];
    const sel = String(selected || 'Sent');
    return opts.map(o => `<option value="${esc(o)}" ${o===sel?'selected':''}>${esc(o)}</option>`).join('');
  }
  function projectStatusOptions(selected){
    const opts = ['draft','active','paused','completed'];
    const sel = String(selected || 'draft');
    return opts.map(o => `<option value="${esc(o)}" ${o===sel?'selected':''}>${esc(o)}</option>`).join('');
  }

  function computeOverview(items){
    const uniqueProjects = new Set(items.map(i => i.projectId || 'unknown'));
    const done = items.filter(i => String(i.status||'') === 'Completed' || String(i.status||'') === 'Archived');
    const open = items.length - done.length;
    monProjects.textContent = String(uniqueProjects.size);
    monRecipients.textContent = String(items.length);
    monOpen.textContent = String(open);
    monDone.textContent = String(done.length);
    const pct = items.length ? Math.round((done.length / items.length) * 100) : 0;
    monBar.style.width = pct + '%';
    monBarLabel.textContent = items.length ? `${pct}% completed (${done.length}/${items.length})` : '—';
  }

  async function renderMonitoring(){
    const store = await loadStore();
    const itemsAll = Array.isArray(store.monitoring) ? store.monitoring : [];
    const projects = Array.isArray(store.projects) ? store.projects : [];
    if(!monitorList) return;

    const q = norm(monSearch?.value || '');
    const sf = String(monStatusFilter?.value || '');
    let items = itemsAll.slice();
    if(sf){ items = items.filter(i => String(i.status||'') === sf); }
    if(q){
      items = items.filter(i => {
        const p = projects.find(x => x.id === i.projectId) || null;
        const hay = [
          i.projectId, i.projectTitle, i.projectStatus,
          (p && p.projectNo) ? p.projectNo : '',
          i.recipientName, i.recipientEmail, i.recipientOrg
        ].map(norm).join(' ');
        return hay.includes(q);
      });
    }

    computeOverview(itemsAll);

    if(!itemsAll.length){
      monitorList.innerHTML = '<div class="card" style="padding:14px;"><span class="muted">No monitoring entries yet. Go to “Confirm sending” and confirm a delivery.</span></div>';
      return;
    }

    // Group by projectId
    const groups = {};
    items.forEach(m => {
      const pid = m.projectId || 'unknown';
      if(!groups[pid]) groups[pid] = [];
      groups[pid].push(m);
    });

    function projectById(pid){ return projects.find(p => p.id === pid) || null; }
    const pids = Object.keys(groups);
    if(!pids.length){
      monitorList.innerHTML = '<div class="card" style="padding:14px;"><span class="muted">No results for this filter.</span></div>';
      return;
    }

    monitorList.innerHTML = pids.map(pid => {
      const rows = groups[pid].slice().sort((a,b)=>String(a.recipientName||'').localeCompare(String(b.recipientName||'')));
      const p = projectById(pid);
      const title = (p && p.title) ? p.title : (rows[0]?.projectTitle || 'Project');
      const pNo = (p && (p.projectNo || p.id)) ? (p.projectNo || p.id) : (rows[0]?.projectId || pid);
      const pStatus = (p && p.status) ? p.status : (rows[0]?.projectStatus || 'draft');
      const last = rows.reduce((acc,r)=> {
        const d = r.updatedAt || r.sentAt || '';
        return String(d).localeCompare(String(acc)) > 0 ? d : acc;
      }, '');

      const doneCount = rows.filter(r => String(r.status||'') === 'Completed' || String(r.status||'') === 'Archived').length;
      const pct = rows.length ? Math.round((doneCount / rows.length) * 100) : 0;

      return `
        <details class="acc" open>
          <summary>
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; width:100%;">
              <div>
                <div style="font-weight:900;">${esc(pNo)} • ${esc(shortTitle(title, 80))}</div>
                <div class="tiny muted">Recipients: ${rows.length} • Completed: ${pct}%${last ? (' • Last update: ' + esc(fmtDate(last))) : ''}</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="field" style="margin:0;">
                  <label class="tiny muted" style="margin:0 0 4px;">Project status</label>
                  <select data-proj-status="${esc(pid)}" style="min-width:160px;">
                    ${projectStatusOptions(pStatus)}
                  </select>
                </div>
                <button class="btn btn-line small" type="button" data-proj-edit="${esc(pid)}">Edit</button>
            <button class="btn btn-line small" data-proj-delete>Delete</button>
              </div>
            </div>
          </summary>

          <div class="acc-body">
            <div class="tiny muted" style="margin-bottom:10px;">
              Update recipient status/notes here. To change recipients, edit the project and confirm sending again.
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
              ${rows.map(r => {
                const rid = esc(r.id);
                return `
                  <div class="card" style="padding:12px;">
                    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                      <div>
                        <div style="font-weight:850;">${esc(r.recipientName||'—')}</div>
                        <div class="muted">${esc(r.recipientEmail||'—')}${r.recipientOrg ? ' • ' + esc(r.recipientOrg) : ''}</div>
                        <div class="tiny muted" style="margin-top:6px;">Sent: ${esc(fmtDate(r.sentAt))} • Updated: ${esc(fmtDate(r.updatedAt || r.sentAt))}</div>
                      </div>

                      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                        <div class="field" style="margin:0;">
                          <label class="tiny muted" style="margin:0 0 4px;">Recipient status</label>
                          <select data-mon-status="${rid}" style="min-width:160px;">
                            ${statusOptions(r.status || 'Sent')}
                          </select>
                        </div>
                        <button class="btn small" type="button" data-mon-save="${rid}">Save</button>
                      </div>
                    </div>

                    <div class="field" style="margin-top:10px;">
                      <label class="tiny muted">Notes</label>
                      <input type="text" data-mon-notes="${rid}" value="${esc(r.notes||'')}" placeholder="Add a short note (optional)" />
                    </div>

                    <div class="actions" style="justify-content:flex-start; margin-top:10px;">
                      <button class="btn btn-line small" type="button" data-mon-history="${rid}">History</button>
                    </div>

                    <div data-mon-history-body="${rid}" style="display:none !important; margin-top:10px;">
                      ${(Array.isArray(r.history) && r.history.length) ? `
                        <div style="overflow:auto;">
                          <table style="width:100%; border-collapse:collapse;">
                            <thead>
                              <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(0,0,0,.08);">Date</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(0,0,0,.08);">Status</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(0,0,0,.08);">Notes</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${r.history.slice(0,12).map(h => `
                                <tr>
                                  <td style="padding:6px; border-bottom:1px solid rgba(0,0,0,.06); white-space:nowrap;">${esc(fmtDate(h.at))}</td>
                                  <td style="padding:6px; border-bottom:1px solid rgba(0,0,0,.06);">${esc(h.status||'')}</td>
                                  <td style="padding:6px; border-bottom:1px solid rgba(0,0,0,.06);">${esc(h.notes||'')}</td>
                                </tr>
                              `).join('')}
                            </tbody>
                          </table>
                        </div>
                      ` : `<div class="tiny muted">No history yet.</div>`}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </details>
      `;
    }).join('');

    // --- Handlers: project status update ---
    monitorList.querySelectorAll('[data-proj-status]').forEach(sel => {
      sel.addEventListener('change', async () => {
        const pid = sel.getAttribute('data-proj-status');
        const val = sel.value;
        const store2 = await loadStore();
        const p = store2.projects.find(x => x.id === pid);
        if(p){ p.status = val; p.updatedAt = nowISO(); }
        store2.monitoring.forEach(m => {
          if(m.projectId === pid){
            m.projectStatus = val;
            m.updatedAt = nowISO();
            if(!Array.isArray(m.history)) m.history = [];
            m.history.unshift({ at: nowISO(), status: `Project status → ${val}`, notes: '' });
          }
        });
        await saveStore(store2);
        showToast('Project updated', 'Project status saved.');
        await renderMonitoring();
      });
    });

    // --- Edit project shortcut ---
    monitorList.querySelectorAll('[data-proj-edit]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const pid = btn.getAttribute('data-proj-edit');
        await editProject(pid);
      });
    });

    // --- Save recipient status ---
    monitorList.querySelectorAll('[data-mon-save]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-mon-save');
        const statusSel = monitorList.querySelector(`[data-mon-status="${CSS.escape(id)}"]`);
        const notesEl = monitorList.querySelector(`[data-mon-notes="${CSS.escape(id)}"]`);
        const st = statusSel ? statusSel.value : 'Sent';
        const notes = notesEl ? notesEl.value : '';

        const store2 = await loadStore();
        const row = store2.monitoring.find(m => m.id === id);
        if(!row) return;
        row.status = st;
        row.notes = notes;
        row.updatedAt = nowISO();
        if(!Array.isArray(row.history)) row.history = [];
        row.history.unshift({ at: row.updatedAt, status: st, notes: notes || '' });
        await saveStore(store2);
        showToast('Saved', 'Monitoring entry updated.');
        await renderMonitoring();
      });
    });

    // --- Toggle history ---
    monitorList.querySelectorAll('[data-mon-history]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-mon-history');
        const body = monitorList.querySelector(`[data-mon-history-body="${CSS.escape(id)}"]`);
        if(!body) return;
        body.style.display = (body.style.display === 'none' || !body.style.display) ? 'block' : 'none';
      });
    });
  }

  monSearch?.addEventListener('input', () => renderMonitoring());
  monStatusFilter?.addEventListener('change', () => renderMonitoring());

  // ===== Boot =====
  renderRecipients();
  renderAttachments();
  setSaveMode();
  updateSummary();
  await refreshProjectSelects();
})();
</script>
<script defer="" src="assets/sponsors/sponsors.js"></script>
<div id="anwGateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:9999;">
<div style="background:#fff; border-radius:14px; padding:18px 18px; max-width:560px; width:92%; box-shadow:0 10px 30px rgba(0,0,0,0.25);">
<h3 style="margin:0 0 8px 0; font-size:1.15rem;">Access restricted</h3>
<p style="margin:0; line-height:1.35;">This page is restricted.</p>
<div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px; flex-wrap:wrap;">
<a class="btn btn-primary" href="login.html" id="anwGateLogin" style="display:none; text-decoration:none; padding:10px 12px; border-radius:10px;">Log in</a>
<a class="btn btn-ghost" href="login.html#signup" id="anwGateSignup" style="display:none; text-decoration:none; padding:10px 12px; border-radius:10px;">Register</a>
<button class="btn btn-ghost" id="anwGateClose" style="border:0; background:#eee; color:#111; padding:10px 12px; border-radius:10px; cursor:pointer;" type="button">Close</button>
</div>
</div>
</div>
<script>
/* Access control: Community Projects (EXCLUSIVE)
   Allowed: Project Volunteers, Build Project, Confirm sending, Monitoring, Admin Support, Owner
*/
(function(){
  const mainEl = document.getElementById('projectsMain');
  const gate = document.getElementById('anwGateModal');
  const gateLogin = document.getElementById('anwGateLogin');
  const gateSignup = document.getElementById('anwGateSignup');
  const gateClose = document.getElementById('anwGateClose');

  const showGate = (title, msg, mode) => {
    // Dashboard-style: keep page visible, show inline notice under header, do not open modal
    const n = document.getElementById('anwAccessNotice');
    if(n){
      n.style.display = 'block';
      n.innerHTML = String(msg || '')
        .replace(/log in/ig, '<a href="login.html">log in</a>')
        .replace(/register/ig, '<a href="login.html#signup">register</a>');
    }
    if(gate) gate.style.display = 'none';
  };

  const allowContent = () => {
    const n = document.getElementById('anwAccessNotice');
    if(n) n.style.display = 'none';
    if(gate) gate.style.display = 'none';
  };

  gateClose?.addEventListener('click', ()=>{ if(gate) gate.style.display='none'; });

  const normalize = (s)=> String(s||'').toLowerCase().replace(/[\s\-_]+/g,' ').replace(/[^a-z0-9 ]/g,'').trim();

  const extractRoles = (profile) => {
    const out = [];
    if(!profile) return out;
    const pushAny = (v)=>{ if(!v) return; if(Array.isArray(v)) v.forEach(pushAny); else out.push(String(v)); };
    pushAny(profile.role); pushAny(profile.roles); pushAny(profile.position); pushAny(profile.title); pushAny(profile.access);
    return out.map(normalize).filter(Boolean);
  };

  const hasAnyRole = (profile, allow) => {
    const mine = extractRoles(profile);
    const allowN = allow.map(normalize);
    return mine.some(r => allowN.some(a => r === a || r.includes(a) || a.includes(r)));
  };

  const ensureIdentityUser = async () => {
    if(!window.netlifyIdentity) return null;
    return await new Promise((resolve)=>{
      let done=false;
      const finish=(u)=>{ if(done) return; done=true; resolve(u||null); };
      try{
        window.netlifyIdentity.on('init', finish);
        window.netlifyIdentity.init();
      }catch(e){}
      setTimeout(()=>{
        try{
          const u = (typeof window.netlifyIdentity.currentUser === 'function') ? window.netlifyIdentity.currentUser() : null;
          finish(u);
        }catch(e){ finish(null); }
      }, 350);
    });
  };

  const getLoggedEmail = () => {
    try { if(window.anwGetLoggedEmail) return String(window.anwGetLoggedEmail()||''); } catch(e) {}
    try {
      const u = window.netlifyIdentity && window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();
      if(u && u.email) return String(u.email);
    } catch(e) {}
    return '';
  };

  const loadProfile = async () => {
    try { await window.anwInitStore?.(); } catch(e) {}
    try{
      const users = (window.anwLoad && window.ANW_KEYS) ? window.anwLoad(window.ANW_KEYS.USERS, []) : [];
      const email = getLoggedEmail();
      const norm = (e)=> String(e||'').trim().toLowerCase();
      return Array.isArray(users) ? (users.find(u=> norm(u.email) === norm(email)) || null) : null;
    }catch(e){ return null; }
  };

  (async ()=>{
    // hide by default until authorized
    if(mainEl){
      mainEl
      mainEl
      if(!mainEl.style.minHeight) mainEl.style.minHeight = '60vh';
    }

    if(window.ANW_PUBLIC_MODE){
      allowContent();
      return;
    }

    const user = await ensureIdentityUser();
    if(!user){
      showGate('Login required', 'This is an . Please log in or register to continue.', 'login+signup');
      return;
    }

    const profile = await loadProfile();
    if(!profile){
      showGate('Approval required', 'Your account is logged in, but you are not registered/approved yet. Please wait for approval.', 'none');
      return;
    }

    const status = String(profile.status || profile.accountStatus || '').toLowerCase();
    const approved = (profile.approved === true) || (profile.active === true) || status === 'active' || status === 'approved';
    if(!approved){
      showGate('Approval required', 'Your account is not approved yet. Please wait for approval to access Community Projects.', 'none');
      return;
    }

    const allowedRoles = [
      'project volunteers','project volunteer','volunteer',
      'build project',
      'confirm sending',
      'monitoring',
      'admin support',
      'support administrator','support admin',
      'owner'
    ];
    if(!hasAnyRole(profile, allowedRoles)){
      showGate('Access restricted', 'This is an  available only to authorised project roles.', 'none');
      return;
    }

    allowContent();
  })();
})();
</script>
<script>
// --- Community Projects tabs + ACL gating (tabs visible; blocked tabs show notice and do not open) ---
document.addEventListener('DOMContentLoaded', async () => {
  const notice = document.getElementById('anwAccessNotice');
  const showNotice = (html) => {
    if (!notice) return;
    notice.style.display = 'block';
    notice.innerHTML = html;
  };
  const hideNotice = () => { if (notice) notice.style.display = 'none'; };

  // Scope ONLY to Projects sub-tabs (do not touch main NAV)
  const tabButtons = Array.from(document.querySelectorAll('button.proj-tab'));
  const panesById = {
    builder: document.getElementById('paneBuilder'),
    send: document.getElementById('paneSend'),
    monitoring: document.getElementById('paneMonitoring'),
  };

  // Ensure buttons have stable keys
  const norm = (s) => String(s||'').toLowerCase().trim();
  const inferTabKey = (btn) => {
    const t = norm(btn.textContent);
    if (t.includes('build')) return 'builder';
    if (t.includes('confirm')) return 'send';
    if (t.includes('monitor')) return 'monitoring';
    return btn.getAttribute('data-tab-key') || 'builder';
  };

  // Map each sub-tab to an ACL feature key (must match Admin)
  const featureFor = (tabKey) => ({
    builder: 'projects:tab_builder',
    send: 'projects:tab_published',
    monitoring: 'projects:tab_monitoring',
  }[tabKey] || 'projects:tab_builder');

  // Read ACL (store-backed on Netlify; fallback to default in app-core)
  const getAclSync = () => {
    try { return (window.anwGetAclSync && window.anwGetAclSync()) || null; } catch (e) { return null; }
  };
  const getDefaultAcl = () => {
    try { return window.ANW_ACL_DEFAULT || null; } catch (e) { return null; }
  };

  const normalize = (s) => String(s||'').toLowerCase().replace(/[\s\-_]+/g,' ').replace(/[^a-z0-9 ]/g,'').trim();
  const extractRoles = (profile) => {
    const out = [];
    const pushAny = (v)=>{ if(!v) return; if(Array.isArray(v)) v.forEach(pushAny); else out.push(String(v)); };
    pushAny(profile?.role); pushAny(profile?.roles); pushAny(profile?.position); pushAny(profile?.title); pushAny(profile?.access);
    return out.map(normalize).filter(Boolean);
  };
  const hasAnyRole = (profile, allowed) => {
    const mine = extractRoles(profile);
    const allow = (allowed||[]).map(normalize);
    if (allow.includes('public')) return true;
    return mine.some(r => allow.some(a => r===a || r.includes(a) || a.includes(r)));
  };

  const ensureUser = async () => {
    if(!window.netlifyIdentity) return null;
    return await new Promise((resolve)=>{
      let done=false;
      const finish=(u)=>{ if(done) return; done=true; resolve(u||null); };
      try { window.netlifyIdentity.on('init', (u)=>finish(u)); window.netlifyIdentity.init(); } catch(e) {}
      setTimeout(()=>{
        try { finish(window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser()); }
        catch(e){ finish(null); }
      }, 300);
    });
  };

  const getProfile = async (user) => {
    try { await window.anwInitStore?.(); } catch(e) {}
    try {
      const users = (window.anwLoad && window.ANW_KEYS) ? window.anwLoad(window.ANW_KEYS.USERS, []) : [];
      const email = String(user?.email||'').toLowerCase();
      return (users||[]).find(u => String(u.email||'').toLowerCase() === email) || null;
    } catch(e){ return null; }
  };

  // In local file:// preview there is no Identity/Functions; keep tabs visible but DO NOT open protected panes.
  // This matches the behaviour on Report (tabs shown, content gated) and prevents false positives in local testing.
  const isFile = (location && location.protocol === 'file:');
  const localPreviewAcl = {
    'projects:tab_builder': [],
    'projects:tab_published': [],
    'projects:tab_monitoring': [],
  };

  const user = isFile ? null : await ensureUser();
  const profile = user ? await getProfile(user) : null;

  const canOpen = (tabKey) => {
    if (window.ANW_PUBLIC_MODE) return true;
    const acl = isFile ? localPreviewAcl : (getAclSync() || getDefaultAcl() || {});
    const feature = featureFor(tabKey);
    const allowed = acl[feature] || [];
    // Not logged in: only "public" allowed
    if (!user && !isFile) return Array.isArray(allowed) && allowed.map(normalize).includes('public');
    // file://: keep panes closed (localPreviewAcl above)
    if (isFile) return Array.isArray(allowed) && allowed.map(normalize).includes('public');
    return hasAnyRole(profile, allowed);
  };

  const setActive = (tabKey) => {
    tabButtons.forEach(b => {
      const k = inferTabKey(b);
      const isActive = (k === tabKey);
      b.classList.toggle('active', isActive);
      b.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    Object.entries(panesById).forEach(([k,pane]) => {
      if (!pane) return;
      pane.style.display = (k === tabKey) ? '' : 'none';
    });

    // Optional breadcrumb/label (creates if missing)
    let label = document.getElementById('projSubtabLabel');
    if (!label) {
      const h = document.querySelector('h1, .page-title, h2');
      if (h) {
        label = document.createElement('div');
        label.id = 'projSubtabLabel';
        label.style.marginTop = '6px';
        label.style.fontSize = '14px';
        label.style.opacity = '0.8';
        h.insertAdjacentElement('afterend', label);
      }
    }
    if (label) {
      const txt = ({builder:'Build project', send:'Confirm sending', monitoring:'Monitoring'}[tabKey] || 'Build project');
      label.textContent = 'Community Projects › ' + txt;
    }
  };

  // Initial state: keep whatever is marked active; otherwise builder
  let initial = 'builder';
  const marked = tabButtons.find(b => b.classList.contains('active') || b.getAttribute('aria-selected') === 'true');
  if (marked) initial = inferTabKey(marked);
  setActive(initial);

  // If the initial tab is not allowed, keep tabs visible but hide all panes + show notice
  if (!canOpen(initial)) {
    Object.values(panesById).forEach(p => { if(p) p.style.display='none'; });
    showNotice('Exclusive area. Please <a href="login.html">log in</a> to continue.');
  }


  tabButtons.forEach(btn => {
    btn.addEventListener('click', (ev) => {
      const tabKey = inferTabKey(btn);
      if (!canOpen(tabKey)) {
        ev.preventDefault();
        ev.stopPropagation();
        // Keep current tab, just show notice
        showNotice('Exclusive area. Please <a href="login.html">log in</a> to continue.');
        return;
      }
      hideNotice();
      setActive(tabKey);
    });
  });
});
</script>
<script src="assets/acl-guard.js"></script>
</body>
</html>
