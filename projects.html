<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .proj-tabs{display:flex;gap:.5rem;flex-wrap:nowrap;align-items:center;justify-content:flex-start}
    @media (max-width:720px){.proj-tabs{flex-wrap:wrap;justify-content:flex-start}}
    .proj-pane{display:none}
    .proj-pane.active{display:block}

    .proj-accordion{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden;margin-bottom:14px}
    .proj-acc-head{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:800}
    .proj-acc-head:hover{background:rgba(0,0,0,.02)}
    .proj-acc-body{border-top:1px solid var(--line);padding:14px 16px;display:none}
    .proj-accordion.open .proj-acc-body{display:block}
    .proj-chevron{transition:transform .18s ease}
    .proj-accordion.open .proj-chevron{transform:rotate(180deg)}

    textarea.auto-grow{width:100%;box-sizing:border-box;resize:none;overflow:hidden;min-height:84px;line-height:1.55}

    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media (max-width:900px){.grid-3{grid-template-columns:1fr}}

    .attach-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .attach-item{border:1px solid var(--line);border-radius:14px;background:#fff;padding:10px 12px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .attach-name{font-weight:700;cursor:text}
    .attach-meta{color:var(--muted);font-size:12px}

    .mon-list{display:flex;flex-direction:column;gap:14px}
    .mon-card{border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.04);padding:16px}
    .mon-top{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .mon-title{font-weight:900;font-size:16px;margin:0 0 4px}
    .mon-sub{color:var(--muted);font-size:13px;margin:0}
    .mon-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mon-pill{display:inline-flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#f7faf8}
    .mon-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width:640px){.mon-meta{grid-template-columns:1fr}}
    .mon-k{font-size:12px;color:var(--muted);margin-bottom:4px}
    .mon-v{font-weight:700}
    .mon-notes{margin-top:12px}
    .mon-notes textarea{width:100%;min-height:96px;resize:none;box-sizing:border-box}
    .mon-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:10px;flex-wrap:wrap}

    .toast-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:10px;max-width:min(420px, calc(100vw - 36px))}
    .toast{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:12px;display:flex;gap:10px;align-items:flex-start}
    .toast .dot{width:10px;height:10px;border-radius:50%;margin-top:6px;background:var(--brand)}
    .toast .msg{font-size:14px;line-height:1.35;color:var(--text)}
    .toast .sub{display:block;margin-top:2px;font-size:12px;color:var(--muted)}
    .toast .actions{margin-left:auto;display:flex;gap:8px}
    .toast.hide{opacity:0;transform:translateY(6px);transition:opacity .18s ease, transform .18s ease}
  </style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <div class="logo">ANW</div>
    <div class="brand-text">
      <h1>Aderrig Neighbourhood Watch</h1>
      <p class="muted">Adamstown · Community-led · Ireland</p>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="report.html">Report</a>
    <a href="alerts.html">Community Alerts</a>
    <a href="projects.html" class="active">Community Projects</a>
    <a href="login.html">Login / Register</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="household.html">Household</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main class="wrap">

  <div class="actions proj-tabs" style="justify-content:flex-start;">
    <button class="btn btn-line small proj-tab" type="button" data-target="paneBuilder">Project builder</button>
    <button class="btn btn-line small proj-tab" type="button" data-target="panePublished">Published projects</button>
    <button class="btn btn-line small proj-tab" type="button" data-target="paneMonitoring">Monitoring</button>
  </div>

  <section id="paneBuilder" class="proj-pane active">
    <h2>Project builder</h2>

    <div class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end">
      <div class="field" style="max-width:640px;">
        <label>Select a project</label>
        <select id="projectSelect">
          <option value="">— Select —</option>
          <option value="__new__">+ New project</option>
          <option value="project1">AED & Responders (Aderrig/Adamstown)</option>
          <option value="project2">Smart Safety & CCTV (Aderrig/Adamstown)</option>
        </select>
      </div>

      <div class="field" style="max-width:420px;">
        <label>Category</label>
        <select id="projectCategory">
          <option value="" selected>—</option>
<option>Safety &amp; Security</option>
          <option>Lighting &amp; Infrastructure</option>
          <option>Community Engagement</option>
          <option>Environment &amp; Clean-up</option>
          <option>Traffic &amp; Parking</option>
          <option>Youth &amp; Anti-social Behaviour</option>
          <option>Other</option>
        </select>
      </div>

      <div class="field" style="max-width:420px;">
        <label>Status</label>
        <select id="projectStatus">
          <option value="" selected>—</option>
<option value="draft">Draft</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="completed">Completed</option>
        </select>
      </div>

      <div class="field" style="max-width:260px;">
        <label>Project number</label>
        <input id="projectNumber" class="input" type="text" readonly placeholder="" style="width:100%;">
      </div>
    </div>
<div class="field">
      <label>Project title</label>
      <input id="projectTitle" type="text" placeholder="Enter a clear project title" />
    </div>

    <div class="proj-accordion open">
      <div class="proj-acc-head" data-acc>Executive Summary <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="executive" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Background and Context <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="background" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Programme Design and Approach <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="design" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Technical Overview <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="technical" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Governance and Oversight <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="governance" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Implementation Plan <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="implementation" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Community Engagement <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="engagement" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>KPIs and Evaluation <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="kpis" class="auto-grow"></textarea></div>
    </div>

    <div class="proj-accordion">
      <div class="proj-acc-head" data-acc>Annexes / References <span class="proj-chevron">▾</span></div>
      <div class="proj-acc-body"><textarea id="annexes" class="auto-grow"></textarea></div>
    </div>

    <h3>Attachments</h3>
    <div class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <input id="fileInput" type="file" multiple style="display:none" />
      <button class="btn btn-line small" id="btnAddAttach" type="button">Add attachments</button>
    </div>
    <div id="attachList" class="attach-list"></div>

    <h3>Recipients</h3>
    <p class="muted" style="margin-top:-6px;">Add the person or organisation you will send this project to. Monitoring will track status and dates per recipient.</p>

    <div class="grid-3">
      <div class="field"><label>Name</label><input id="recName" type="text" placeholder="Full name" /></div>
      <div class="field"><label>Email</label><input id="recEmail" type="email" placeholder="name@email.com" /></div>
      <div class="field"><label>Organisation</label><input id="recOrg" type="text" placeholder="Organisation" /></div>
    </div>

    <div id="recipientList" style="margin-top:12px;"></div>

    <div class="actions" style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap;">
      <button class="btn btn-line small" id="btnAddRecipient" type="button">Add recipient</button>
      <button class="btn small" id="btnSaveProject" type="button">Save project</button>
    </div>

  </section>

  <section id="panePublished" class="proj-pane">
    <h2>Published projects</h2>
    <div id="publishedList"></div>
  </section>

  <section id="paneMonitoring" class="proj-pane">
    <h2>Monitoring</h2>
    <div id="monitorList"></div>
  </section>
</main>

<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>
<script type="application/json" id="templates-json">{"project1": {"title": "AED & Responders (Aderrig/Adamstown)", "category": "Safety & Security", "sections": {"executive": "This programme proposes a community-led Automated External Defibrillator (AED) and First Responder network to strengthen emergency readiness across Aderrig & Adamstown. It combines accessible AED placement, volunteer training, and a clear governance model to improve response outcomes while working in alignment with HSE guidance and local stakeholders.", "background": "Aderrig & Adamstown are growing residential areas with increasing population density and a strong need for community resilience. In time-critical cardiac events, early defibrillation and CPR significantly improve survival outcomes. Establishing locally accessible AEDs and trained volunteers supports faster intervention while emergency services are en route.", "design": "The programme is designed around: (1) mapped AED locations with 24/7 access where feasible, (2) volunteer recruitment and accredited training (CPR/AED), (3) an escalation protocol and communications pathway, and (4) ongoing equipment maintenance and refresher training.", "technical": "AED units will be CE-marked medical devices, installed in appropriate cabinets with signage and location mapping. Maintenance includes regular checks, battery/pad replacement schedules, and a register of devices and trained responders.", "governance": "A steering group will oversee delivery, including community representatives and nominated liaisons (as appropriate) with relevant services. Governance covers procurement, placement approvals, maintenance responsibilities, training records and incident reporting.", "implementation": "Phase 1: needs assessment and mapping; Phase 2: procurement and installation; Phase 3: training cohorts and launch; Phase 4: operational stabilisation and review. A milestone plan with owners, timelines and budget tracking will be used.", "engagement": "Engagement will include resident briefings, volunteer sign-ups, training promotions, and clear guidance on how and when to use AEDs. Partnerships with local groups will support recruitment and awareness.", "kpis": "KPIs include number of trained responders, AED coverage density, training completion rates, device uptime, maintenance compliance, community awareness reach, and post-incident review completeness (where applicable).", "annexes": "Annexes may include location maps, training plan, device specifications, maintenance checklist, communications plan, and governance terms of reference."}}, "project2": {"title": "Smart Safety & CCTV (Aderrig/Adamstown)", "category": "Safety & Security", "sections": {"executive": "This programme sets out a structured, community-governed approach to improving neighbourhood safety using responsible environmental design and, where justified, GDPR-compliant CCTV. It prioritises prevention, clear governance, and transparent community communication, with monitoring focused on measurable outcomes and resident confidence.", "background": "As communities grow, issues such as anti-social behaviour, vandalism and opportunistic crime can increase in specific hotspots. A combined approach—improved lighting and environmental design alongside proportionate, compliant surveillance—can deter incidents and support effective reporting and follow-up.", "design": "The approach uses a risk-based map of locations, prioritising prevention measures first (lighting, sightlines, signage, reporting channels). CCTV is considered only where there is a clear, documented need and a lawful basis.", "technical": "Any CCTV deployment must be GDPR-compliant, with a documented lawful basis, DPIA where required, clear signage, retention controls, secure storage, and controlled access logs. Camera placement will avoid private areas and minimise intrusion.", "governance": "Governance will define the data controller role, access permissions, request handling, incident escalation, audit procedures, retention and disclosure. Policies will cover breach response and periodic review.", "implementation": "Phase 1: hotspot assessment and prevention measures; Phase 2: governance pack (policies, DPIA, signage plan); Phase 3: procurement and installation; Phase 4: operational go-live and review.", "engagement": "Residents will be informed throughout via updates and consultation. Clear guidance will be provided on reporting routes, how footage requests are handled, and how privacy is protected.", "kpis": "KPIs include incident reduction in hotspots, response/reporting metrics, lighting fault resolution times, community sentiment indicators, and compliance metrics (access logs, retention adherence, review completion).", "annexes": "Annexes may include hotspot map summary, CCTV policy pack, DPIA summary, signage plan, vendor specs, and operating procedures."}}}</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function showToast(message, detail) {
    const wrap = document.getElementById('toastWrap');
    if(!wrap) return;
    const t = document.createElement('div');
    t.className = 'toast';
    const dot = document.createElement('div'); dot.className='dot';
    const body = document.createElement('div'); body.className='msg'; body.textContent = message;
    if(detail) {
      const s = document.createElement('span'); s.className='sub'; s.textContent=detail;
      body.appendChild(s);
    }
    const actions = document.createElement('div'); actions.className='actions';
    const close = document.createElement('button');
    close.type='button'; close.className='btn btn-line small'; close.textContent='Close';
    close.addEventListener('click', () => dismissToast(t));
    actions.appendChild(close);
    t.appendChild(dot); t.appendChild(body); t.appendChild(actions);
    wrap.appendChild(t);
    const to = window.setTimeout(() => dismissToast(t), 4200);
    t.dataset.to = String(to);
  }
  function dismissToast(el) {
    if(!el) return;
    const to = el.dataset.to;
    if(to) window.clearTimeout(Number(to));
    el.classList.add('hide');
    window.setTimeout(() => el.remove(), 220);
  }

  const panes = Array.from(document.querySelectorAll('.proj-pane'));
  const tabs = Array.from(document.querySelectorAll('.proj-tab'));
  function setPane(id) {
    panes.forEach(p => p.classList.toggle('active', p.id === id));

    // When opening Monitoring, start collapsed/clean
    if(id === 'paneMonitoring') {
      projectDetailsOpen = {};
      recipientHistoryOpen = {};
      renderMonitoring();
    }

    // When opening Builder, keep the header synced
    if(id === 'paneBuilder') {
      setSaveMode();
    }
  }
  tabs.forEach(b => b.addEventListener('click', () => setPane(b.dataset.target)));

  document.addEventListener('click', (e) => {
    const head = e.target.closest('[data-acc]');
    if(!head) return;
    const sec = head.closest('.proj-accordion');
    if(sec) sec.classList.toggle('open');
  });

  const STORE_KEY = 'anw_store_v1';
  const DEFAULT_STORE = { version: 1, projects: [], monitoring: [] };
  function nowISO() { return new Date().toISOString(); }

  function shortTitle(title) {
    const t = (title || '').toString().trim();
    if(!t) return 'Untitled';
    // Remove long bracketed suffixes for UI, e.g. "Something (Location/Other)" -> "Something"
    const noParen = t.replace(/\s*\([^)]*\)\s*$/, '').trim();
    const s = noParen || t;
    return s.length > 42 ? (s.slice(0, 39) + '…') : s;
  }

  function isValidEmail(email) {
    const e = (email || '').trim();
    // Practical email validation: local@domain.tld (tld 2-24 letters)
    // NOTE: this checks format only (it cannot guarantee the mailbox/domain exists).
    if(!e) return false;
    const re = /^[^\s@]+@([A-Za-z0-9-]+\.)+[A-Za-z]{2,24}$/;
    return re.test(e);
  }

  function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch(_) { return iso || '—'; } }
  async function loadStore() {
    const s = await anwFetchKey(STORE_KEY, DEFAULT_STORE);
    return {
      ...JSON.parse(JSON.stringify(DEFAULT_STORE)),
      ...s,
      projects: Array.isArray(s?.projects) ? s.projects : [],
      monitoring: Array.isArray(s?.monitoring) ? s.monitoring : []
    };
  }
  async function saveStore(obj) {
    return await anwSave(STORE_KEY, obj);
  }

  const TEMPLATES = JSON.parse(document.getElementById('templates-json').textContent || '{}');

  const projectSelect = document.getElementById('projectSelect');
  const projectTitle = document.getElementById('projectTitle');
  projectTitle.addEventListener('input', syncSelectFromProjectTitle);

  const projectNumber = document.getElementById('projectNumber');
  const projectCategory = document.getElementById('projectCategory');
  const projectStatus = document.getElementById('projectStatus');

  const executive = document.getElementById('executive');
  const background = document.getElementById('background');
  const design = document.getElementById('design');
  const technical = document.getElementById('technical');
  const governance = document.getElementById('governance');
  const implementation = document.getElementById('implementation');
  const engagement = document.getElementById('engagement');
  const kpis = document.getElementById('kpis');
  const annexes = document.getElementById('annexes');

  const textareas = [executive, background, design, technical, governance, implementation, engagement, kpis, annexes];
  function autosize(el) {
    if(!el) return;
    el.style.height = 'auto';
    const max = 560;
    const h = Math.min(el.scrollHeight + 2, max);
    el.style.height = h + 'px';
    el.style.overflow = (el.scrollHeight + 2 > max) ? 'auto' : 'hidden';
  }
  
  function setAllSections(open) {
    document.querySelectorAll('.section details').forEach(d => {
      if(open) d.setAttribute('open', 'open');
      else d.removeAttribute('open');
    });
  }

function autosizeAll() { textareas.forEach(t => autosize(t)); }
  textareas.forEach(t => t && t.addEventListener('input', () => autosize(t)));

  const recName = document.getElementById('recName');
  const recEmail = document.getElementById('recEmail');
  const recOrg = document.getElementById('recOrg');
  const btnAddRecipient = document.getElementById('btnAddRecipient');
  const btnSaveProject = document.getElementById('btnSaveProject');
  const recipientList = document.getElementById('recipientList');

  const fileInput = document.getElementById('fileInput');
  const btnAddAttach = document.getElementById('btnAddAttach');
  const attachList = document.getElementById('attachList');

  const publishedList = document.getElementById('publishedList');
  const monitorList = document.getElementById('monitorList');
  // UI state (kept in-memory only)
  const monitoringOpen = {}; // projectId -> boolean
  const recipientHistoryOpen = {}; // monitoringId -> boolean


  let currentRecipients = [];
  let currentAttachments = [];
  let editingProjectId = null;
  let editingProjectNo = null;
  let editingProjectCreatedAt = null;

  function setSaveMode() {
    btnSaveProject.textContent = editingProjectId ? 'Update project' : 'Save project';

    const hasSelection = !!(projectSelect && projectSelect.value);
    const hasStarted = !!(
      (projectTitle && projectTitle.value.trim()) ||
      (currentRecipients && currentRecipients.length) ||
      (currentAttachments && currentAttachments.length)
    );

    // Only show/generate a project number when a project is selected OR the user started a new one.
    if(projectNumber) {
      if(editingProjectNo) {
        projectNumber.value = editingProjectNo;
      } else if(hasSelection || hasStarted) {
        if(!window.__draftProjectNo) window.__draftProjectNo = ('PRJ-' + Date.now().toString());
        projectNumber.value = window.__draftProjectNo;
      } else {
        window.__draftProjectNo = null;
        projectNumber.value = '';
      }
    }
  }

  function resetBuilderForm() {
    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    window.__draftProjectNo = null;

    if(projectNumber) projectNumber.value = '';
    projectTitle.value = '';
    // set selects to blank placeholder
    projectCategory.value = '';
    projectStatus.value = '';

    // clear textareas/sections
    setAllSections(false);

    executive.value = '';
    background.value = '';
    design.value = '';
    technical.value = '';
    governance.value = '';
    implementation.value = '';
    engagement.value = '';
    kpis.value = '';
    annexes.value = '';

    // recipients & attachments
    currentRecipients = [];
    currentAttachments = [];
    renderRecipients();
    renderAttachments();
  }

  function renderRecipients() {
    if(!currentRecipients.length) {
      recipientList.innerHTML = '<div class="card" style="padding:12px;"><span class="muted">No recipients added yet.</span></div>';
      return;
    }
    recipientList.innerHTML = currentRecipients.map((r, idx) => `
      <div class="card" style="padding:12px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <div>
          <div style="font-weight:800;">${r.name}</div>
          <div class="muted">${r.email} • ${r.org || ''}</div>
        </div>
        <button class="btn btn-line small" type="button" data-rec-del="${idx}">Remove</button>
      </div>
    `).join('');
    recipientList.querySelectorAll('[data-rec-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const i = Number(btn.getAttribute('data-rec-del'));
        currentRecipients.splice(i, 1);
        renderRecipients();
      });
    });
  }

  btnAddRecipient.addEventListener('click', () => {
    const name = recName.value.trim();
    const email = recEmail.value.trim();
    const org = recOrg.value.trim();
    if(!name || !email) {
      showToast('Missing information', 'Please provide at least Name and Email for the recipient.');
      return;
    }
    if(!isValidEmail(email)) {
      showToast('Invalid email', 'Please enter a valid email address.');
      return;
    }
    currentRecipients.push({ name, email, org });
    recName.value = ''; recEmail.value = ''; recOrg.value = '';
    renderRecipients();
  });

  function humanSize(bytes) {
    const units = ['B','KB','MB','GB'];
    let i=0, n=bytes||0;
    while(n >= 1024 && i < units.length-1) { n/=1024; i++; }
    return `${n.toFixed(i?1:0)} ${units[i]}`;
  }
  function extOf(name) {
    const m = /(\.[A-Za-z0-9]+)$/.exec(name || '');
    return m ? m[1] : '';
  }
  function renderAttachments() {
    if(!currentAttachments.length) {
      attachList.innerHTML = '<div class="card" style="padding:12px;"><span class="muted">No attachments yet.</span></div>';
      return;
    }
    attachList.innerHTML = currentAttachments.map((a, idx) => {
      const meta = [a.type || 'file', humanSize(a.size)].filter(Boolean).join(' • ');
      return `
        <div class="attach-item">
          <div>
            <div class="attach-name" data-att-name="${idx}" title="Double-click to rename">${a.name}</div>
            <div class="attach-meta">${meta}</div>
          </div>
          <button class="btn btn-line small" type="button" data-att-del="${idx}">Remove</button>
        </div>
      `;
    }).join('');

    attachList.querySelectorAll('[data-att-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const i = Number(btn.getAttribute('data-att-del'));
        currentAttachments.splice(i, 1);
        renderAttachments();
      });
    });

    attachList.querySelectorAll('[data-att-name]').forEach(el => {
      el.addEventListener('dblclick', () => {
        const i = Number(el.getAttribute('data-att-name'));
        const item = currentAttachments[i];
        if(!item) return;
        const oldName = item.name;
        const oldExt = extOf(oldName);
        const base = oldExt ? oldName.slice(0, -oldExt.length) : oldName;

        const input = document.createElement('input');
        input.className = 'input';
        input.type = 'text';
        input.value = base;
        input.style.maxWidth = '520px';

        el.replaceWith(input);
        input.focus();
        input.select();

        const finish = () => {
          let newBase = input.value.trim();
          if(!newBase) newBase = base || 'attachment';
          item.name = newBase + oldExt;
          renderAttachments();
        };
        input.addEventListener('keydown', (e) => {
          if(e.key === 'Enter') finish();
          if(e.key === 'Escape') finish();
        });
        input.addEventListener('blur', finish);
      });
    });
  }

  btnAddAttach.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    const files = Array.from(fileInput.files || []);
    files.forEach(f => currentAttachments.push({ name: f.name, type: f.type || '', size: f.size || 0 }));
    fileInput.value = '';
    renderAttachments();
    if(files.length) showToast('Attachments added', `${files.length} file(s) added.`);
  });

  
  function syncProjectTitleFromSelect() {
    if(!projectSelect || !projectTitle) return;
    const opt = projectSelect.options[projectSelect.selectedIndex];
    if(opt && opt.value) {
      projectTitle.value = opt.textContent.trim();
    }
  }

  function syncSelectFromProjectTitle() {
    if(!projectSelect || !projectTitle) return;
    const opt = projectSelect.options[projectSelect.selectedIndex];
    if(opt && opt.value) {
      opt.textContent = projectTitle.value.trim() || opt.textContent;
    }
  }

function fillFromTemplate(key) {
    const tpl = TEMPLATES[key];
    if(!tpl) return;
    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    // Selecting a template starts a new draft project
    window.__draftProjectNo = ('PRJ-' + Date.now().toString());
    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    if(projectNumber) projectNumber.value = window.__draftProjectNo;
    projectTitle.value = tpl.title || '';
    projectCategory.value = tpl.category || 'Other';
    projectStatus.value = 'draft';

    executive.value = tpl.sections?.executive || '';
    background.value = tpl.sections?.background || '';
    design.value = tpl.sections?.design || '';
    technical.value = tpl.sections?.technical || '';
    governance.value = tpl.sections?.governance || '';
    implementation.value = tpl.sections?.implementation || '';
    engagement.value = tpl.sections?.engagement || '';
    kpis.value = tpl.sections?.kpis || '';
    annexes.value = tpl.sections?.annexes || '';

    currentRecipients = [];
    currentAttachments = [];
    renderRecipients();
    renderAttachments();
    // Show the loaded content clearly
    setAllSections(false);
    const first = document.querySelector('#secExecutive details');
    if(first) first.setAttribute('open','open');
    autosizeAll();
    const anchor = document.getElementById('projectTitle');
    if(anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    setSaveMode();
    showToast('Project loaded', 'Template filled in the builder.');
  }

  projectSelect.addEventListener('change', () => {
    const key = (projectSelect.value || '').trim();

    // Blank selection = keep everything empty
    if(!key) {
      resetBuilderForm();
      return;
    }

    // New project shortcut
    if(key === '__new__') {
      resetBuilderForm();
      // default choices for a new project
      projectCategory.value = 'Other';
      projectStatus.value = 'draft';
      // generate draft number immediately (user explicitly started a new project)
      if(!window.__draftProjectNo) window.__draftProjectNo = ('PRJ-' + Date.now().toString());
      if(projectNumber) projectNumber.value = window.__draftProjectNo;
      setSaveMode();
      projectTitle.focus();
      showToast('New project', 'Fill in the details and click Save project.');
      return;
    }

    if(!TEMPLATES[key]) {
      showToast('Not found', 'Template key not found.');
      return;
    }

    fillFromTemplate(key);
    syncProjectTitleFromSelect();
  });

  function buildProjectPayload() {
    const id = editingProjectId || ('prj_' + Math.random().toString(36).slice(2,10));
    const projectNo = editingProjectNo || (projectNumber?.value || window.__draftProjectNo || ('PRJ-' + Date.now().toString()));
    const createdAt = editingProjectCreatedAt || nowISO();
    return {
      id,
      projectNo,
      title: projectTitle.value.trim(),
      category: projectCategory.value,
      status: projectStatus.value,
      createdBy: getCreatorEmail(),
      createdAt,
      updatedAt: nowISO(),
      sections: {
        executive: executive.value.trim(),
        background: background.value.trim(),
        design: design.value.trim(),
        technical: technical.value.trim(),
        governance: governance.value.trim(),
        implementation: implementation.value.trim(),
        engagement: engagement.value.trim(),
        kpis: kpis.value.trim(),
        annexes: annexes.value.trim()
      },
      recipients: JSON.parse(JSON.stringify(currentRecipients)),
      attachments: JSON.parse(JSON.stringify(currentAttachments))
    };
  }

  function resetBuilderForm() {
    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    window.__draftProjectNo = null;

    if(projectNumber) projectNumber.value = '';
    projectSelect.value = '';
    projectTitle.value = '';
    projectCategory.value = 'Other';
    projectStatus.value = 'draft';

    executive.value = '';
    background.value = '';
    design.value = '';
    technical.value = '';
    governance.value = '';
    implementation.value = '';
    engagement.value = '';
    kpis.value = '';
    annexes.value = '';

    currentRecipients = [];
    currentAttachments = [];
    recName.value = ''; recEmail.value = ''; recOrg.value = '';
    renderRecipients();
    renderAttachments();
    // Show the loaded content clearly
    setAllSections(false);
    const first = document.querySelector('#secExecutive details');
    if(first) first.setAttribute('open','open');
    autosizeAll();
    const anchor = document.getElementById('projectTitle');
    if(anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    showToast('Project loaded', 'Template filled in the builder.');
    setSaveMode();
  }


  btnSaveProject.addEventListener('click', () => {
    const title = projectTitle.value.trim();
    if(!title) {
      showToast('Missing information', 'Please enter a project title.');
      return;
    }

    let store = await loadStore();
    const data = buildProjectPayload();

    // Keep Project Number visible so editing the same project never creates a duplicate
    if(projectNumber) projectNumber.value = data.projectNo || '';

    // Upsert logic: ALWAYS update the same project if we can match it
    const norm = (v) => (v || '').toString().trim().toLowerCase();
    const keyTitle = norm(data.title);
    const keyCat = norm(data.category);

    // 1) edit mode (strongest)
    let idx = editingProjectId ? store.projects.findIndex(p => p.id === editingProjectId) : -1;

    // 2) match by Project Number (if user saved as draft then changes status later)
    if(idx < 0 && data.projectNo) {
      idx = store.projects.findIndex(p => (p.projectNo || p.project_no || p.projectNumber) === data.projectNo);
    }

    // 3) match by same title+category (fallback to prevent duplicates like draft->active)
    if(idx < 0 && keyTitle) {
      idx = store.projects.findIndex(p => norm(p.title) === keyTitle && norm(p.category) === keyCat);
    }

    if(idx >= 0) {
      const existing = store.projects[idx];
      data.id = existing.id;
      data.projectNo = existing.projectNo || existing.project_no || existing.projectNumber || data.projectNo;
      data.createdAt = existing.createdAt || data.createdAt;
      data.createdBy = existing.createdBy || data.createdBy;
      data.updatedAt = nowISO();
      store.projects[idx] = data;
    } else {
      store.projects.unshift(data);
    }

    // Final safety: if there are duplicates (same title+category), keep only ONE (prefer non-draft)
    const byKey = {};
    const keep = [];
    store.projects.forEach(p => {
      const k = norm(p.title) + '|' + norm(p.category);
      if(!byKey[k]) {
        byKey[k] = p;
        keep.push(p);
        return;
      }
      const cur = byKey[k];
      const pIsBetter = (norm(p.status) !== 'draft' && norm(cur.status) === 'draft') ||
                        ((p.updatedAt || p.createdAt || '') > (cur.updatedAt || cur.createdAt || ''));
      if(pIsBetter) {
        const pos = keep.findIndex(x => x.id === cur.id);
        if(pos >= 0) keep[pos] = p;
        byKey[k] = p;
      }
    });
    store.projects = keep;

    await saveStore(store);

    showToast(idx >= 0 ? 'Project updated' : 'Project saved', idx >= 0 ? 'Saved without duplicates.' : 'Added to Published projects.');

    editingProjectId = null;
    editingProjectNo = null;
    editingProjectCreatedAt = null;
    setSaveMode();

    renderPublished();
    renderMonitoring();
    resetBuilderForm();
    setPane('panePublished');
  });

  function renderPublished() {
    let store = await loadStore();
    if(!store.projects.length) {
      publishedList.innerHTML = '<div class="card" style="padding:14px;"><span class="muted">No projects saved yet.</span></div>';
      return;
    }
    publishedList.innerHTML = store.projects.map(p => `
      <div class="card" style="padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:900;" title="${(p.title||"").toString().replaceAll('"','&quot;')}">${(p.projectNo || p.project_no || p.projectNumber || p.id || "")} • ${shortTitle(p.title)}</div>
            <div class="muted">${p.category || ''} • Status: ${p.status || ''}</div>
            <div class="muted">Created by: ${p.createdBy || '—'}</div>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn btn-line small" type="button" data-edit="${p.id}">Edit</button>
            <button class="btn btn-line small" type="button" data-send="${p.id}">Send</button>
            <button class="btn btn-line small" type="button" data-del="${p.id}">Delete</button>
          </div>
        </div>
      </div>
    `).join('');

    publishedList.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => editProject(btn.getAttribute('data-edit'))));
    publishedList.querySelectorAll('[data-send]').forEach(btn => btn.addEventListener('click', () => sendProject(btn.getAttribute('data-send'))));
    publishedList.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => deleteProject(btn.getAttribute('data-del'))));
  }

  function editProject(id) {
    let store = await loadStore();
    const p = store.projects.find(x => x.id === id);
    if(!p) return;
    editingProjectId = id;
    editingProjectNo = p.projectNo || p.project_no || p.projectNumber || p.id || null;
    editingProjectCreatedAt = p.createdAt || null;
    setSaveMode();
    if(projectNumber) projectNumber.value = editingProjectNo || '';

    projectTitle.value = p.title || '';
    projectCategory.value = p.category || 'Other';
    projectStatus.value = p.status || 'draft';

    executive.value = p.sections?.executive || '';
    background.value = p.sections?.background || '';
    design.value = p.sections?.design || '';
    technical.value = p.sections?.technical || '';
    governance.value = p.sections?.governance || '';
    implementation.value = p.sections?.implementation || '';
    engagement.value = p.sections?.engagement || '';
    kpis.value = p.sections?.kpis || '';
    annexes.value = p.sections?.annexes || '';

    currentRecipients = Array.isArray(p.recipients) ? JSON.parse(JSON.stringify(p.recipients)) : [];
    currentAttachments = Array.isArray(p.attachments) ? JSON.parse(JSON.stringify(p.attachments)) : [];
    renderRecipients();
    renderAttachments();
    // Show the loaded content clearly
    setAllSections(false);
    const first = document.querySelector('#secExecutive details');
    if(first) first.setAttribute('open','open');
    autosizeAll();
    const anchor = document.getElementById('projectTitle');
    if(anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    showToast('Project loaded', 'Template filled in the builder.');

    setPane('paneBuilder');
    showToast('Edit mode', 'Update project will overwrite the existing project (no duplicates).');
  }

  function deleteProject(id) {
    let store = await loadStore();
    store.projects = store.projects.filter(p => p.id !== id);
    await saveStore(store);
    if(editingProjectId === id) { editingProjectId = null; editingProjectNo = null; editingProjectCreatedAt = null; setSaveMode(); if(projectNumber) projectNumber.value = ''; }
    renderPublished();
    renderMonitoring();
    showToast('Project deleted', 'Removed from Published projects.');
  }

  function sendProject(id) {
    let store = await loadStore();
    const p = store.projects.find(x => x.id === id);
    if(!p) return;

    const recs = Array.isArray(p.recipients) ? p.recipients : [];
    if(!recs.length) {
      showToast('No recipients', 'Add recipients before sending.');
      return;
    }
// Validate recipient emails before sending
    const invalid = recs.filter(r => !isValidEmail(r.email || ''));
    if(invalid.length) {
      showToast('Invalid recipient email', 'Fix the invalid email(s) before sending.');
      return;
    }

    const message = 'Initial send';

    const sentAt = nowISO();
    const norm = (v) => (v || '').toString().trim().toLowerCase();

    recs.forEach(r => {
      const emailKey = norm(r.email);
      const existing = (store.monitoring || []).find(m =>
        m.projectId === p.id && norm(m.recipientEmail) === emailKey
      );

      if(existing) {
        // Update existing row (avoid duplicates)
        existing.projectTitle = p.title;
        existing.projectStatus = p.status || existing.projectStatus || 'draft';
        existing.recipientName = r.name || existing.recipientName;
        existing.recipientOrg = r.org || existing.recipientOrg;
        existing.status = existing.status || 'Sent';
        existing.updatedAt = sentAt;
        if(!existing.sentAt) existing.sentAt = sentAt;

        // Ensure history exists (do not duplicate rows when a project changes status)
        if(!Array.isArray(existing.history)) {
          existing.history = [{ at: existing.sentAt || sentAt, status: 'Sent', notes: existing.notes || '' }];
        } else if(!existing.history.length) {
          existing.history.unshift({ at: existing.sentAt || sentAt, status: 'Sent', notes: message });
        }
      } else {
        store.monitoring.unshift({
          id: 'mon_' + Math.random().toString(36).slice(2,10),
          projectId: p.id,
          projectTitle: p.title,
          projectStatus: p.status || 'draft',
          recipientName: r.name || '',
          recipientEmail: r.email || '',
          recipientOrg: r.org || '',
          status: 'Sent',
          notes: '',
          sentAt,
          updatedAt: sentAt,
          history: [{ at: sentAt, status: 'Sent', notes: message }]
        });
      }
    });

    await saveStore(store);
    renderMonitoring();
    setPane('paneMonitoring');
    showToast('Project sent', `Registered ${recs.length} recipient(s) in Monitoring.`);
  }

  function renderMonitoring() {
    let store = await loadStore();
    const items = Array.isArray(store.monitoring) ? store.monitoring : [];

    monitorList.innerHTML = '';
    monitorList.classList.remove('mon-list');

    if(!items.length) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.padding = '14px';
      card.innerHTML = '<div class="muted">No monitoring entries. Go to <b>Published projects</b> → <b>Send</b> to start tracking recipients.</div>';
      monitorList.appendChild(card);
      return;
    }

    // Group by projectId
    const groups = {};
    items.forEach(m => {
      const pid = m.projectId || 'unknown';
      if(!groups[pid]) groups[pid] = [];
      groups[pid].push(m);
    });

    const projectMeta = (pid) => {
      const p = (store.projects || []).find(x => x.id === pid);
      return {
        title: p?.title || groups[pid][0]?.projectTitle || 'Project',
        status: p?.status || groups[pid][0]?.projectStatus || 'draft',
        updatedAt: (groups[pid].map(x => x.updatedAt || x.sentAt || '').sort().slice(-1)[0]) || ''
      };
    };

    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.style.padding = '14px';

    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';

    table.innerHTML = `
      <thead>
        <tr style="text-align:left;">
          <th style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);">Project</th>
          <th style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);">Recipients</th>
          <th style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);">Project status</th>
          <th style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);">Last update</th>
          <th style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.08);"></th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');

    Object.keys(groups).forEach(pid => {
      const meta = projectMeta(pid);
      const recCount = groups[pid].length;
      const isOpen = monitoringOpen[pid] === true;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);font-weight:800;">${meta.title}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);">${recCount}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);text-transform:capitalize;">${meta.status}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);">${meta.updatedAt ? fmtDate(meta.updatedAt) : '—'}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);text-align:right;">
          <button class="btn btn-line small" type="button" data-toggle="${pid}">${isOpen ? 'Hide' : 'View'}</button>
        </td>
      `;
      tbody.appendChild(tr);

      const tr2 = document.createElement('tr');
      tr2.setAttribute('data-details-row', pid);
      tr2.style.display = isOpen ? '' : 'none';
      tr2.innerHTML = `
        <td colspan="5" style="padding:12px 8px;border-bottom:1px solid rgba(0,0,0,.06);">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <div style="font-weight:800;">Recipients</div>
            <button class="btn primary small" type="button" data-add-recipient="${pid}">Add recipient</button>
          </div>

          <div data-add-form="${pid}" style="display:none;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
            <input class="input" style="min-width:180px;flex:1;" placeholder="Name" data-new-name="${pid}">
            <input class="input" style="min-width:180px;flex:1;" placeholder="Organisation" data-new-org="${pid}">
            <input class="input" style="min-width:220px;flex:1;" placeholder="Email" data-new-email="${pid}">
            <button class="btn btn-line small" type="button" data-cancel-add="${pid}">Cancel</button>
            <button class="btn primary small" type="button" data-save-add="${pid}">Save</button>
          </div>

          <div style="overflow:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="text-align:left;">
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Name</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Org</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Email</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Status</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Notes</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);">Last update</th>
                  <th style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.08);"></th>
                </tr>
              </thead>
              <tbody data-recipient-body="${pid}"></tbody>
            </table>
          </div>
        </td>
      `;
      tbody.appendChild(tr2);

      const body = tr2.querySelector(`[data-recipient-body="${pid}"]`);
      const rows = groups[pid].slice().sort((a,b) => (b.updatedAt||'').localeCompare(a.updatedAt||''));
      rows.forEach(r => {
        const rid = r.id;
        const rtr = document.createElement('tr');
        rtr.innerHTML = `
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);">${r.recipientName || '—'}</td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);">${r.recipientOrg || '—'}</td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);">${r.recipientEmail || '—'}</td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);">
            <select class="input" style="min-width:140px;" data-mon-status="${rid}">
              ${['Sent','Opened','Replied','Meeting','Done','No response'].map(s => `<option ${s=== (r.status||'Sent') ? 'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);">
            <input class="input" placeholder="" value="${(r.notes||'').replaceAll('"','&quot;')}" data-mon-notes="${rid}">
          </td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);white-space:nowrap;">${fmtDate(r.updatedAt)}</td>
          <td style="padding:8px 6px;border-bottom:1px solid rgba(0,0,0,.06);text-align:right;white-space:nowrap;">
            <button class="btn btn-line small" type="button" data-mon-history="${rid}">${recipientHistoryOpen[rid] ? 'Hide history' : 'History'}</button>
            <button class="btn btn-line small" type="button" data-mon-save="${rid}">Save</button>
          </td>
        `;
        body.appendChild(rtr);
        // History row (toggle per recipient)
        const h = Array.isArray(r.history) ? r.history : [];
        const htr = document.createElement('tr');
        htr.setAttribute('data-history-row', rid);
        htr.style.display = recipientHistoryOpen[rid] ? '' : 'none';
        const histHtml = h.length ? h.slice().sort((a,b) => (b.at||'').localeCompare(a.at||'')).map(ev => `
            <div style="padding:8px 0;border-bottom:1px solid rgba(0,0,0,.06);">
              <div style="font-weight:700;">${fmtDate(ev.at)} · ${ev.status || '—'}</div>
              <div class="muted">${(ev.notes || '—').toString().replaceAll('<','&lt;').replaceAll('>','&gt;')}</div>
            </div>
          `).join('') : `<div class="muted" style="padding:8px 0;">No history yet.</div>`;
        htr.innerHTML = `<td colspan="7" style="padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06);background:rgba(0,0,0,.02);">
            <div style="font-weight:800;margin-bottom:6px;">History</div>
            ${histHtml}
          </td>`;
        body.appendChild(htr);
      });
    });

    wrap.appendChild(table);
    monitorList.appendChild(wrap);

    // Bind actions (after DOM is ready)
    monitorList.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pid = btn.getAttribute('data-toggle');
        const row = monitorList.querySelector(`[data-details-row="${pid}"]`);
        if(!row) return;
        const isOpen = row.style.display !== 'none';
        const nextOpen = !isOpen;
        row.style.display = nextOpen ? '' : 'none';
        monitoringOpen[pid] = nextOpen;
        btn.textContent = nextOpen ? 'Hide' : 'View';
      });
    });


    monitorList.querySelectorAll('[data-mon-history]').forEach(btn => {
      btn.addEventListener('click', () => {
        const rid = btn.getAttribute('data-mon-history');
        recipientHistoryOpen[rid] = !recipientHistoryOpen[rid];
        renderMonitoring();
      });
    });

    monitorList.querySelectorAll('[data-add-recipient]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pid = btn.getAttribute('data-add-recipient');
        const form = monitorList.querySelector(`[data-add-form="${pid}"]`);
        if(form) form.style.display = form.style.display === 'none' ? 'flex' : 'none';
      });
    });

    monitorList.querySelectorAll('[data-cancel-add]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pid = btn.getAttribute('data-cancel-add');
        const form = monitorList.querySelector(`[data-add-form="${pid}"]`);
        if(form) form.style.display = 'none';
      });
    });

    monitorList.querySelectorAll('[data-save-add]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pid = btn.getAttribute('data-save-add');
        const nameEl = monitorList.querySelector(`[data-new-name="${pid}"]`);
        const orgEl = monitorList.querySelector(`[data-new-org="${pid}"]`);
        const emailEl = monitorList.querySelector(`[data-new-email="${pid}"]`);
        const email = (emailEl?.value || '').trim();
        if(!email) { showToast('Missing email', 'Please enter an email.'); return; }
        if(!isValidEmail(email)) { showToast('Invalid email', 'Please enter a valid email address.'); return; }

        const s2 = loadStore();
        if(!Array.isArray(s2.monitoring)) s2.monitoring = [];
        const norm = (v) => (v || '').toString().trim().toLowerCase();
        const existing = s2.monitoring.find(m => m.projectId === pid && norm(m.recipientEmail) === norm(email));
        const now = nowISO();

        // Fetch project title/status if available
        const p = (s2.projects || []).find(x => x.id === pid);
        const pTitle = p?.title || existing?.projectTitle || 'Project';
        const pStatus = p?.status || existing?.projectStatus || 'draft';

        if(existing) {
          existing.recipientName = (nameEl?.value || '').trim() || existing.recipientName;
          existing.recipientOrg = (orgEl?.value || '').trim() || existing.recipientOrg;
          existing.projectTitle = pTitle;
          existing.projectStatus = pStatus;
          existing.updatedAt = now;
        } else {
          s2.monitoring.unshift({
            id: 'mon_' + Math.random().toString(36).slice(2,10),
            projectId: pid,
            projectTitle: pTitle,
            projectStatus: pStatus,
            recipientName: (nameEl?.value || '').trim(),
            recipientOrg: (orgEl?.value || '').trim(),
            recipientEmail: email,
            status: 'Sent',
            notes: '',
            sentAt: now,
            updatedAt: now,
            history: []
          });
        }

        saveStore(s2);
        showToast('Recipient saved', 'Added to monitoring.');
        projectDetailsOpen[pid] = true;
        // Clear + close the inline add form
        if(nameEl) nameEl.value = '';
        if(orgEl) orgEl.value = '';
        if(emailEl) emailEl.value = '';
        const form = monitorList.querySelector(`[data-add-form="${pid}"]`);
        if(form) form.style.display = 'none';
        renderMonitoring();
});
    });

    monitorList.querySelectorAll('[data-mon-save]').forEach(btn => {
      btn.addEventListener('click', () => {
        const rid = btn.getAttribute('data-mon-save');
        const statusEl = monitorList.querySelector(`[data-mon-status="${rid}"]`);
        const notesEl = monitorList.querySelector(`[data-mon-notes="${rid}"]`);

        const s2 = loadStore();
        const it = (s2.monitoring || []).find(x => x.id === rid);
        if(!it) return;

        const notesTxt = (notesEl?.value || '').trim();
        if(!notesTxt) { showToast('Message required', 'Please enter notes/message before saving.'); return; }

        it.status = statusEl?.value || it.status || 'Sent';
        it.notes = notesTxt;
        const at = nowISO();
        it.updatedAt = at;

        // Append to recipient history (latest first)
        if(!Array.isArray(it.history)) it.history = [];
        it.history.unshift({ at, status: it.status, notes: it.notes });

        // Clear current notes after saving to avoid accidental duplicate history entries
        it.notes = '';
        if(notesEl) notesEl.value = '';

        saveStore(s2);
        showToast('Saved', 'Monitoring updated.');

        // Close this project row after saving (clean workflow)
        if(it.projectId) monitoringOpen[it.projectId] = false;

        renderMonitoring();
      });
    });
  }

  renderRecipients();
  renderAttachments();
  renderPublished();
  renderMonitoring();
  setSaveMode();
  projectSelect.value = '';
  resetBuilderForm();
});
</script>
</body>
</html>
