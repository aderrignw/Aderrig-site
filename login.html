<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Login / Register — Aderrig NW</title>
<link href="assets/style.css" rel="stylesheet"/>
<style>
  body.page-login input[type="checkbox"], body.page-login input[type="radio"]{ width:auto !important; padding:0 !important; }
  .chk{display:flex;align-items:center;gap:10px;margin:10px 0;}
  #volunteerOptions[hidden]{display:none !important;}
  .msg{ margin-top:10px; }
  .msg.ok{ color:#0f5132; }
  .msg.error{ color:#b02a37; }
</style>
</head>
<body class="page-login">
<header class="site-header">
  <div class="brand">
    <a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
    <div class="brand-text">
      <h1>Aderrig NW</h1>
      <p class="muted">Adamstown</p>
    </div>
  </div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="report.html">Report</a>
    <a href="alerts.html">Community Alerts</a>
    <a href="projects.html">Community Projects</a>
    <a href="handbook.html">Handbook</a>
    <a class="active" href="login.html">Login / Register</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="household.html">Household</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card" id="login">
      <h2>Login</h2>
      <div class="field"><label>Email</label><input id="loginEmail" type="email" autocomplete="email"/></div>
      <div class="field"><label>Eircode</label><input id="loginEir" type="text" autocomplete="postal-code" placeholder="e.g., K78XXXX"/></div>
      <div class="field"><label>Password</label><input id="loginPass" type="password" autocomplete="current-password"/></div>
      <div class="actions" style="justify-content:flex-end; gap:8px;">
        <button class="btn btn-line" id="btnShow" type="button">Show</button>
        <button class="btn" id="btnLogin" type="button">Enter</button>
      </div>
      <div class="msg" id="loginMsg"></div>
      <p class="muted tiny"><a class="link" href="#" id="lnkForgot">I forgot my password</a></p>
    </section>

    <section class="card" id="register">
      <h2>Create account</h2>
      <div class="field"><label>Full name</label><input id="regName" type="text" autocomplete="name"/></div>
      <div class="field"><label>Email</label><input id="regEmail" type="email" autocomplete="email"/></div>
      <div class="field"><label>Eircode</label><input id="regEir" type="text" autocomplete="postal-code" placeholder="e.g., K78XXXX"/></div>
      <div class="field"><label>Full address</label><input id="regAddress" type="text" autocomplete="street-address"/></div>
      <div class="field"><label>Phone number (+country code)</label><input id="regPhone" type="tel" autocomplete="tel" placeholder="+353851234567"/></div>
      <div class="field"><label>Password</label><input id="regPass" type="password" autocomplete="new-password"/></div>
      <div class="field"><label>Confirm password</label><input id="regPass2" type="password" autocomplete="new-password"/></div>
      <div class="field">
        <label>Resident type</label>
        <select id="regType">
          <option value="">Select…</option>
          <option value="owner">Owner</option>
          <option value="tenant">Tenant</option>
        </select>
      </div>
      <label class="chk"><input id="regTerms" type="checkbox"/><span>I agree to the Privacy Policy & Terms.</span></label>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn" id="btnRegister" type="button">Create account</button>
      </div>
      <div class="msg" id="regMsg"></div>
    </section>
  </div>
</main>

<footer class="site-footer">
  <div class="footer-row">
    <div class="footer-left"><span class="page-status">Public Page</span></div>
    <div class="footer-center">© 2025 Aderrig NW · <a href="privacy.html">Privacy Policy</a></div>
  </div>
</footer>

<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script src="assets/app-core.js"></script>

<script>
(async function(){
  "use strict";

  const MASTER_EMAIL = "claudiosantos1968@gmail.com";
  const MASTER_EIR = "K78T2W8";

  const $ = (id)=>document.getElementById(id);
  const loginEmail=$("loginEmail"), loginEir=$("loginEir"), loginPass=$("loginPass"), loginMsg=$("loginMsg");
  const regName=$("regName"), regEmail=$("regEmail"), regEir=$("regEir"), regAddress=$("regAddress"), regPhone=$("regPhone");
  const regPass=$("regPass"), regPass2=$("regPass2"), regType=$("regType"), regTerms=$("regTerms"), regMsg=$("regMsg");

  function setMsg(el, text, kind){
    el.textContent = text || "";
    el.className = "msg" + (kind ? (" " + kind) : "");
  }
  function normEir(e){ return (e||"").toUpperCase().replace(/\s+/g,"").trim(); }
  function normEmail(e){ return (e||"").trim().toLowerCase(); }

  // show/hide password
  $("btnShow").addEventListener("click", ()=>{
    const isPwd = loginPass.type === "password";
    loginPass.type = isPwd ? "text" : "password";
    $("btnShow").textContent = isPwd ? "Hide" : "Show";
  });

  async function ensureProfile(email, eir, patch){
    await anwInitStore();
    let users = await anwFetch(ANW_KEYS.USERS).catch(()=>[]);
    if(!Array.isArray(users)) users = [];

    const em = normEmail(email);
    const ei = normEir(eir);

    const isMaster = em === normEmail(MASTER_EMAIL) && ei === normEir(MASTER_EIR);

    const i = users.findIndex(u => normEmail(u?.email) === em);
    const base = i >= 0 ? (users[i]||{}) : {};

    const rec = {
      ...base,
      ...patch,
      email: em,
      eircode: ei,
      status: "active",
      role: isMaster ? "owner" : (base.role || ""),
      residentType: isMaster ? "Owner" : (patch?.residentType || base.residentType || base.type || ""),
      updatedAt: new Date().toISOString(),
      createdAt: base.createdAt || new Date().toISOString(),
    };

    if(i>=0) users[i]=rec; else users.push(rec);
    await anwSave(ANW_KEYS.USERS, users);
    return rec;
  }

  // LOGIN
  $("btnLogin").addEventListener("click", async ()=>{
    setMsg(loginMsg, "", "");
    const email = normEmail(loginEmail.value);
    const eir = normEir(loginEir.value);
    const pass = (loginPass.value||"").trim();

    if(!email || !eir || !pass){ setMsg(loginMsg, "Please fill all fields.", "error"); return; }
    if(!window.netlifyIdentity){ setMsg(loginMsg, "Netlify Identity widget not loaded.", "error"); return; }

    try{
      await window.netlifyIdentity.gotrue.login(email, pass, true);

      // Create/repair profile on every successful login
      await ensureProfile(email, eir, { name: email });

      setMsg(loginMsg, "Login OK. Redirecting…", "ok");
      setTimeout(()=>location.href="dashboard.html", 400);
    }catch(e){
      setMsg(loginMsg, "Login failed. Check email/password.", "error");
    }
  });

  // REGISTER
  $("btnRegister").addEventListener("click", async ()=>{
    setMsg(regMsg, "", "");
    const name = (regName.value||"").trim();
    const email = normEmail(regEmail.value);
    const eir = normEir(regEir.value);
    const address = (regAddress.value||"").trim();
    const phone = (regPhone.value||"").trim();
    const pass = (regPass.value||"").trim();
    const pass2 = (regPass2.value||"").trim();
    const type = (regType.value||"").trim();
    const terms = !!regTerms.checked;

    if(!name || !email || !eir || !pass || !pass2 || !type){ setMsg(regMsg, "Fill required fields.", "error"); return; }
    if(pass !== pass2){ setMsg(regMsg, "Passwords do not match.", "error"); return; }
    if(!terms){ setMsg(regMsg, "You must accept the Terms.", "error"); return; }

    try{
      const gt = window.netlifyIdentity.gotrue;
      await gt.signup(email, pass, { full_name: name });
      await gt.login(email, pass, true);

      await ensureProfile(email, eir, {
        name, address, phone,
        type, residentType: type,
        termsAccepted: true,
        termsAcceptedAt: new Date().toISOString()
      });

      setMsg(regMsg, "Account created and approved. Redirecting…", "ok");
      setTimeout(()=>location.href="dashboard.html", 500);
    }catch(e){
      const msg = (e && (e.message || e.error || (e.json && (e.json.error_description||e.json.error)))) || String(e);
      setMsg(regMsg, "Registration failed: " + msg, "error");
    }
  });

  // Forgot password
  $("lnkForgot").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = normEmail(loginEmail.value);
    if(!email){ setMsg(loginMsg, "Enter your email first.", "error"); return; }
    try{
      await window.netlifyIdentity.requestPasswordRecovery(email);
      setMsg(loginMsg, "Reset email sent. Check your inbox.", "ok");
    }catch{
      setMsg(loginMsg, "Could not send reset email.", "error");
    }
  });

})();
</script>

<!-- IMPORTANT: ACL GUARD DISABLED TEMPORARILY -->
<!-- <script src="assets/acl-guard.js"></script> -->
</body>
</html>
