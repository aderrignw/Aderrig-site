<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aderrig Neighbourhood Watch — Adamstown</title>
  <link rel="stylesheet" href="assets/style.css" />
  <meta name="description" content="Aderrig Neighbourhood Watch (Adamstown). Community-led safety, reporting and alerts aligned with Garda guidance." />
  <style>
    :root{--bg:#f7faf8;--card:#ffffff;--ink:#202625;--muted:#657072;--brand:#2f7d5b;--brand-2:#d6b676;--line:#e8ecea;--radius:16px;--shadow:0 6px 24px rgba(0,0,0,.06)}
    *{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1,h2,h3{margin:.2rem 0 .6rem 0;line-height:1.2}h1{font-size:1.4rem}h2{font-size:1.2rem}h3{font-size:1.05rem}
    a{color:var(--brand);text-decoration:none}a:hover{text-decoration:underline}
    .muted{color:var(--muted)}.tiny{font-size:.85rem}.justify{text-align:justify}
    .site-header{background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .logo{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),#3f9d73);display:grid;place-items:center;color:#fff;font-weight:700}
    .brand-text h1{margin:0;font-size:1.05rem}
    .nav{display:flex;flex-wrap:wrap;gap:10px;padding:0 16px 12px 16px}
    .nav a{padding:8px 10px;border-radius:10px}
    .nav a.active,.nav a:hover{background:rgba(47,125,91,.08)}
    .container{max-width:1050px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:16px}
    .grid{display:grid;gap:12px}.cols-3{grid-template-columns:2fr 3fr auto}@media (max-width:860px){.cols-3{grid-template-columns:1fr}}
    .input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .btn{border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);height:42px;align-self:stretch}
    .btn:hover{filter:brightness(1.03)}.btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
    .tile{display:block;background:#fff;border:1px solid var(--line);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
    .result{margin-top:12px;padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fbfdfc}
    .site-footer{border-top:1px solid var(--line);padding:16px 0;margin-top:20px;background:#fff}
    .foot-grid{display:flex;justify-content:space-between;gap:12px;align-items:center}
    @media (max-width:720px){.foot-grid{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">ANW</div>
      <div class="brand-text">
        <h1>Aderrig Neighbourhood Watch</h1>
        <p class="muted">Adamstown · Community-led · Ireland</p>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html" class="active">Home</a>
      <a href="about.html">About</a>
      <a href="report.html">Report</a>
      <a href="alerts.html">Community Alerts</a>
      <a href="projects.html">Community Projects</a>
      <a href="login.html">Login / Register</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="household.html">Household</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero card">
      <h2>Find your street coordinator</h2>
      <p class="help">Enter your Eircode to see nearby support for your street.</p>

      <form id="eirForm" class="grid cols-3" onsubmit="return (window.ANW && ANW.handleFindCoordinator) ? ANW.handleFindCoordinator(event) : false">
        <input id="eircodeInput" class="input" maxlength="8" placeholder="Enter your Eircode (e.g., K78XXXX)" autocomplete="postal-code" required aria-label="Eircode" />
        <input id="eirAddress" class="input" placeholder="Address will appear here" readonly aria-label="Address" />
        <button class="btn" aria-label="Continue" type="submit">Continue</button>
      </form>

      <div id="coordResult" class="result" aria-live="polite"></div>

      <p class="tiny muted" style="margin-top:8px">
        Guidance: Always call <strong>999/112</strong> in emergencies.
        For crimes, contact your local <strong>Lucan Garda Station</strong>:
        +353 (0)1 666 7300 · <a href="mailto:lucan.ds@garda.ie">lucan.ds@garda.ie</a>
      </p>
    </section>

    <section class="card">
      <h3>Quick links</h3>
      <div class="grid cols-3" style="grid-template-columns:repeat(3,1fr)">
        <a class="tile" href="about.html">What is Neighbourhood Watch?</a>
        <a class="tile" href="report.html">Report an Incident</a>
        <a class="tile" href="alerts.html">Community Alerts</a>
      </div>
    </section>
  </main>

  <script src="assets/app-core.js"></script>
  <script>
    window.ANW = window.ANW || {};

    (function () {
      // ✅ fonte única (app-core.js)
      const KEY_USERS = "users";
      const EIRCODE_ADDR = {
        'K78XXXX': 'Aderrig Park, Adamstown, Co. Dublin',
        'K78T3X1': 'Aderrig Lane, Adamstown, Co. Dublin',
        'K78A1B2': 'Aderrig Grove, Adamstown, Co. Dublin',
        'K78C9D4': 'Aderrig Court, Adamstown, Co. Dublin'
      };

      function normalizeEir(val) {
        return (val || '').toUpperCase().replace(/\s+/g, '').trim();
      }

      function isValidEir(e) {
        return /^[A-Z0-9]{7,8}$/.test(e);
      }

      function loadUsers() {
        return anwLoad(KEY_USERS, []);
      }

      function commonPrefixLen(a, b) {
        let n = 0;
        for (let i = 0; i < Math.min(a.length, b.length); i++) {
          if (a[i] !== b[i]) break;
          n++;
        }
        return n;
      }

      function deriveVolunteerRoles(user) {
        // mantém compatibilidade com versões antigas, mas prioriza vol_roles (padrão atual)
        if (Array.isArray(user.volunteering) && user.volunteering.length) return user.volunteering;
        const vr = user.vol_roles || {};
        const roles = [];
        if (vr.streetWatch) roles.push('Street watch');
        if (vr.leaflets)    roles.push('Leaflets');
        if (vr.tech)        roles.push('Tech support');
        if (vr.elderly)     roles.push('Elderly checks');
        if (vr.meetings)    roles.push('Meetings');
        if (vr.translation) roles.push('Translation');
        return roles;
      }

      function findNearbyPeople(eirNorm) {
        const users = loadUsers();
        const active = users.filter(u => anwIsApproved(u)); // ✅ approved OR active via core

        const scored = active.map(u => {
          const ue = normalizeEir(u.eircode || u.eir || '');
          const score = commonPrefixLen(ue, eirNorm);
          return { user: u, score };
        }).filter(x => x.score >= 3);

        scored.sort((a, b) => b.score - a.score);

        const coords = [];
        const vols   = [];

        scored.forEach(({ user }) => {
          const isCoord = !!(user.isCoordinator ?? user.coordinator);
          const isVol   = !!(user.isVolunteer ?? user.volunteer);
          if (isCoord) coords.push(user);
          if (isVol)   vols.push(user);
        });

        return { coords, volunteers: vols };
      }

      function setupAddressPreview() {
        const eirInput  = document.getElementById('eircodeInput');
        const addrInput = document.getElementById('eirAddress');
        if (!eirInput || !addrInput) return;

        eirInput.addEventListener('input', () => {
          const e = normalizeEir(eirInput.value);
          if (isValidEir(e)) {
            addrInput.value = EIRCODE_ADDR[e] || 'Address preview unavailable for this Eircode.';
          } else if (e.length === 0) {
            addrInput.value = '';
          } else {
            addrInput.value = 'Please enter a valid Eircode.';
          }
        });
      }

      document.addEventListener('DOMContentLoaded', setupAddressPreview);

      ANW.handleFindCoordinator = function (ev) {
        if (ev && ev.preventDefault) ev.preventDefault();

        const input = document.getElementById('eircodeInput');
        const out   = document.getElementById('coordResult');
        if (!input || !out) return false;

        const e = normalizeEir(input.value);
        if (!isValidEir(e)) {
          out.textContent = 'Please enter a valid Eircode.';
          return false;
        }

        const users = loadUsers();

        // ✅ sessão via core
        const loggedEmail = anwGetLoggedEmail();
        const current = loggedEmail
          ? users.find(u => anwNormEmail(u.email) === anwNormEmail(loggedEmail))
          : null;

        const isApproved = !!(current && anwIsApproved(current));

        const nearby = findNearbyPeople(e);
        const coords = nearby.coords;
        const vols   = nearby.volunteers;

        // Usuário não aprovado: mostra apenas contagem (sem nomes/telefones)
        if (!isApproved) {
          const cCount = coords.length;
          const vCount = vols.length;

          const roleSet = new Set();
          vols.forEach(u => deriveVolunteerRoles(u).forEach(r => roleSet.add(r)));
          const roles = Array.from(roleSet);

          let roleText = '';
          if (roles.length) {
            roleText = ' — volunteers help with ' + roles.slice(0, 3).join(', ') + (roles.length > 3 ? ', …' : '');
          }

          out.innerHTML = `
            <strong>Nearby support:</strong><br>
            ${cCount} street coordinator(s) and ${vCount} volunteer(s) near your Eircode${roleText}.<br>
            <small>Login or register to see names and phone numbers.</small>
          `;
          return false;
        }

        // Usuário aprovado: mostra nomes e telefones
        const lines = [];

        if (coords.length) {
          lines.push('<strong>Street coordinators near you:</strong>');
          coords.forEach(u => {
            const name  = u.name || 'Coordinator';
            const phone = u.phone || '(phone not available)';
            lines.push(`${name} — Street coordinator — ${phone}`);
          });
          lines.push('');
        }

        if (vols.length) {
          lines.push('<strong>Volunteers near you:</strong>');
          vols.forEach(u => {
            const name  = u.name || 'Volunteer';
            const phone = u.phone || '(phone not available)';
            const roles = deriveVolunteerRoles(u);
            const roleLabel = roles.length ? roles.join(', ') : 'Volunteer';
            lines.push(`${name} — ${roleLabel} — ${phone}`);
          });
        }

        if (!lines.length) {
          out.innerHTML = `
            <strong>No coordinators or volunteers found near this Eircode.</strong><br>
            Once local residents register and are approved, their roles will appear here.
          `;
        } else {
          out.innerHTML = lines.join('<br>');
        }

        return false;
      };
    })();
  </script>

  <footer>
    <div style="text-align:center;">
      © 2025 Aderrig NW · All rights reserved ·
      <a href="privacy.html">Privacy Policy</a>
    </div>
  </footer>
</body>
</html>


