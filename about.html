<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="page:about" name="anw-acl-key"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>About — Aderrig NW</title>
<link href="assets/style.css" rel="stylesheet"/>
<meta content="About Aderrig Neighbourhood Watch: purpose, how it works, incident types, reporting guidance and community alerts." name="description"/>
<style>
    /* Fix alignment of Role column in Team table */
    .team-table th:nth-child(2),
    .team-table td:nth-child(2){
      text-align: left !important;
      vertical-align: middle;
    }
    .team-table td:nth-child(1) button.linklike{
      display: inline;
      text-align: left !important;
      font: inherit;
      max-width: 100%;
      white-space: normal;
    }
    .team-table td:nth-child(2) button.linklike{
      display: inline-block;
      text-align: left !important;
    }
  </style>
<style id="about-justify-fix">
/* Justify text on About page */
.about-content,
.about-content p,
.about-section p,
main p {
  text-align: justify;
}
</style>
</head>
<body>
<header class="site-header">
<div class="brand">
<a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
<div class="brand-text">
<h1>Aderrig NW</h1>
<p class="muted">Adamstown</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a class="active" href="about.html">About</a>
<a href="report.html">Report</a>
<a href="alerts.html">Community Alerts</a>
<a href="projects.html">Community Projects</a>
<a href="handbook.html">Handbook</a>
<a href="login.html">Login / Register</a>
<a href="dashboard.html">Dashboard</a>
<a href="household.html">Household</a>
<a href="admin.html">Admin</a>
</nav>
</header>
<main class="container">
<section class="card">
<div class="actions" style="margin-bottom:1rem; gap:8px; justify-content:flex-start; flex-wrap:wrap;">
<button class="btn" id="btnTabAbout" style="height:auto; padding:8px 18px;" type="button">
          About
        </button>
<button class="btn" id="btnTabTeam" style="height:auto; padding:8px 18px;" type="button">
          Team
        </button>
</div>
</section>
<div class="subtab" id="tabAbout" style="margin-top:0.5rem;">
<section class="card">
<h2>What Neighbourhood Watch does</h2>
<p class="justify">
          Neighbourhood Watch (NW) is a resident-led, Garda-supported programme focused on reducing crime, improving
          safety and strengthening community ties. In Aderrig (Adamstown), our goals are to deter and report anti-social
          behaviour, protect vulnerable residents, preserve property and public spaces, and enable fast, accurate
          information-sharing with the Gardaí.
        </p>
<ul class="bullets">
<li><strong>Report, don’t risk:</strong> residents report concerns; Gardaí investigate.</li>
<li><strong>Accuracy first:</strong> time, place, people involved, vehicle info, and images/videos (only if safe) help the Garda.</li>
<li><strong>Community Alerts:</strong> one-way broadcasts to opted-in residents for urgent situations within Aderrig.</li>
<li><strong>Privacy:</strong> this site stores only necessary metadata. Photos/videos are <em>not</em> stored here — they are sent by email to the Garda liaison.</li>
</ul>
<p class="tiny muted">
          Emergencies: call <strong>999/112</strong>. For crimes and advice contact your local <strong>Lucan Garda Station</strong>:
          +353 (0)1 666 7300 · <a href="mailto:lucan.ds@garda.ie">lucan.ds@garda.ie</a>.
        </p>
</section>
<section class="card">
<h3>How reporting works (step by step)</h3>
<ol class="justify">
<li>On the <a href="report.html">Report</a> page, select the incident type and provide accurate details (what, when, where, how).</li>
<li>Attach photos/videos only if safe to do so. The site will package and email them to the Garda liaison.</li>
<li>After submission, a reference is created in your <a href="dashboard.html">Dashboard</a>, where you can request updates and follow the status.</li>
<li>Do not publish suspect details on social media. If the situation escalates or becomes threatening, call <strong>999/112</strong> immediately.</li>
</ol>
</section>
<section class="card">
<h3>Common incident types — what to report &amp; what not to do</h3>
<details class="acc">
<summary>Anti-social behaviour</summary>
<div class="acc-body justify">
<p><strong>Report when:</strong> persistent noise, intimidation, public disorder, harassment, vandalism, drug-related nuisance.</p>
<p><strong>What to include:</strong> dates/times, exact location, clear description of behaviours, any pattern or repetition, people involved.</p>
<p><strong>Do not:</strong> confront groups, film closely or provoke; avoid posting unverified claims online. If threatening, call 999/112.</p>
</div>
</details>
<details class="acc">
<summary>Theft &amp; burglary</summary>
<div class="acc-body justify">
<p><strong>Report when:</strong> stolen bike/car, attempted break-in, shed/garage burglary, tool theft.</p>
<p><strong>What to include:</strong> serial numbers, identifiable marks, when last seen, CCTV reference, vehicle details (if any).</p>
<p><strong>Do not:</strong> follow suspects, touch potential evidence, or post suspects’ images publicly.</p>
</div>
</details>
<details class="acc">
<summary>Vehicle issues</summary>
<div class="acc-body justify">
<p><strong>Report when:</strong> suspicious vehicles, plate swapping, catalytic converter theft, dangerous parking blocking access.</p>
<p><strong>What to include:</strong> make/model/colour, reg plate, direction of travel, date/time, precise location or link.</p>
<p><strong>Do not:</strong> block or pursue vehicles; avoid placing yourself at risk.</p>
</div>
</details>
<details class="acc">
<summary>Vandalism &amp; graffiti</summary>
<div class="acc-body justify">
<p><strong>Report when:</strong> damage to property or public furniture, signage, shelters, lighting.</p>
<p><strong>What to include:</strong> address or landmark, photos (attach in email), estimated time frame (when noticed/last seen ok).</p>
<p><strong>Do not:</strong> attempt repairs that may alter or contaminate evidence.</p>
</div>
</details>
<details class="acc">
<summary>Suspicious activity</summary>
<div class="acc-body justify">
<p><strong>Report when:</strong> door-to-door scams, unusual loitering, testing door handles, trying letterboxes, tampering with gates.</p>
<p><strong>What to include:</strong> descriptions (age range, build, clothing), direction of travel, any vehicle details.</p>
<p><strong>Do not:</strong> engage directly or share unverified rumours online.</p>
</div>
</details>
</section>
<section class="card">
<h3>Community Alerts</h3>
<p class="justify">
          Community Alerts are one-way broadcasts that notify opted-in residents about urgent safety information in Aderrig.
          Only an authorised Garda liaison or approved coordinator can trigger alerts. Residents manage email/SMS
          preferences from their <a href="dashboard.html">Dashboard</a>. Alerts focus on informing everyone quickly in
          case of an <strong>urgent situation occurring in the Aderrig area</strong>.
        </p>
</section>
</div>
<div class="subtab" id="tabTeam" style="display:none; margin-top:0.5rem;">
<section class="card" id="teamBallotCard">
<h3>Resident voting – current candidates</h3>
<div class="tiny" id="teamBallotContent">
<p class="muted">
            When there are approved candidates for Area Coordinator or Assistant Area Coordinator,
            they will appear here so that registered residents can cast a simple Yes/No support
            vote for each role.
          </p>
</div>
</section>
<section class="card" style="margin-top:0;">
<div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px;">
<div>
<h3>Current roles and volunteers</h3>
<p class="tiny muted" style="margin:0;">
              This is a working structure for Aderrig / Adamstown. Names shown here are
              placeholders until real residents and candidates are confirmed. For elected roles,
              the <strong>Name</strong> column will list candidates for that role. Click a role
              to see more details.
            </p>
</div>
</div>
<div style="overflow-x:auto;">
<table class="team-table" style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem;">
<thead>
<tr>
<th style="text-align:left; padding:8px 4px; border-bottom:1px solid var(--line);">Name</th>
<th style="text-align:left; padding:8px 4px; border-bottom:1px solid var(--line);">Role</th>
<th style="text-align:left; padding:8px 4px; border-bottom:1px solid var(--line);">Scope / area</th>
<th style="text-align:left; padding:8px 4px; border-bottom:1px solid var(--line);">Appointment basis</th>
<th style="text-align:left; padding:8px 4px; border-bottom:1px solid var(--line);">Voting status</th>
</tr>
</thead>
<tbody id="teamTableBody">
<!-- Rows injected by JavaScript -->
</tbody>
</table>
</div>
<div style="margin-top:10px; padding:8px 10px; border-radius:10px; background:#f9fafb; border:1px dashed var(--line);">
<p class="tiny muted" style="margin:0;">
            When you are logged in as a registered household, any role that requires resident
            approval (Area Coordinator, Assistant Area Coordinator) will show a simple
            <strong>Yes / No</strong> voting control next to each candidate. One vote per
            residence (one Eircode). You can always click on the candidate’s name to read their
            background before voting.
          </p>
</div>
</section>
<section class="card">
<h3>Appointment &amp; voting rules</h3>
<p class="tiny justify">
          Two key roles are decided by <strong>resident vote</strong>: the <strong>Area Coordinator</strong>
          and <strong>Assistant Area Coordinator</strong>. Each registered household (one Eircode) may cast
          a single Yes/No vote for each candidate.
        </p>
<p class="tiny justify" style="margin-top:6px;">
          A candidate is considered <strong>elected</strong> once at least <strong>60% of valid Yes votes</strong>
          from active households is reached. Other roles (Street Coordinators, general Volunteers, Project Volunteers
          and Platform / Admin Support) are <strong>approved by administrators</strong> and are
          <strong>not subject to a public resident ballot</strong>.
        </p>
</section>
</div>
<!-- Modal for approved roster (admin-approved roles) -->
<div hidden="" id="teamRosterModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.35);  align-items:center; justify-content:center; z-index:21;">
<div class="card" style="max-width:560px; width:92%; max-height:90vh; overflow:auto;">
<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
<div>
<h3 id="rosterTitle">Role</h3>
<p class="muted tiny" id="rosterSubtitle" style="margin:0;">Approved roster</p>
</div>
<button class="btn tiny" id="btnCloseRosterModal" type="button">Close</button>
</div>
<div style="margin-top:10px;">
<p class="tiny-label" style="margin:0 0 4px;">Administrators (approvers)</p>
<ul class="tiny" id="rosterAdmins" style="padding-left:18px; margin:0;"></ul>
<p class="tiny muted" id="rosterAdminsEmpty" style="margin:6px 0 0; display:none;">No administrators found.</p>
</div>
<div style="margin-top:12px;">
<p class="tiny-label" style="margin:0 0 4px;">Approved members</p>
<ul class="tiny" id="rosterMembers" style="padding-left:18px; margin:0;"></ul>
<p class="tiny muted" id="rosterMembersEmpty" style="margin:6px 0 0; display:none;">No approved members yet.</p>
<p class="tiny muted" id="rosterHint" style="margin:10px 0 0;">
            For safety, house numbers and Eircodes are not displayed.
          </p>
</div>
</div>
</div>
<!-- Modal for team member details (Team tab) -->
<div hidden="" id="teamMemberModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.35);  align-items:center; justify-content:center; z-index:20;">
<div class="card" style="max-width:520px; width:92%; max-height:90vh; overflow:auto;">
<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
<div>
<h3 id="memberName">Name</h3>
<p class="muted tiny" id="memberRoleScope">Role · Scope</p>
</div>
<button class="btn tiny" id="btnCloseMemberModal" type="button">
            Close
          </button>
</div>
<div style="margin-top:6px;">
<p class="tiny-label" style="margin:0 0 4px;">Summary</p>
<p class="tiny justify" id="memberSummary"></p>
</div>
<div style="margin-top:10px;">
<p class="tiny-label" style="margin:0 0 4px;">Appointment &amp; community vote</p>
<p class="tiny justify" id="memberAppointment"></p>
</div>
<div style="margin-top:10px;">
<p class="tiny-label" style="margin:0 0 4px;">Responsibilities</p>
<ul class="tiny" id="memberResponsibilities" style="padding-left:18px; margin:0;"></ul>
</div>
<div style="margin-top:10px;">
<p class="tiny-label" style="margin:0 0 4px;">Notes</p>
<p class="tiny justify" id="memberNotes"></p>
</div>
</div>
</div>
</main>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><script src="assets/identity.js"></script><script src="assets/app-core.js"></script>
<script>
    (async function () {
  await anwInitStore();
      // Tab switching between About and Team
      const aboutTab = document.getElementById('tabAbout');
      const teamTab = document.getElementById('tabTeam');
      const btnAbout = document.getElementById('btnTabAbout');
      const btnTeam = document.getElementById('btnTabTeam');

      function setActive(btn){
        btnAbout.classList.remove('active');
        btnTeam.classList.remove('active');
        btn.classList.add('active');
      }

      function showAbout() {
        if (!aboutTab || !teamTab || !btnAbout || !btnTeam) return;
        aboutTab.style.display = '';
        teamTab.style.display = 'none';
        setActive(btnAbout);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function showTeam() {
        if (!aboutTab || !teamTab || !btnAbout || !btnTeam) return;
        aboutTab.style.display = 'none';
        teamTab.style.display = '';
        setActive(btnTeam);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      if (btnAbout && btnTeam) {
        btnAbout.addEventListener('click', showAbout);
        btnTeam.addEventListener('click', showTeam);
        setActive(btnAbout); // initial state
      }
    })();

    (function() {
      'use strict';

      const KEY_USERS  = (window.ANW && ANW.helpers && ANW.helpers.KEY_USERS) ? ANW.helpers.KEY_USERS : 'anw_users';
      const KEY_LOGGED = (window.ANW && ANW.helpers && ANW.helpers.KEY_LOGGED) ? ANW.helpers.KEY_LOGGED : ANW_KEYS.LOGGED;
      const KEY_VOTES  = (window.ANW && ANW.helpers && ANW.helpers.KEY_TEAM_VOTES) ? ANW.helpers.KEY_TEAM_VOTES : ANW_KEYS.TEAM_VOTES;
      // Prefer unified elections store (anw_elections) if present; else fallback to legacy settings key.
      const KEY_ELECTION = (true) ? ANW_KEYS.ELECTIONS
                        : ((window.ANW && ANW.helpers && ANW.helpers.KEY_ELECTION) ? ANW.helpers.KEY_ELECTION : ANW_KEYS.ELECTION_SETTINGS);

      function esc(s) {
        return String(s || '')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
      }

      function normEmail(v) {
        return (window.anwNormEmail ? anwNormEmail(v) : String(v || '').trim().toLowerCase());
      }

      function normEir(v) {
        return String(v || '').toUpperCase().replace(/\s+/g, '').trim();
      }

      function todayISO() {
        return new Date().toISOString().slice(0, 10);
      }

      function loadUsers() {
        return anwLoad(KEY_USERS, []);
      }

      async function saveUsers(users) {
        try { await anwSave(KEY_USERS, users || []); } catch (e) {}
      }

      function loadVotes() {
        return anwLoad(KEY_VOTES, []);
      }

      async function saveVotes(votes) {
        try { await anwSave(KEY_VOTES, votes || []); } catch (e) {}
      }

      function loadElectionSettings() {
        try {
          return anwLoad(KEY_ELECTION, null);
        } catch (e) {
          return null;
        }
      }

      function isApprovedUser(u) {
        if (window.anwIsApproved) return anwIsApproved(u);
        const st = String(u && (u.status || u.state || '') || '').toLowerCase();
        return st === 'approved' || st === 'active';
      }

      function getLoggedUser() {
        const email = (window.anwGetLoggedEmail ? anwGetLoggedEmail() : anwGetLoggedEmail()) || '';
        if (!email) return null;

        const users = loadUsers();
        const idx = users.findIndex(u => normEmail(u.email) === normEmail(email));
        if (idx === -1) return null;

        return { user: users[idx], index: idx, users };
      }

      // ==========================
      // TEAM STRUCTURE (igual ao About antigo)
      // ==========================
      const teamMembers = [
        {
          id: 'area-coordinator',
          name: 'Area Coordinator',
          role: 'Area Coordinator',
          scope: 'Overall Neighbourhood Watch scheme in Aderrig / Adamstown',
          appointmentBasis: 'Resident vote (one vote per residence, minimum 60% approval)',
          votingStatus: 'Resident vote required · voting not yet open',
          summary:
            'Candidate for the voluntary, unpaid role of Area Coordinator, leading the Neighbourhood Watch scheme for Aderrig / Adamstown and acting as a main community link with Garda and SDCC.',
          appointmentDetail:
            'This is a voluntary, unpaid community role. The Area Coordinator is elected by residents via Yes/No support votes.',
          responsibilities: [
            'Lead scheme operations and planning',
            'Coordinate with Garda liaison, SDCC and residents',
            'Oversee recruitment and volunteer task coordination',
            'Support street coordinators and local initiatives',
            'Ensure accurate alerts and reporting guidance'
          ],
          notes:
            'Candidates appear here only after admin approval. Residents may view candidate details and vote once per household.'
        },
        {
          id: 'assistant-area-coordinator',
          name: 'Assistant Area Coordinator',
          role: 'Assistant Area Coordinator',
          scope: 'Support the Area Coordinator, plus delegated tasks',
          appointmentBasis: 'Resident vote (one vote per residence, minimum 60% approval)',
          votingStatus: 'Resident vote required · voting not yet open',
          summary:
            'Supports the Area Coordinator, helps coordinate volunteers and assists with communications, community engagement and reporting support.',
          appointmentDetail:
            'This is a voluntary, unpaid community role. The Assistant Area Coordinator is elected by residents via Yes/No support votes.',
          responsibilities: [
            'Support coordinator operations',
            'Volunteer support and follow-ups',
            'Assist with urgent information relay',
            'Help with resident meetings and engagement'
          ],
          notes:
            'Candidates appear after admin approval. Residents can read the candidate statement before voting.'
        },
        {
          id: 'street-coordinator',
          name: 'Street Coordinator',
          role: 'Street Coordinator',
          scope: 'A street or cluster of houses',
          appointmentBasis: 'Admin approval (no public ballot)',
          votingStatus: 'Not subject to public vote',
          summary:
            'Helps coordinate street-level watch and distributes guidance. Works with volunteers and supports residents with basic reporting advice.',
          appointmentDetail:
            'Street coordinators are approved by administrators based on availability and community need.',
          responsibilities: [
            'Provide street-level contact point for residents',
            'Share non-urgent safety guidance',
            'Encourage correct reporting behaviour',
            'Help coordinate volunteers for tasks in the street'
          ],
          notes:
            'Admin-approved role; no resident voting.'
        },
        {
          id: 'project-volunteer',
          name: 'Project Volunteers',
          role: 'Project Volunteers',
          scope: 'Community projects (lighting, signage, events, etc.)',
          appointmentBasis: 'Admin approval (no public ballot)',
          votingStatus: 'Not subject to public vote',
          summary:
            'Residents who volunteer for community projects that improve safety, communication and neighbourhood resilience.',
          appointmentDetail:
            'Approved by administrators depending on project requirements and volunteer availability.',
          responsibilities: [
            'Support delivery of community projects',
            'Help with planning and execution',
            'Assist with communications and logistics'
          ],
          notes:
            'Admin-approved; no public ballot.'
        },
        {
          id: 'platform-admin-support',
          name: 'Platform / Admin Support',
          role: 'Platform / Admin Support',
          scope: 'Site content, maintenance and data integrity',
          appointmentBasis: 'Admin approval (no public ballot)',
          votingStatus: 'Not subject to public vote',
          summary:
            'Helps maintain the platform, validate registrations, and ensure the reporting and alerting workflows are correct and consistent.',
          appointmentDetail:
            'Approved by administrators. Focuses on internal operations, not elected.',
          responsibilities: [
            'Validate registrations',
            'Maintain elections and volunteer tasks configuration',
            'Help ensure consistent UX and data storage',
            'Support issue triage and fixes'
          ],
          notes:
            'Admin-approved; no public ballot.'
        }
      ];

      // ==========================
      // Candidate & voting logic (igual ao antigo, mas alinhado para KEY_ELECTION)
      // ==========================
      function roleLabelFromCandidate(c) {
        if (!c) return '';
        if (c.role === 'assistant') return 'Assistant Area Coordinator';
        if (c.role === 'area') return 'Area Coordinator';
        return '';
      }

      function makeKey(u, c) {
        const id = u.regId || u.email || '';
        const r = c.role || '';
        return id + '|' + r;
      }

      function canVoteNow(settings) {
        if (!settings || !settings.startDate || !settings.endDate) return false;
        const t = todayISO();
        return t >= settings.startDate && t <= settings.endDate;
      }

      function electionRoleOpen(settings, role) {
        if (!settings) return false;
        if (!settings.roles || !Array.isArray(settings.roles)) return true;
        // roles can be ['area','assistant'] etc
        return settings.roles.includes(role);
      }

      function getEligibleHouseholdsCount(users) {
        // One vote per Eircode (approved/active)
        const set = new Set();
        users.forEach(u => {
          if (!isApprovedUser(u)) return;
          const e = normEir(u.eircode || u.eir || '');
          if (e) set.add(e);
        });
        return set.size || 0;
      }

      function hasHouseholdVoted(votes, voterEir, candidateKey) {
        return votes.some(v => normEir(v.voterEircode) === normEir(voterEir) && v.candidateKey === candidateKey);
      }

      function upsertVote(votes, voterEir, candidateKey, value) {
        const idx = votes.findIndex(v => normEir(v.voterEircode) === normEir(voterEir) && v.candidateKey === candidateKey);
        const rec = {
          voterEircode: normEir(voterEir),
          candidateKey,
          vote: value,
          at: Date.now()
        };
        if (idx === -1) votes.push(rec);
        else votes[idx] = rec;
        return votes;
      }

      function countVotesForCandidate(votes, candidateKey) {
        let yes = 0, no = 0;
        votes.forEach(v => {
          if (v.candidateKey !== candidateKey) return;
          if (String(v.vote).toLowerCase() === 'yes') yes++;
          if (String(v.vote).toLowerCase() === 'no') no++;
        });
        return { yes, no, total: yes + no };
      }

      function updateVotingStatusText(settings, totalHouseholds, counts) {
        if (!settings || !settings.startDate || !settings.endDate) return 'Voting not configured';
        const now = todayISO();
        if (now < settings.startDate) return `Voting opens on ${settings.startDate}`;
        if (now > settings.endDate) return `Voting closed on ${settings.endDate}`;

        const pct = totalHouseholds > 0 ? Math.round((counts.yes / totalHouseholds) * 100) : 0;
        return `Voting open · Yes votes: ${counts.yes}/${totalHouseholds} (${pct}%)`;
      }

      function renderTeamTable() {
        const body = document.getElementById('teamTableBody');
        if (!body) return;

        body.innerHTML = '';

        const users = loadUsers();
        const votes = loadVotes();
        const settings = loadElectionSettings();
        const logged = getLoggedUser();
        const nowCanVote = canVoteNow(settings);

        const elections = loadElections();
        const winners = {
          area: pickLatestClosedWinner(elections, 'area'),
          assistant: pickLatestClosedWinner(elections, 'assistant')
        };


        // Candidates are stored on users: u.candidate = { role:'area'/'assistant', statement, status:'approved' }
        const candidates = users.filter(u => u && u.candidate && u.candidate.role && String(u.candidate.status).toLowerCase() === 'approved');

        const byRole = {
          area: candidates.filter(c => c.candidate.role === 'area'),
          assistant: candidates.filter(c => c.candidate.role === 'assistant')
        };

        const totalHouseholds = getEligibleHouseholdsCount(users);
        const voterEir = logged && logged.user ? (logged.user.eircode || logged.user.eir || '') : '';

        function mkRow(nameHTML, roleHTML, scope, basis, votingHTML) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px 4px; border-bottom:1px solid var(--line);">${nameHTML}</td>
            <td style="padding:8px 4px; border-bottom:1px solid var(--line);">${roleHTML}</td>
            <td style="padding:8px 4px; border-bottom:1px solid var(--line);">${esc(scope)}</td>
            <td style="padding:8px 4px; border-bottom:1px solid var(--line);">${esc(basis)}</td>
            <td style="padding:8px 4px; border-bottom:1px solid var(--line);">${votingHTML}</td>
          `;
          body.appendChild(tr);
        }

        function candidateNameLink(u) {
          const display = esc(u.name || u.fullName || u.email || 'Candidate');
          return `<button type="button" class="linklike" data-cand="${esc(u.email || '')}" style="background:none;border:none;padding:0;color:var(--ink);text-decoration:underline;cursor:pointer;">${display}</button>`;
        }


        function roleLink(label, staticId){
          // role description must be accessible even when Name is blank
          return `<button type="button" class="linklike" data-static="${esc(staticId)}" style="background:none;border:none;padding:0;color:var(--ink);text-decoration:underline;cursor:pointer;">${esc(label)}</button>`;
        }

        function loadElections(){
          return anwLoad(ANW_KEYS.ELECTIONS, []);
        }

        function pickLatestClosedWinner(elections, roleKey){
          const list = (elections || []).filter(e => {
            if (!e) return false;
            const r = String(e.role||'').toLowerCase();
            if (r !== roleKey) return false;
            const st = String(e.status||'').toLowerCase();
            if (st === 'open') return false;
            const name = e.electedName || e.winnerName || '';
            const email = e.electedEmail || '';
            return !!(name || email);
          });
          if (!list.length) return null;
          return list.sort((a,b)=> String(b.end||b.start||b.id||'').localeCompare(String(a.end||a.start||a.id||'')))[0];
        }

        // Render elected roles (Area/Assistant) with candidates list
        const electedRoles = [
          { roleKey:'area', label:'Area Coordinator', scope:'Overall scheme leadership', basis:'Resident vote (min 60% approval)' },
          { roleKey:'assistant', label:'Assistant Area Coordinator', scope:'Support coordinator operations', basis:'Resident vote (min 60% approval)' }
        ];

        electedRoles.forEach(er => {
          const roleOpen = electionRoleOpen(settings, er.roleKey);

          // If an election has been closed and a winner was recorded, show the elected name here
          const w = winners && winners[er.roleKey];
          if (w){
            const winnerName = w.electedName || w.winnerName || w.electedEmail || '—';
            const period = (w.start && w.end) ? (w.start + ' → ' + w.end) : ((w.start||w.end||'') ? ('Period: ' + (w.start||'') + (w.end?(' → '+w.end):'')) : '');
            const vtxt = 'Elected' + (period ? (' · ' + period) : '');
            mkRow(
              esc(winnerName),
              roleLink(er.label, er.roleKey === 'area' ? 'area-coordinator' : 'assistant-area-coordinator'),
              er.scope,
              er.basis,
              `<span class="tiny muted">${esc(vtxt)}</span>`
            );
            return;
          }


          const list = byRole[er.roleKey] || [];
          if (!list.length) {
            const vText = (!settings ? 'Voting not configured'
              : !roleOpen ? 'Role not open for election'
              : (canVoteNow(settings) ? 'Voting open · no approved candidates' : 'Voting not open'));
            mkRow('—', roleLink(er.label, er.roleKey === 'area' ? 'area-coordinator' : 'assistant-area-coordinator'), er.scope, er.basis, `<span class="muted tiny">${esc(vText)}</span>`);
            return;
          }

          list.forEach(u => {
            const key = makeKey(u, u.candidate);
            const counts = countVotesForCandidate(votes, key);
            const statusText = updateVotingStatusText(settings, totalHouseholds, counts);

            let controls = `<span class="tiny">${esc(statusText)}</span>`;

            const allowVote = logged && logged.user && isApprovedUser(logged.user) && nowCanVote && roleOpen;
            if (allowVote) {
              const already = hasHouseholdVoted(votes, voterEir, key);
              const disabled = (!voterEir || already) ? 'disabled' : '';
              const hint = !voterEir ? ' (missing Eircode)' : (already ? ' (already voted)' : '');
              controls += `
                <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                  <button type="button" class="btn tiny" data-vote="yes" data-key="${esc(key)}" ${disabled}>Yes</button>
                  <button type="button" class="btn tiny" data-vote="no" data-key="${esc(key)}" ${disabled}>No</button>
                  <span class="tiny muted">${esc(hint)}</span>
                </div>
              `;
            } else {
              controls += `<div class="tiny muted" style="margin-top:6px;">Login with an approved account to vote (during the election period).</div>`;
            }

            mkRow(candidateNameLink(u), roleLink(er.label, er.roleKey === 'area' ? 'area-coordinator' : 'assistant-area-coordinator'), er.scope, er.basis, controls);
          });
        });

        // Render non-elected “static” roles (from teamMembers list)
        teamMembers
          .filter(m => m.id !== 'area-coordinator' && m.id !== 'assistant-area-coordinator')
          .forEach(m => {
            mkRow(
              (['street-coordinator','project-volunteer','platform-admin-support'].includes(m.id)
                ? `<button type="button" class="linklike" data-roster="${esc(m.id)}" style="background:none;border:none;padding:0;margin:0;display:inline;max-width:100%;text-align:left;font:inherit;color:var(--ink);text-decoration:underline;cursor:pointer;white-space:normal;">${esc(m.name)}</button>`
                : esc(m.name)),
              roleLink(m.role, m.id),
              m.scope,
              m.appointmentBasis,
              `<span class="tiny muted">${esc(m.votingStatus)}</span>`
            );
          });

        // Candidate modal handlers
        body.querySelectorAll('[data-cand]').forEach(btn => {
          btn.addEventListener('click', () => {
            const email = btn.getAttribute('data-cand') || '';
            const users2 = loadUsers();
            const u = users2.find(x => normEmail(x.email) === normEmail(email));
            if (!u) return;
            openMemberModalForCandidate(u);
          });
        });

        body.querySelectorAll('[data-static]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-static');
            const m = teamMembers.find(x => x.id === id);
            if (!m) return;
            openMemberModalStatic(m);
          });
        });

        // Roster modal handlers (admin-approved roles)
        body.querySelectorAll('[data-roster]').forEach(btn => {
          btn.addEventListener('click', () => {
            const rid = btn.getAttribute('data-roster');
            if (!rid) return;
            openRosterModal(rid);
          });
        });

        // Vote handlers
        body.querySelectorAll('[data-vote]').forEach(btn => {
          btn.addEventListener('click', () => {
            const v = btn.getAttribute('data-vote');
            const key = btn.getAttribute('data-key');
            const logged2 = getLoggedUser();
            if (!logged2 || !logged2.user) { alert('Please log in.'); return; }
            if (!isApprovedUser(logged2.user)) { alert('Your account must be approved to vote.'); return; }
            const e = logged2.user.eircode || logged2.user.eir || '';
            if (!e) { alert('Missing Eircode. Please update your profile.'); return; }

            let votes2 = loadVotes();
            votes2 = upsertVote(votes2, e, key, v);
            saveVotes(votes2);

            renderTeamTable();
            alert('Vote recorded. Thank you.');
          });
        });
      }

      function openMemberModalStatic(member) {
        const modal = document.getElementById('teamMemberModal');
        if (!modal) return;

        document.getElementById('memberName').textContent = member.name;
        document.getElementById('memberRoleScope').textContent = `${member.role} · ${member.scope}`;
        document.getElementById('memberSummary').textContent = member.summary || '';
        document.getElementById('memberAppointment').textContent = member.appointmentDetail || member.appointmentBasis || '';

        const ul = document.getElementById('memberResponsibilities');
        ul.innerHTML = '';
        (member.responsibilities || []).forEach(r => {
          const li = document.createElement('li');
          li.textContent = r;
          ul.appendChild(li);
        });

        document.getElementById('memberNotes').textContent = member.notes || '';
        modal.hidden = false;
        modal.style.display = 'flex';
      }

      function openMemberModalForCandidate(u) {
        const modal = document.getElementById('teamMemberModal');
        if (!modal) return;

        const roleLabel = roleLabelFromCandidate(u.candidate || {});
        const scope = (u.candidate && u.candidate.role === 'area')
          ? 'Overall scheme leadership'
          : 'Support coordinator operations';

        document.getElementById('memberName').textContent = u.name || u.fullName || u.email || 'Candidate';
        document.getElementById('memberRoleScope').textContent = `${roleLabel} · ${scope}`;

        const statement = (u.candidate && (u.candidate.statement || u.candidate.reason)) ? (u.candidate.statement || u.candidate.reason) : 'No statement provided.';
        document.getElementById('memberSummary').textContent = statement;

        document.getElementById('memberAppointment').textContent =
          'This role is decided by resident vote. Each household may vote once (per Eircode). Candidate is considered elected once at least 60% Yes votes are reached from active households.';

        const ul = document.getElementById('memberResponsibilities');
        ul.innerHTML = '';
        const resp = (u.candidate && Array.isArray(u.candidate.responsibilities)) ? u.candidate.responsibilities : [];
        (resp.length ? resp : [
          'Volunteer community role',
          'Works with residents and Garda liaison',
          'Supports correct reporting and safety information'
        ]).forEach(r => {
          const li = document.createElement('li');
          li.textContent = r;
          ul.appendChild(li);
        });

        const notes = (u.candidate && u.candidate.notes) ? u.candidate.notes : '';
        document.getElementById('memberNotes').textContent = notes || 'Click Yes/No in the table to cast your vote during the election period.';
        modal.hidden = false;
        modal.style.display = 'flex';
      }


      // ==========================
      // Approved rosters (admin-approved roles)
      // Street Coordinator: show Name + Street (no house number / no Eircode)
      // Project Volunteers & Platform/Admin Support: show names only
      // ==========================
      function streetFromAddress(addr) {
        const raw = String(addr || '').trim();
        if (!raw) return '';
        // remove obvious Eircode-like tokens
        const cleaned = raw.replace(/\b[AC-FHKNPRTV-Y]\d{2}[0-9AC-FHKNPRTV-Y]{4}\b/gi, '').trim();

        // try segments split by comma; pick best segment that looks like a street
        const parts = cleaned.split(',').map(s => s.trim()).filter(Boolean);

        function normalizeSegment(seg){
          let s = String(seg || '').trim();

          // remove leading unit/apartment/block prefixes
          s = s.replace(/^(apartment|apt|unit|block|suite)\s*[^,]*\s*/i, '').trim();

          // remove leading numbers (house number)
          s = s.replace(/^\d+[a-zA-Z]?\s*/,'').trim();

          // collapse spaces
          s = s.replace(/\s+/g,' ').trim();
          return s;
        }

        for (let i=0; i<parts.length; i++){
          const seg = normalizeSegment(parts[i]);
          // avoid returning city/county tokens; choose a segment with at least one letter and length
          if (seg && /[A-Za-z]/.test(seg) && seg.length >= 3) {
            // if segment is just "Adamstown" etc, skip (basic list)
            const low = seg.toLowerCase();
            if (['adamstown','lucan','dublin','co. dublin','co dublin','county dublin','ireland'].includes(low)) continue;
            return seg;
          }
        }

        // fallback: normalize the full first part
        return normalizeSegment(parts[0] || cleaned);
      }

      function isAdminUser(u){
        const role = String(u && (u.role || u.userRole || '') || '').toLowerCase();
        return !!(u && (u.isAlertAdmin || u.isAdmin || role === 'admin' || role === 'owner'));
      }

      function openRosterModal(roleId){
        const modal = document.getElementById('teamRosterModal');
        if (!modal) return;

        const title = document.getElementById('rosterTitle');
        const subtitle = document.getElementById('rosterSubtitle');
        const ulAdmins = document.getElementById('rosterAdmins');
        const ulMembers = document.getElementById('rosterMembers');
        const adminsEmpty = document.getElementById('rosterAdminsEmpty');
        const membersEmpty = document.getElementById('rosterMembersEmpty');

        const memberDef = teamMembers.find(x => x.id === roleId);
        title.textContent = memberDef ? memberDef.name : 'Approved roster';
        subtitle.textContent = 'Approved roster (admin approved)';

        ulAdmins.innerHTML = '';
        ulMembers.innerHTML = '';
        adminsEmpty.style.display = 'none';
        membersEmpty.style.display = 'none';

        const users = loadUsers();

        // Admins list (names only)
        const admins = (users || []).filter(u => isApprovedUser(u) && isAdminUser(u));
        admins.forEach(a => {
          const li = document.createElement('li');
          li.textContent = (a.name || a.fullName || a.email || 'Admin');
          ulAdmins.appendChild(li);
        });
        if (!admins.length) adminsEmpty.style.display = '';

        // Approved members list by role
        let members = [];
        if (roleId === 'street-coordinator'){
          members = (users || []).filter(u => isApprovedUser(u) && !!u.isCoordinator);
          members.forEach(m => {
            const nm = (m.name || m.fullName || m.email || 'Member');
            const st = streetFromAddress(m.address || m.addr || m.location || '');
            const li = document.createElement('li');
            li.textContent = st ? (nm + ' — ' + st) : nm;
            ulMembers.appendChild(li);
          });
        } else if (roleId === 'project-volunteer'){
          members = (users || []).filter(u => isApprovedUser(u) && !!u.isVolunteer);
          members.forEach(m => {
            const li = document.createElement('li');
            li.textContent = (m.name || m.fullName || m.email || 'Volunteer');
            ulMembers.appendChild(li);
          });
        } else if (roleId === 'platform-admin-support'){
          members = (users || []).filter(u => isApprovedUser(u) && (isAdminUser(u) || !!u.isPlatformSupport));
          members.forEach(m => {
            const li = document.createElement('li');
            li.textContent = (m.name || m.fullName || m.email || 'Support');
            ulMembers.appendChild(li);
          });
        }

        if (!members.length) membersEmpty.style.display = '';

        modal.hidden = false;
        modal.style.display = 'flex';
      }



      // --- Roster modal close handling (fix) ---
      // Ensures Close button, backdrop click, and ESC always close the roster modal
      // Force modals closed on load
      document.addEventListener('DOMContentLoaded', () => {
        const rm = document.getElementById('teamRosterModal');
        const mm = document.getElementById('teamMemberModal');
        if(rm){ rm.style.display = 'none'; rm.hidden = true; }
        if(mm){ mm.style.display = 'none'; mm.hidden = true; }
      });

      (function anwRosterCloseFix(){
        const rosterModal = document.getElementById('teamRosterModal');
        if(!rosterModal) return;

        // Delegate click for the Close button (works even if modal content is re-rendered)
        rosterModal.addEventListener('click', (e) => {
          const t = e.target;
          if(t && t.id === 'btnCloseRosterModal'){
            rosterModal.style.display = 'none';
            rosterModal.hidden = true;
          }
        });

        // Backdrop click closes modal
        rosterModal.addEventListener('click', (e) => {
          if(e.target === rosterModal){
            rosterModal.style.display = 'none';
            rosterModal.hidden = true;
          }
        });

        // ESC closes modal
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape' && rosterModal.style.display === 'flex'){
            rosterModal.style.display = 'none';
            rosterModal.hidden = true;
          }
        });
      })();


      // Close modal
      const btnClose = document.getElementById('btnCloseMemberModal');
      if (btnClose) {
        btnClose.addEventListener('click', () => {
          const modal = document.getElementById('teamMemberModal');
          if (modal){ modal.style.display = 'none'; modal.hidden = true; }
        });
      }

      // Close modal on backdrop click
      const modal = document.getElementById('teamMemberModal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.style.display = 'none';
        });
      }

      // Render on load
      renderTeamTable();

    })();
  </script>
<footer class="site-footer">
  <div class="footer-row">
    <div class="footer-left">
      <span class="page-status">Public Page</span>
    </div>

    <div class="footer-center">
      © 2025 Aderrig NW · 
      <a href="privacy.html">Privacy Policy</a>
    </div>
  </div>
</footer>
<script defer="" src="assets/sponsors/sponsors.js"></script>
<script src="assets/acl-guard.js"></script>
</body>
</html>
