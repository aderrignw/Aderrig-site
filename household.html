<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="page:household" name="anw-acl-key"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Auth pre-check disabled (temporary public mode) -->
<script>
  (function(){
    try { document.documentElement.classList.remove('anw-preauth-hide'); } catch (_) {}
  })();
</script>
<title>Aderrig Neighbourhood Watch – Household</title>
<link href="assets/style.css" rel="stylesheet"/>
<style>
    /* Scoped only to this page – does NOT touch header/nav */
    .subtabs { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .subtabs .btn { border-radius:999px; }
    .pane { margin-top:14px; }

    .info-card{
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      background:#fbfdfc;
      margin-bottom:12px;
    }
    .info-card strong{ font-weight:700; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width: 820px){
      .grid-2,.grid-3{ grid-template-columns:1fr; }
    }

    .rolebox{
      border:1px solid rgba(0,0,0,.10); border-radius:12px;
      padding:10px; background:#fff;
    }
    .rolebox .role-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 8px; border-radius:10px;
    }
    .rolebox .role-row:hover{ background: rgba(47,125,91,.05); }
    .rolebox label{ cursor:pointer; }

    .table-wrap{ overflow-x:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 10px; border-bottom:1px solid rgba(0,0,0,.08); vertical-align:top; }
    th{ text-align:left; font-weight:700; }
    .tag{
      display:inline-block; padding:4px 8px; border-radius:999px;
      background: rgba(47,125,91,.08); border:1px solid rgba(47,125,91,.18);
      font-size:.85rem;
    }
    .tag.gray{ background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10); }

    /* Modal */
    .modal{ display:none; position:fixed; inset:0; z-index:50; }
    .modal .backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.35); }
    .modal .dialog{
      position:relative;
      max-width:720px; margin:8vh auto; background:#fff;
      border-radius:16px; border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 24px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal .header{ padding:14px 16px; border-bottom:1px solid rgba(0,0,0,.08); }
    .modal .body{ padding:14px 16px; }
    .modal .footer{ padding:12px 16px; border-top:1px solid rgba(0,0,0,.08); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }

    /* Site-style toast */
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:60;
      background:#fff; border:1px solid rgba(47,125,91,.25);
      border-left:6px solid #2f7d5b;
      border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding:10px 12px; min-width:260px; max-width:420px;
      display:none;
    }
    .toast .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .toast .x{ border:0; background:transparent; cursor:pointer; font-size:18px; line-height:1; }
    .toast .msg{ font-size:.95rem; }
    .toast .muted{ font-size:.85rem; opacity:.85; }
  </style>
<style id="page-access-style">
  footer.site-footer { position: relative; text-align: center; }
  footer.site-footer .page-access { position: absolute; left: 0; color: green; font-weight: normal; }
</style>
</head>
<body>
<header class="site-header">
<div class="brand">
<a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
<div class="brand-text">
<h1>Aderrig NW</h1>
<p class="muted">Adamstown</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a href="report.html">Report</a>
<a href="alerts.html">Community Alerts</a>
<a href="projects.html">Community Projects</a>
<a href="handbook.html">Handbook</a>
<a href="login.html">Login / Register</a>
<a href="dashboard.html">Dashboard</a>
<a class="active" href="household.html">Household</a>
<a href="admin.html">Admin</a>
</nav>
</header>
<main class="wrap">
<section class="card">
<h2>Household</h2>
<div class="subtabs">
<button class="btn btn-line small hh-tab active" data-pane="paneVols" type="button">Household volunteers</button>
<button class="btn btn-line small hh-tab" data-pane="paneTasks" type="button">Volunteer tasks</button>
</div>
<!-- =================== PANE: VOLUNTEERS =================== -->
<div class="pane" id="paneVols">
<div class="info-card">
<strong>Household volunteers</strong> is where you add people in your home and select what they can help with.
        This does <strong>not</strong> accept tasks — it only sets up who can help.
      </div>
<div class="tiny muted" id="volsNotLogged" style="display:none;">
        You are not logged in. Please <a href="login.html">log in</a> or <a href="login.html#signup">register</a> to manage household volunteers.
      </div>
<div class="tiny muted" id="volsNotApproved" style="display:none;">Your account is not approved yet. Please wait for approval.</div>
<div class="tiny muted" id="volsNotRegistered" style="display:none;">Your account is logged in, but you are not registered/approved yet. Please wait for approval.</div>
<div id="volsContent" style="display:none;">
<h3 style="margin-top:6px;">Add a household volunteer</h3>
<div class="grid-3" style="margin-top:10px;">
<div class="field">
<label for="hvName">Name</label>
<input id="hvName" placeholder="Full name" type="text"/>
</div>
<div class="field">
<label for="hvEmail">Email</label>
<input id="hvEmail" placeholder="name@example.com" type="email"/>
</div>
<div class="field">
<label for="hvPhone">Phone</label>
<input id="hvPhone" placeholder="+353…" type="tel"/>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div class="field">
<label for="hvRel">Relationship to account holder</label>
<select id="hvRel">
<option value="">Select…</option>
<option value="Spouse / partner">Spouse / partner</option>
<option value="Adult child">Adult child</option>
<option value="Parent">Parent</option>
<option value="Other relative">Other relative</option>
<option value="Housemate">Housemate</option>
<option value="Carer">Carer</option>
<option value="Other">Other</option>
</select>
</div>
<div class="field">
<label>Activities they can help with</label>
<div class="rolebox" id="hvRolesBox">
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Street watch / patrols"/> Street watch / patrols</label>
<span class="tag gray">outdoors</span>
</div>
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Distribute leaflets"/> Distribute leaflets</label>
<span class="tag gray">letters</span>
</div>
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Elderly checks"/> Elderly checks</label>
<span class="tag gray">support</span>
</div>
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Meeting organiser"/> Meeting organiser</label>
<span class="tag gray">events</span>
</div>
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Tech support"/> Tech support</label>
<span class="tag gray">digital</span>
</div>
<div class="role-row">
<label class="tiny"><input type="checkbox" value="Translation"/> Translation</label>
<span class="tag gray">language</span>
</div>
</div>
</div>
</div>
<div class="actions" style="justify-content:flex-end; gap:10px; margin-top:12px;">
<button class="btn btn-line small" id="hvClear" type="button">Clear</button>
<button class="btn small" id="hvSave" type="button">Save volunteer</button>
</div>
<p class="tiny muted" id="hvMsg" style="margin-top:8px;"></p>
<h3 style="margin-top:18px;">Your household volunteers</h3>
<div class="table-wrap" style="margin-top:8px;">
<table>
<thead>
<tr>
<th style="min-width:160px;">Name</th>
<th style="min-width:180px;">Email</th>
<th style="min-width:140px;">Phone</th>
<th style="min-width:180px;">Relationship</th>
<th style="min-width:240px;">Activities</th>
<th style="width:120px;">Actions</th>
</tr>
</thead>
<tbody id="hvTbody"></tbody>
</table>
</div>
<p class="tiny muted" id="hvEmpty" style="display:none; margin-top:10px;">No household volunteers added yet.</p>
</div>
</div>
<!-- =================== PANE: TASKS =================== -->
<div class="pane" id="paneTasks" style="display:none;">
<div class="info-card">
<strong>Volunteer tasks</strong> shows tasks created by the admin team. You can accept an open task and assign it to one of your
        household volunteers, then select a planned date and time.
      </div>
<div class="tiny muted" id="tasksNotLogged" style="display:none;">
        You are not logged in. Please <a href="login.html">log in</a> to accept volunteer tasks.
      </div>
<div class="tiny muted" id="tasksNotApproved" style="display:none;">Your account is not approved yet. Please wait for approval.</div>
<div class="tiny muted" id="tasksNotRegistered" style="display:none;">Your account is logged in, but you are not registered/approved yet. Please wait for approval.</div>
<div id="tasksContent" style="display:none;">
<div class="grid-2" style="gap:12px;">
<div class="field">
<label for="taskSearch">Search tasks</label>
<input id="taskSearch" placeholder="Title, code, eircode, street…" type="text"/>
</div>
<div class="field">
<label for="taskFilter">Filter</label>
<select id="taskFilter">
<option value="open">Open tasks</option>
<option value="mine_active">My active</option>
<option value="mine_completed">My completed</option>
<option value="all_mine">All my tasks</option>
</select>
</div>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th style="min-width:130px;">Code</th>
<th style="min-width:220px;">Title</th>
<th style="min-width:170px;">Target</th>
<th style="min-width:120px;">Due</th>
<th style="min-width:120px;">Status</th>
<th style="min-width:220px;">Assigned</th>
<th style="width:140px;">Action</th>
</tr>
</thead>
<tbody id="tasksTbody"></tbody>
</table>
</div>
<p class="tiny muted" id="tasksEmpty" style="display:none; margin-top:10px;">No tasks found.</p>
</div>
</div>
</section>
</main>
<!-- =================== ACCEPT MODAL =================== -->
<div aria-hidden="true" class="modal" id="acceptModal">
<div class="backdrop"></div>
<div aria-labelledby="acceptTitle" aria-modal="true" class="dialog" role="dialog">
<div class="header">
<h3 id="acceptTitle" style="margin:0;">Accept volunteer task</h3>
</div>
<div class="body">
<div class="tiny" id="acceptTaskSummary" style="margin-bottom:10px;"></div>
<div class="grid-2">
<div class="field">
<label for="acceptPerson">Who will do this?</label>
<select id="acceptPerson"></select>
<p class="tiny muted" style="margin-top:6px;">Only people added under <strong>Household volunteers</strong> appear here.</p>
</div>
<div class="field">
<label for="acceptRel">Relationship</label>
<input id="acceptRel" readonly="" type="text"/>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div class="field">
<label for="acceptEmail">Email</label>
<input id="acceptEmail" readonly="" type="email"/>
</div>
<div class="field">
<label for="acceptPhone">Phone</label>
<input id="acceptPhone" readonly="" type="tel"/>
</div>
</div>
<div class="grid-2" style="margin-top:12px;">
<div class="field">
<label for="acceptDate">Planned date</label>
<input id="acceptDate" type="date"/>
</div>
<div class="field">
<label for="acceptTime">Planned time</label>
<input id="acceptTime" type="time"/>
</div>
</div>
<p class="tiny muted" id="acceptMsg" style="margin-top:10px;"></p>
</div>
<div class="footer">
<button class="btn btn-line small" id="acceptCancel" type="button">Cancel</button>
<button class="btn small" id="acceptConfirm" type="button">Confirm</button>
</div>
</div>
</div>
<!-- Toast -->
<div aria-live="polite" class="toast" id="toast" role="status">
<div class="row">
<div>
<div class="msg" id="toastMsg">Saved.</div>
<div class="muted" id="toastSub"></div>
</div>
<button aria-label="Close" class="x" id="toastX">×</button>
</div>
</div>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><script src="assets/identity.js"></script><script src="assets/app-core.js"></script>
<script>
(async function(){
  'use strict';
  await anwInitStore();

  // --- UI helpers (site-style modal/toast) ---
  function anwToast(msg, type) {
    try {
      if (window.ANW && ANW.ui && typeof ANW.ui.toast === 'function') {
        ANW.ui.toast(String(msg || ''), type || 'info');
      }
    } catch {}
  }

  function anwSetMsg(id, value, type) {
    const el = document.getElementById(id);
    const v = (value === undefined || value === null) ? '' : value;
    if (el) el.textContent = (typeof v === 'string') ? v : String(v);
    const s = (typeof v === 'string') ? v.trim() : String(v).trim();
    if (s) anwToast(s, type);
  }

  const KEY_USERS = ANW_KEYS.USERS;
  const KEY_TASKS = ANW_KEYS.TASKS;

  function esc(s){
    return String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/\"/g,'&quot;');
  }

  function toast(msg, sub, type){
    // Use global site-style toast if available (from assets/app-core.js)
    try{
      if(window.ANW && ANW.ui && typeof ANW.ui.toast === 'function'){
        ANW.ui.toast(String(msg||''), type || 'info');
        if(sub) ANW.ui.toast(String(sub||''), type || 'info', 2200);
        return;
      }
    }catch{}
    // Fallback: native alert (already styled by app-core override)
    if(sub) alert(String(msg||'') + "\n" + String(sub||'')); else alert(String(msg||''));
  }

  function modal(msg, title){
    try{
      if(window.ANW && ANW.ui && typeof ANW.ui.alert === 'function'){
        ANW.ui.alert(String(msg||''), { title: title || 'Message' });
        return;
      }
    }catch{}
    alert(String(msg||''));
  }

  async function confirmModal(msg, title){
    try{
      if(typeof window.anwConfirm === 'function'){
        return await window.anwConfirm(String(msg||''), { title: title || 'Confirm' });
      }
    }catch{}
    return confirm(String(msg||''));
  }

  // Legacy toast close button (kept if you still use the old toast element)
  const toastX = document.getElementById('toastX');
  if(toastX) toastX.addEventListener('click', ()=>{ document.getElementById('toast').style.display='none'; });

  function loadUsers(){ return anwLoad(KEY_USERS, []) || []; }
  async function saveUsers(users){ await anwSave(KEY_USERS, users || []); }

  function loadTasks(){ return anwLoad(KEY_TASKS, []) || []; }
  async function saveTasks(tasks){ await anwSave(KEY_TASKS, tasks || []); }

  function loggedEmail(){ return (anwGetLoggedEmail() || '').trim().toLowerCase(); }

  function getLoggedUser(){
    const em = loggedEmail();
    if(!em) return null;
    const users = loadUsers();
    const idx = users.findIndex(u => String(u.email||'').trim().toLowerCase() === em);
    if(idx < 0) return null;
    return { users, idx, user: users[idx] };
  }

  function getHouseholdVolunteers(){
    const info = getLoggedUser();
    if(!info) return [];
    const hv = Array.isArray(info.user.householdVolunteers) ? info.user.householdVolunteers : [];
    return hv.map((v,i)=>({ ...v, __idx:i }));
  }

  // Tab switching
  const tabBtns = document.querySelectorAll('.hh-tab');
  function showPane(id){
    document.getElementById('paneVols').style.display  = (id==='paneVols') ? 'block' : 'none';
    document.getElementById('paneTasks').style.display = (id==='paneTasks') ? 'block' : 'none';
    tabBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-pane')===id));
  }
  tabBtns.forEach(b => b.addEventListener('click', ()=> showPane(b.getAttribute('data-pane'))));

  // Volunteers UI
  const volsNotLogged = document.getElementById('volsNotLogged');
  const volsContent   = document.getElementById('volsContent');
  const hvName = document.getElementById('hvName');
  const hvEmail = document.getElementById('hvEmail');
  const hvPhone = document.getElementById('hvPhone');
  const hvRel = document.getElementById('hvRel');
  const hvRolesBox = document.getElementById('hvRolesBox');
  const hvMsg = document.getElementById('hvMsg');
  const hvTbody = document.getElementById('hvTbody');
  const hvEmpty = document.getElementById('hvEmpty');

  function selectedRoles(){
    const out=[];
    if(!hvRolesBox) return out;
    hvRolesBox.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
      if(ch.checked) out.push(ch.value);
    });
    return out;
  }

  function clearVolunteerForm(){
    hvName.value=''; hvEmail.value=''; hvPhone.value=''; hvRel.value='';
    hvRolesBox.querySelectorAll('input[type="checkbox"]').forEach(ch=> ch.checked=false);
    hvMsg.textContent='';
  }

  document.getElementById('hvClear').addEventListener('click', clearVolunteerForm);

  document.getElementById('hvSave').addEventListener('click', async function(){
    const info = getLoggedUser();
    if(!info){ toast('Please log in first.'); return; }

    const name = (hvName.value||'').trim();
    const email = (hvEmail.value||'').trim();
    const phone = (hvPhone.value||'').trim();
    const rel = (hvRel.value||'').trim();
    const roles = selectedRoles();

    if(!name){ hvMsg.textContent='Please enter a name.'; toast('Please enter a name.','', 'warn'); modal('Please enter a name.','Missing information'); return; }
    if(!email){ hvMsg.textContent='Please enter an email.'; toast('Please enter an email.','', 'warn'); modal('Please enter an email.','Missing information'); return; }
    if(!phone){ hvMsg.textContent='Please enter a phone number.'; toast('Please enter a phone number.','', 'warn'); modal('Please enter a phone number.','Missing information'); return; }
    if(!rel){ hvMsg.textContent='Please select a relationship.'; toast('Please select a relationship.','', 'warn'); modal('Please select a relationship.','Missing information'); return; }

    if(!Array.isArray(info.user.householdVolunteers)) info.user.householdVolunteers = [];
    info.user.householdVolunteers.push({
      id: 'HV-' + Date.now(),
      name, email, phone,
      relationship: rel,
      roles: roles,
      createdAt: new Date().toISOString()
    });

    info.users[info.idx] = info.user;
    await saveUsers(info.users);

    clearVolunteerForm();
    await renderVolunteers();
    toast('Household volunteer saved.');
  });

  async function removeVolunteer(idx){
    const info = getLoggedUser();
    if(!info) return;

    const ok = await confirmModal('Remove this household volunteer?', 'Confirm');
    if(!ok) return;
    const arr = Array.isArray(info.user.householdVolunteers) ? info.user.householdVolunteers : [];
    if(idx<0 || idx>=arr.length) return;
    arr.splice(idx,1);
    info.user.householdVolunteers = arr;
    info.users[info.idx] = info.user;
    await saveUsers(info.users);
    await renderVolunteers();
    toast('Household volunteer removed.');
  }

  async function renderVolunteers(){
    const info = getLoggedUser();
    if(!info){
      volsNotLogged.style.display='block';
      volsContent.style.display='none';
      return;
    }
    volsNotLogged.style.display='none';
    volsContent.style.display='block';

    const arr = Array.isArray(info.user.householdVolunteers) ? info.user.householdVolunteers : [];
    hvTbody.innerHTML = '';
    hvEmpty.style.display = arr.length ? 'none' : 'block';

    arr.forEach((v,idx)=>{
      const roles = Array.isArray(v.roles) ? v.roles.join(', ') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(v.name)}</td>
        <td>${esc(v.email)}</td>
        <td>${esc(v.phone)}</td>
        <td>${esc(v.relationship || '')}</td>
        <td>${esc(roles)}</td>
        <td><button type="button" class="btn btn-line small" data-rm="${idx}">Remove</button></td>
      `;
      hvTbody.appendChild(tr);
    });

    hvTbody.querySelectorAll('[data-rm]').forEach(btn=>{
      btn.addEventListener('click', ()=> removeVolunteer(parseInt(btn.getAttribute('data-rm'),10)));
    });
  }

  // Tasks UI
  const tasksNotLogged = document.getElementById('tasksNotLogged');
  const tasksContent   = document.getElementById('tasksContent');
  const tasksTbody = document.getElementById('tasksTbody');
  const tasksEmpty = document.getElementById('tasksEmpty');
  const taskSearch = document.getElementById('taskSearch');
  const taskFilter = document.getElementById('taskFilter');

  let __acceptingTaskCode = null;

  function taskTargetLabel(t){
    const tp = t.targetType || t.type || 'general';
    if(tp==='eircode'){
      const e = (t.eircodes || t.targetEircodes || '').toString().trim();
      return e ? ('Eircodes: ' + e) : 'Eircodes';
    }
    if(tp==='street'){
      const s = (t.streets || t.targetStreets || '').toString().trim();
      return s ? ('Streets: ' + s) : 'Streets';
    }
    return 'General';
  }

  function isMineTask(t, myEmail){
    const a = t.assigned || t.assignedTo || null;
    if(!a) return false;
    return String(a.accountEmail||a.householdEmail||a.ownerEmail||'').toLowerCase() === myEmail;
  }

  function statusTag(st){
    const s = String(st||'').toLowerCase();
    if(s==='open') return '<span class="tag">Open</span>';
    if(s==='assigned') return '<span class="tag">Assigned</span>';
    if(s==='completed') return '<span class="tag">Completed</span>';
    if(s==='archived') return '<span class="tag gray">Archived</span>';
    return '<span class="tag gray">'+esc(st||'')+'</span>';
  }

  function assignedLabel(t){
    const a = t.assigned || t.assignedTo || null;
    if(!a) return '—';
    const who = a.volunteerName || a.name || 'Assigned';
    const when = a.plannedDate ? (a.plannedDate + (a.plannedTime ? (' ' + a.plannedTime) : '')) : '';
    const small = [];
    if(when) small.push(when);
    if(a.phone) small.push(a.phone);
    return esc(who) + (small.length ? '<br><span class="tiny muted">'+esc(small.join(' · '))+'</span>' : '');
  }

  async function renderTasks(){
    const em = loggedEmail();
    if(!em){
      tasksNotLogged.style.display='block';
      tasksContent.style.display='none';
      return;
    }
    tasksNotLogged.style.display='none';
    tasksContent.style.display='block';

    const q = (taskSearch.value||'').trim().toLowerCase();
    const mode = taskFilter.value;

    const tasks = loadTasks();
    let rows = tasks.slice();

    if(mode === 'open'){
      rows = rows.filter(t => String(t.status||'open').toLowerCase()==='open');
    } else if(mode === 'mine_active'){
      rows = rows.filter(t => isMineTask(t, em) && String(t.status||'').toLowerCase()==='assigned');
    } else if(mode === 'mine_completed'){
      rows = rows.filter(t => isMineTask(t, em) && String(t.status||'').toLowerCase()==='completed');
    } else if(mode === 'all_mine'){
      rows = rows.filter(t => isMineTask(t, em));
    }

    if(q){
      rows = rows.filter(t=>{
        const hay = [
          t.code, t.title, t.description, t.targetType, t.eircodes, t.streets,
          (t.assignedTo && t.assignedTo.volunteerEmail) || '',
          (t.assignedTo && t.assignedTo.volunteerName) || ''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    rows.sort((a,b)=> (b.updatedAt||'').localeCompare(a.updatedAt||'') || (String(b.code||'').localeCompare(String(a.code||''))));

    tasksTbody.innerHTML='';
    tasksEmpty.style.display = rows.length ? 'none' : 'block';

    rows.forEach(t=>{
      const tr = document.createElement('tr');
      const st = String(t.status||'open').toLowerCase();
      const canAccept = (st==='open');
      const actionBtn = canAccept
        ? `<button type="button" class="btn small" data-accept="${esc(t.code||'')}">Accept</button>`
        : `—`;

      tr.innerHTML = `
        <td>${esc(t.code||'')}</td>
        <td>
          <strong>${esc(t.title||'')}</strong>
          ${t.description ? `<div class="tiny muted" style="margin-top:4px;">${esc(t.description)}</div>` : ''}
        </td>
        <td>${esc(taskTargetLabel(t))}</td>
        <td>${esc(t.dueDate || t.due || '—')}</td>
        <td>${statusTag(t.status || 'open')}</td>
        <td>${assignedLabel(t)}</td>
        <td>${actionBtn}</td>
      `;
      tasksTbody.appendChild(tr);
    });

    tasksTbody.querySelectorAll('[data-accept]').forEach(btn=>{
      btn.addEventListener('click', ()=> openAcceptModal(btn.getAttribute('data-accept')));
    });
  }

  taskSearch.addEventListener('input', renderTasks);
  taskFilter.addEventListener('change', renderTasks);

  // Accept modal
  const acceptModal = document.getElementById('acceptModal');
  const acceptTaskSummary = document.getElementById('acceptTaskSummary');
  const acceptPerson = document.getElementById('acceptPerson');
  const acceptRel = document.getElementById('acceptRel');
  const acceptEmail = document.getElementById('acceptEmail');
  const acceptPhone = document.getElementById('acceptPhone');
  const acceptDate = document.getElementById('acceptDate');
  const acceptTime = document.getElementById('acceptTime');
  const acceptMsg = document.getElementById('acceptMsg');
  document.getElementById('acceptCancel').addEventListener('click', closeAcceptModal);
  acceptModal.querySelector('.backdrop').addEventListener('click', closeAcceptModal);

  function closeAcceptModal(){
    __acceptingTaskCode = null;
    acceptMsg.textContent='';
    acceptModal.style.display='none';
    acceptModal.setAttribute('aria-hidden','true');
  }

  function openAcceptModal(taskCode){
    const info = getLoggedUser();
    if(!info){ toast('Please log in first.'); return; }

    const volunteers = getHouseholdVolunteers();
    if(!volunteers.length){
      toast('Add a household volunteer first.', 'Go to "Household volunteers" and save a person.');
      showPane('paneVols');
      return;
    }

    const tasks = loadTasks();
    const t = tasks.find(x => String(x.code||'') === String(taskCode||''));
    if(!t){ toast('Task not found.'); return; }
    if(String(t.status||'open').toLowerCase() !== 'open'){
      toast('This task is no longer open.');
      renderTasks();
      return;
    }

    __acceptingTaskCode = String(taskCode||'');
    acceptTaskSummary.innerHTML = `
      <strong>${esc(t.title||'')}</strong><br>
      <span class="tiny muted">${esc(taskTargetLabel(t))}${t.dueDate||t.due ? (' · Due: ' + esc(t.dueDate||t.due)) : ''}</span>
    `;

    acceptPerson.innerHTML = '';
    volunteers.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.id || ('IDX:' + v.__idx);
      opt.textContent = v.name + (v.relationship ? (' (' + v.relationship + ')') : '');
      opt.dataset.email = v.email || '';
      opt.dataset.phone = v.phone || '';
      opt.dataset.rel = v.relationship || '';
      acceptPerson.appendChild(opt);
    });

    syncPersonFields();
    acceptPerson.onchange = syncPersonFields;

    acceptDate.value = '';
    acceptTime.value = '';
    acceptMsg.textContent = '';

    acceptModal.style.display='block';
    acceptModal.setAttribute('aria-hidden','false');
  }

  function syncPersonFields(){
    const opt = acceptPerson.options[acceptPerson.selectedIndex];
    acceptEmail.value = opt ? (opt.dataset.email||'') : '';
    acceptPhone.value = opt ? (opt.dataset.phone||'') : '';
    acceptRel.value   = opt ? (opt.dataset.rel||'') : '';
  }

  document.getElementById('acceptConfirm').addEventListener('click', async function(){
    const info = getLoggedUser();
    if(!info){ toast('Please log in first.'); closeAcceptModal(); return; }
    if(!__acceptingTaskCode){ return; }

    const date = (acceptDate.value||'').trim();
    const time = (acceptTime.value||'').trim();
    if(!date){ acceptMsg.textContent = 'Please select a planned date.'; return; }
    if(!time){ acceptMsg.textContent = 'Please select a planned time.'; return; }

    const opt = acceptPerson.options[acceptPerson.selectedIndex];
    if(!opt){ acceptMsg.textContent = 'Please select a person.'; return; }

    const tasks = loadTasks();
    const idx = tasks.findIndex(x => String(x.code||'') === String(__acceptingTaskCode));
    if(idx < 0){ toast('Task not found.'); closeAcceptModal(); return; }

    const t = tasks[idx];
    if(String(t.status||'open').toLowerCase() !== 'open'){
      toast('This task is no longer open.');
      closeAcceptModal();
      renderTasks();
      return;
    }

    const assignment = {
      accountEmail: loggedEmail(),
      volunteerName: opt.textContent.split(' (')[0],
      volunteerEmail: opt.dataset.email || '',
      phone: opt.dataset.phone || '',
      relationship: opt.dataset.rel || '',
      plannedDate: date,
      plannedTime: time,
      acceptedAt: new Date().toISOString()
    };

    t.status = 'assigned';
    t.assignedTo = assignment;
    t.updatedAt = new Date().toISOString();

    tasks[idx] = t;
    await saveTasks(tasks);

    closeAcceptModal();
    toast('Task accepted.', assignment.volunteerName + ' · ' + date + ' ' + time);
    await renderTasks();
  });

  // Boot
  await renderVolunteers();
  await renderTasks();
})();
</script>
<script>
// Household gate (Dashboard reference)
document.addEventListener('DOMContentLoaded', async () => {
  const show = (id) => { const el = document.getElementById(id); if(el) el.style.display = ''; };
  const hide = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'none'; };

  const setGateState = (state) => {
    // Keep tabs and headings visible, only toggle content/message blocks
    hide('volsContent'); hide('tasksContent');
    hide('volsNotLogged'); hide('tasksNotLogged');
    hide('volsNotRegistered'); hide('tasksNotRegistered');
    hide('volsNotApproved'); hide('tasksNotApproved');

    if(state === 'ok') { show('volsContent'); show('tasksContent'); return; }
    if(state === 'not_logged') { show('volsNotLogged'); show('tasksNotLogged'); return; }
    if(state === 'not_registered') { show('volsNotRegistered'); show('tasksNotRegistered'); return; }
    if(state === 'not_approved') { show('volsNotApproved'); show('tasksNotApproved'); return; }
  };

  const ensureIdentityUser = async () => {
    if(!window.netlifyIdentity) return null;
    return await new Promise((resolve) => {
      let done = false;
      const finish = (u) => { if(done) return; done = true; resolve(u || null); };
      try {
        window.netlifyIdentity.on('init', (u) => finish(u));
        window.netlifyIdentity.init();
      } catch(e) {}
      setTimeout(() => {
        try {
          const u = (typeof window.netlifyIdentity.currentUser === 'function') ? window.netlifyIdentity.currentUser() : null;
          finish(u);
        } catch(e) { finish(null); }
      }, 350);
    });
  };

  const getLoggedEmail = () => {
    try { if(window.anwGetLoggedEmail) return String(window.anwGetLoggedEmail()||''); } catch(e) {}
    try {
      const u = window.netlifyIdentity && window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();
      if(u && u.email) return String(u.email);
    } catch(e) {}
    return '';
  };

  const getProfile = async (user) => {
    try { await window.anwInitStore?.(); } catch(e) {}
    try {
      const users = (window.anwLoad && window.ANW_KEYS) ? window.anwLoad(window.ANW_KEYS.USERS, []) : [];
      const email = String((user && user.email) || getLoggedEmail() || '').toLowerCase().trim();
      const norm = (v) => String(v||'').toLowerCase().trim();
      if(Array.isArray(users)) return users.find(u => norm(u.email) === email) || null;
    } catch(e) {}
    return null;
  };

  // Default: never blank
  setGateState('not_logged');

  if(window.ANW_PUBLIC_MODE){
    setGateState('ok');
    return;
  }

  const user = await ensureIdentityUser();
  if(!user) return;

  const profile = await getProfile(user);
  if(!profile) { setGateState('not_registered'); return; }

  const status = String(profile.status || profile.accountStatus || '').toLowerCase();
  const approved = (profile.approved === true) || (profile.active === true) || status === 'active' || status === 'approved';
  if(!approved) { setGateState('not_approved'); return; }

  setGateState('ok');
});
</script>
<footer class="site-footer">
  <div class="footer-row">
    <div class="footer-left">
      <span class="page-status">Private Page</span>
    </div>

    <div class="footer-center">
      © 2025 Aderrig NW · 
      <a href="privacy.html">Privacy Policy</a>
    </div>
  </div>
</footer>
<script src="assets/acl-guard.js"></script>
</body>
</html>
