<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Alerts — Aderrig NW</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>

<header class="site-header">
  <div class="brand">
    <div class="logo">ANW</div>
    <div class="brand-text">
      <h1>Aderrig Neighbourhood Watch</h1>
      <p class="muted">Adamstown · Community-led · Ireland</p>
    </div>
  </div>
  <nav class="nav">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="report.html">Report</a>
      <a href="alerts.html" class="active">Community Alerts</a>
      <a href="projects.html">Community Projects</a>
      <a href="login.html">Login / Register</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="household.html">Household</a>
      <a href="admin.html">Admin</a>
  </nav>
</header>

<main class="wrap">
  <section class="card">
    <h2>Community alerts</h2>
    <p class="muted" id="alertIntro">
      This area is used to share important security and community information with Aderrig residents.
      In this demo version, any visitor can create alerts and contact entries. In a live system,
      permissions will be restricted to authorised Garda liaison and ANW admins.
    </p>

    <!-- SUB-TABS -->
    <div class="actions" style="margin:1rem 0; justify-content:flex-start; gap:0.5rem; flex-wrap:wrap;">
      <button type="button" class="btn btn-line alert-tab active" data-tab="send">Send alert</button>
      <button type="button" class="btn btn-line alert-tab" data-tab="contacts">Authorised contacts</button>
    </div>

    <!-- TAB: SEND ALERT -->
    <div id="tab-send">
      <div id="sendNotice" class="muted tiny" style="margin-bottom:0.5rem;">
        In this demo, any user can create and store alerts locally in this browser.
      </div>

      <form id="alertForm" onsubmit="return false;">
        <div class="field">
          <label>Subject</label>
          <!-- LIMIT: 120 characters -->
          <input
            id="alertSubject"
            type="text"
            placeholder="Brief title of the alert"
            maxlength="120"
          >
          <p class="muted tiny" style="margin-top:4px;">
            Subject limited to 120 characters to ensure compatibility with email providers.
          </p>
        </div>

        <div class="field">
          <label>Urgency</label>
          <select id="alertUrgency">
            <option value="info">Info</option>
            <option value="important">Important</option>
            <option value="emergency">Emergency</option>
          </select>
        </div>

        <div class="field">
          <label>Delivery methods (simulation only)</label>
          <div style="display:flex; flex-wrap:wrap; gap:12px;">
            <label class="chk"><input type="checkbox" id="mEmail" checked> Email</label>
            <label class="chk"><input type="checkbox" id="mSms"> SMS</label>
            <label class="chk"><input type="checkbox" id="mPush"> Push / App</label>
          </div>
          <p class="muted tiny" style="margin-top:4px;">
            Real email / SMS sending will be configured when the system is connected to a live service.
          </p>
        </div>

        <div class="field">
          <label>Audience</label>
          <select id="alertAudience">
            <option value="all">All registered residents</option>
            <option value="coordinators">Street coordinators only</option>
            <option value="volunteers">Volunteers only</option>
            <option value="owners">Owners only</option>
            <option value="tenants">Tenants only</option>
            <option value="street">Residents by street (future)</option>
            <option value="eircode">Residents by Eircode prefix (future)</option>
          </select>
        </div>

        <div class="field">
          <label>Reply-to email</label>
          <input id="alertReplyTo" type="email" placeholder="Contact email for questions">
          <p class="muted tiny" style="margin-top:4px;">
            Default: ANW contact <strong>aderrignw@gmail.com</strong> unless replaced here.
          </p>
        </div>

        <div class="field">
          <label>Message</label>
          <!-- LIMIT: 2000 characters (~300 words) -->
          <textarea
            id="alertBody"
            rows="4"
            style="width:100%; border-radius:14px; border:1px solid #e3e8e4;"
            maxlength="2000"
          ></textarea>
          <p class="muted tiny" style="margin-top:4px;">
            Message limited to 2,000 characters (approx. 300 words) to keep alerts concise and well within
            email size limits.
          </p>
        </div>

        <div class="actions" style="justify-content:flex-end; gap:8px;">
          <button id="btnPreview" type="button" class="btn btn-line">Preview</button>
          <button id="btnSendAlert" type="button" class="btn">Send alert (local log)</button>
        </div>

        <div id="alertMsg" class="tiny muted" style="margin-top:6px;"></div>
      </form>

      <!-- PREVIEW -->
      <div id="alertPreview" class="card" style="margin-top:16px; display:none; border-style:dashed;">
        <h3 style="margin-top:0;">Preview</h3>
        <div id="previewContent" class="tiny"></div>
      </div>

      <!-- LOCAL LOG -->
      <div style="margin-top:24px;">
        <h3 style="margin-top:0;">Local alert log</h3>
        <p class="muted tiny">
          This is a local record of alerts sent from this browser. In a live system, alerts would also be
          recorded on the server and delivered to residents.
        </p>
        <div id="alertListEmpty" class="muted tiny" style="display:none;">
          No alerts recorded yet.
        </div>
        <div id="alertList" style="margin-top:10px; display:none;"></div>
      </div>
    </div>

    <!-- TAB: CONTACTS -->
    <div id="tab-contacts" style="display:none;">
      <p class="muted tiny">
        These contact details identify who is officially allowed to create or approve alerts
        (Garda liaison and ANW admin). They are stored locally in this browser.
      </p>

      <div class="card" style="margin-top:12px; border-style:dashed;">
        <h3 style="margin-top:0;">Garda liaison contact</h3>
        <div class="field">
          <label>Name</label>
          <input id="gardaName" type="text" placeholder="Name of Garda contact">
        </div>
        <div class="field">
          <label>Email</label>
          <input id="gardaEmail" type="email" placeholder="Garda official email">
        </div>
        <div class="field">
          <label>Phone</label>
          <input id="gardaPhone" type="text" placeholder="Garda official phone number">
        </div>
      </div>

      <div class="card" style="margin-top:16px; border-style:dashed;">
        <h3 style="margin-top:0;">ANW main admin</h3>

        <div class="field">
          <label>Name</label>
          <input id="anwMainName" type="text" placeholder="Main ANW admin name">
        </div>

        <div class="field">
          <label>Email</label>
          <input id="anwMainEmail" type="email" placeholder="ANW contact email">
          <p class="muted tiny" style="margin-top:4px;">
            Default ANW email: <strong>aderrignw@gmail.com</strong>
          </p>
        </div>

        <div class="field">
          <label>Phone</label>
          <input id="anwMainPhone" type="text" placeholder="ANW contact phone">
        </div>
      </div>

      <div class="card" style="margin-top:16px; border-style:dashed;">
        <h3 style="margin-top:0;">Additional authorised admins</h3>

        <p class="muted tiny" style="margin-bottom:8px;">
          Each authorised admin can have a separate name, email and phone. In this demo, this list is informational;
          all alerts remain local to this browser.
        </p>

        <div id="anwExtraList"></div>

        <div class="actions" style="justify-content:flex-start; gap:8px; margin-top:12px;">
          <button id="btnAddCoordinator" type="button" class="btn btn-line">Add admin</button>
        </div>
      </div>

      <div class="actions" style="justify-content:flex-end; gap:8px; margin-top:16px;">
        <button id="btnSaveContacts" type="button" class="btn">Save contacts (local)</button>
      </div>

      <div id="contactsMsg" class="tiny muted" style="margin-top:6px;"></div>
    </div>

  </section>
</main>

<footer>
  <div style="text-align:center;">
    © 2025 Aderrig NW · All rights reserved ·
    <a href="privacy.html">Privacy Policy</a>
  </div>
</footer>

  <script src="assets/app-core.js"></script>
<script>
(function () {
  const KEY_ALERTS   = ANW_KEYS.ALERTS;
  const KEY_CONTACTS = ANW_KEYS.CONTACTS;
  const DEFAULT_ANW_EMAIL = 'aderrignw@gmail.com';

  function loadAlerts(){
    return anwLoad(KEY_ALERTS, []);
  }

  async function saveAlerts(alerts){
    return await anwSave(KEY_ALERTS, alerts);
  }

  function loadContacts() {
    try { return anwLoad(KEY_CONTACTS, {}); }
    catch (e) { return {}; }
  }

  function saveContacts(obj) {
    await anwSave(KEY_CONTACTS, obj);
  }

  // ---------- TABS ----------
  const tabButtons   = document.querySelectorAll('.alert-tab');
  const tabSend      = document.getElementById('tab-send');
  const tabContacts  = document.getElementById('tab-contacts');

  let currentTab = 'send';

  function updateTabUI() {
    if (currentTab === 'send') {
      tabSend.style.display     = 'block';
      tabContacts.style.display = 'none';
    } else {
      tabSend.style.display     = 'none';
      tabContacts.style.display = 'block';
    }

    tabButtons.forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-tab') === currentTab);
    });
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      currentTab = btn.getAttribute('data-tab') || 'send';
      updateTabUI();
    });
  });

  // ---------- CONTACTS TAB ----------
  const gardaName   = document.getElementById('gardaName');
  const gardaEmail  = document.getElementById('gardaEmail');
  const gardaPhone  = document.getElementById('gardaPhone');

  const anwMainName  = document.getElementById('anwMainName');
  const anwMainEmail = document.getElementById('anwMainEmail');
  const anwMainPhone = document.getElementById('anwMainPhone');

  const anwExtraList = document.getElementById('anwExtraList');
  const btnAddCoord  = document.getElementById('btnAddCoordinator');

  const btnSaveContacts = document.getElementById('btnSaveContacts');
  const contactsMsg     = document.getElementById('contactsMsg');

  function createExtraItem(data) {
    const wrapper = document.createElement('div');
    wrapper.className = 'card anw-extra-item';
    wrapper.style.padding = '14px';
    wrapper.style.marginBottom = '10px';

    wrapper.innerHTML = `
      <div class="field">
        <label>Name</label>
        <input type="text" data-field="name" placeholder="Admin name">
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" data-field="email" placeholder="Admin email">
      </div>
      <div class="field">
        <label>Phone</label>
        <input type="text" data-field="phone" placeholder="Admin phone">
      </div>
      <div class="actions" style="justify-content:flex-end; margin-top:4px;">
        <button type="button" class="btn btn-line btn-remove-coord">Remove</button>
      </div>
    `;

    if (data) {
      const nameInput  = wrapper.querySelector('input[data-field="name"]');
      const emailInput = wrapper.querySelector('input[data-field="email"]');
      const phoneInput = wrapper.querySelector('input[data-field="phone"]');
      if (nameInput)  nameInput.value  = data.name  || '';
      if (emailInput) emailInput.value = data.email || '';
      if (phoneInput) phoneInput.value = data.phone || '';
    }

    const btnRemove = wrapper.querySelector('.btn-remove-coord');
    btnRemove.addEventListener('click', () => {
      anwExtraList.removeChild(wrapper);
    });

    return wrapper;
  }

  function applyContactsToForm() {
    const c = loadContacts();

    if (c.garda) {
      gardaName.value  = c.garda.name  || '';
      gardaEmail.value = c.garda.email || '';
      gardaPhone.value = c.garda.phone || '';
    }

    if (c.anwMain) {
      anwMainName.value  = c.anwMain.name  || '';
      anwMainEmail.value = c.anwMain.email || '';
      anwMainPhone.value = c.anwMain.phone || '';
    } else {
      anwMainEmail.value = DEFAULT_ANW_EMAIL;
    }

    anwExtraList.innerHTML = '';
    if (Array.isArray(c.anwExtra) && c.anwExtra.length) {
      c.anwExtra.forEach(item => {
        anwExtraList.appendChild(createExtraItem(item));
      });
    }
  }

  if (btnAddCoord) {
    btnAddCoord.addEventListener('click', () => {
      const items = anwExtraList.querySelectorAll('.anw-extra-item');

      if (items.length > 0) {
        const last = items[items.length - 1];

        const nameInput  = last.querySelector('input[data-field="name"]');
        const emailInput = last.querySelector('input[data-field="email"]');
        const phoneInput = last.querySelector('input[data-field="phone"]');

        const name  = nameInput  ? nameInput.value.trim()  : '';
        const email = emailInput ? emailInput.value.trim() : '';
        const phone = phoneInput ? phoneInput.value.trim() : '';

        if (!name || !email || !phone) {
          alert('Please complete Name, Email and Phone before adding a new admin.');
          return;
        }
      }

      anwExtraList.appendChild(createExtraItem());
    });
  }

  if (btnSaveContacts) {
    btnSaveContacts.addEventListener('click', () => {
      const extra = [];
      const items = anwExtraList.querySelectorAll('.anw-extra-item');
      items.forEach(item => {
        const nameInput  = item.querySelector('input[data-field="name"]');
        const emailInput = item.querySelector('input[data-field="email"]');
        const phoneInput = item.querySelector('input[data-field="phone"]');
        const obj = {
          name:  nameInput  ? nameInput.value.trim()  : '',
          email: emailInput ? emailInput.value.trim() : '',
          phone: phoneInput ? phoneInput.value.trim() : ''
        };
        if (obj.email || obj.name || obj.phone) {
          extra.push(obj);
        }
      });

      const objToSave = {
        garda: {
          name:  gardaName.value.trim(),
          email: gardaEmail.value.trim(),
          phone: gardaPhone.value.trim()
        },
        anwMain: {
          name:  anwMainName.value.trim(),
          email: anwMainEmail.value.trim() || DEFAULT_ANW_EMAIL,
          phone: anwMainPhone.value.trim()
        },
        anwExtra: extra
      };

      saveContacts(objToSave);
      contactsMsg.textContent = 'Contacts saved locally in this browser.';
      setTimeout(() => { contactsMsg.textContent = ''; }, 2500);
    });
  }

  // ---------- SEND ALERT & PREVIEW ----------
  const subjectEl  = document.getElementById('alertSubject');
  const urgencyEl  = document.getElementById('alertUrgency');
  const mEmailEl   = document.getElementById('mEmail');
  const mSmsEl     = document.getElementById('mSms');
  const mPushEl    = document.getElementById('mPush');
  const audienceEl = document.getElementById('alertAudience');
  const replyEl    = document.getElementById('alertReplyTo');
  const bodyEl     = document.getElementById('alertBody');
  const alertMsg   = document.getElementById('alertMsg');

  const previewBox = document.getElementById('alertPreview');
  const previewContent = document.getElementById('previewContent');

  (function initReplyToDefault() {
    const c = loadContacts();
    const anwEmailSaved =
      c.anwMain && c.anwMain.email ? c.anwMain.email : DEFAULT_ANW_EMAIL;
    if (replyEl && !replyEl.value) {
      replyEl.value = anwEmailSaved;
    }
  })();

  function formatUrgencyLabel(val) {
    if (val === 'important') return 'Important';
    if (val === 'emergency') return 'Emergency';
    return 'Info';
  }

  function formatAudienceLabel(val) {
    switch (val) {
      case 'coordinators': return 'Street coordinators only';
      case 'volunteers':   return 'Volunteers only';
      case 'owners':       return 'Owners only';
      case 'tenants':      return 'Tenants only';
      case 'street':       return 'Residents by street (future)';
      case 'eircode':      return 'Residents by Eircode prefix (future)';
      case 'all':
      default:             return 'All registered residents';
    }
  }

  function buildPreviewHtml(alertObj) {
    const u   = formatUrgencyLabel(alertObj.urgency);
    const aud = formatAudienceLabel(alertObj.audience);
    const methods = alertObj.methods && alertObj.methods.length
      ? alertObj.methods.join(', ')
      : 'None';

    const when = new Date(alertObj.createdAt);
    const dateStr = when.toLocaleString();

    const byName  = alertObj.createdByName || 'Unknown';
    const byEmail = alertObj.createdByEmail || '';

    return `
      <div class="tiny">
        <div><strong>Subject:</strong> ${alertObj.subject || '(no subject)'}</div>
        <div><strong>Urgency:</strong> ${u}</div>
        <div><strong>Audience:</strong> ${aud}</div>
        <div><strong>Methods (simulated):</strong> ${methods}</div>
        <div><strong>Reply-to:</strong> ${alertObj.replyTo || ''}</div>
        <div style="margin-top:6px;"><strong>Message:</strong><br>${(alertObj.body || '').replace(/\n/g, '<br>')}</div>
        <hr style="margin:10px 0;">
        <div><strong>Created at:</strong> ${dateStr}</div>
      </div>
    `;
  }

  const btnPreview   = document.getElementById('btnPreview');
  const btnSend      = document.getElementById('btnSendAlert');

  if (btnPreview) {
    btnPreview.addEventListener('click', () => {
      if (!subjectEl.value.trim() && !bodyEl.value.trim()) {
        alert('Please enter at least a subject or a message to preview.');
        return;
      }

      const alertObj = {
        subject: subjectEl.value.trim(),
        urgency: urgencyEl.value,
        methods: [
          mEmailEl.checked ? 'Email' : null,
          mSmsEl.checked   ? 'SMS'   : null,
          mPushEl.checked  ? 'Push'  : null
        ].filter(Boolean),
        audience: audienceEl.value,
        replyTo: replyEl.value.trim(),
        body:    bodyEl.value,
        createdAt: new Date().toISOString(),
        createdByName:  '',
        createdByEmail: ''
      };

      previewContent.innerHTML = buildPreviewHtml(alertObj);
      previewBox.style.display = 'block';
    });
  }

  function clearForm() {
    subjectEl.value = '';
    urgencyEl.value = 'info';
    mEmailEl.checked = true;
    mSmsEl.checked = false;
    mPushEl.checked = false;
    audienceEl.value = 'all';
    bodyEl.value = '';
  }

  if (btnSend) {
    btnSend.addEventListener('click', () => {
      const subj = subjectEl.value.trim();
      const body = bodyEl.value.trim();

      if (!subj && !body) {
        alert('Please enter a subject or a message before sending.');
        return;
      }

      const alerts = loadAlerts();

      const alertObj = {
        id:       Date.now(),
        subject:  subj || '(no subject)',
        urgency:  urgencyEl.value,
        methods: [
          mEmailEl.checked ? 'Email' : null,
          mSmsEl.checked   ? 'SMS'   : null,
          mPushEl.checked  ? 'Push'  : null
        ].filter(Boolean),
        audience: audienceEl.value,
        replyTo:  replyEl.value.trim() || DEFAULT_ANW_EMAIL,
        body:     body,
        createdAt: new Date().toISOString()
      };

      alerts.unshift(alertObj);
      await saveAlerts(alerts);

      alertMsg.textContent = 'Alert stored locally. In a live system it would now be delivered to residents.';
      setTimeout(() => { alertMsg.textContent = ''; }, 3000);

      previewBox.style.display = 'none';
      clearForm();
      renderAlertList();
    });
  }

  // ---------- ALERT LOG LIST ----------
  const alertList      = document.getElementById('alertList');
  const alertListEmpty = document.getElementById('alertListEmpty');

  function renderAlertList() {
    const alerts = loadAlerts();

    if (!alerts.length) {
      alertListEmpty.style.display = 'block';
      alertList.style.display = 'none';
      alertList.innerHTML = '';
      return;
    }

    alertListEmpty.style.display = 'none';
    alertList.style.display = 'block';
    alertList.innerHTML = '';

    alerts.forEach(a => {
      const d = new Date(a.createdAt);
      const dateStr = d.toLocaleString();

      const urgency = formatUrgencyLabel(a.urgency);
      const audienceLabel = formatAudienceLabel(a.audience);

      let badgeColor = '#e2f3ec';
      let badgeBorder = '#2f7d5b';
      if (a.urgency === 'important') {
        badgeColor = '#fff4ce';
        badgeBorder = '#d79400';
      } else if (a.urgency === 'emergency') {
        badgeColor = '#ffe5e5';
        badgeBorder = '#d93025';
      }

      const card = document.createElement('div');
      card.className = 'card';
      card.style.marginBottom = '10px';
      card.style.padding = '14px';

      card.innerHTML = `
        <div class="tiny" style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
          <div><strong>${a.subject}</strong></div>
          <span style="
            font-size:0.7rem;
            padding:2px 8px;
            border-radius:999px;
            border:1px solid ${badgeBorder};
            background:${badgeColor};
          ">
            ${urgency}
          </span>
        </div>
        <div class="tiny muted" style="margin-top:2px;">
          Audience: ${audienceLabel} · Created: ${dateStr}
        </div>
        <div class="tiny" style="margin-top:6px;">
          ${(a.body || '').replace(/\n/g, '<br>')}
        </div>
        <div class="tiny muted" style="margin-top:8px;">
          Reply-to: ${a.replyTo || ''}
        </div>
      `;

      alertList.appendChild(card);
    });
  }

  // ---------- INIT ----------
  applyContactsToForm();
  renderAlertList();
  updateTabUI();
})();
</script>

</body>
</html>
