<!DOCTYPE html>

<html lang="en">
<head>
<script>
    // Injected by Netlify at build time
    window.GOOGLE_MAPS_API_KEY = "{{ GOOGLE_MAPS_BROWSER_KEY }}";
  </script>
<meta charset="utf-8"/>
<meta content="page:report-map" name="anw-acl-key"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Incidents map — Aderrig NW</title>
<link href="assets/style.css" rel="stylesheet"/>
<style id="page-access-style">
  /* Public/Private indicator aligned to the same container as the footer (like Home) */
  .site-footer{ position: relative; text-align: center; }
  .site-footer .page-access{ position:absolute; left:0; color:green; font-weight:normal; }
</style>
<style id="anw-access-overlay-style">
  #anwAccessOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.35);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  #anwAccessOverlay .box{
    background:#fff; border-radius:12px; padding:18px 18px; max-width:520px; width:92%;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  #anwAccessOverlay .title{ font-size:1.1rem; margin:0 0 8px 0; }
  #anwAccessOverlay .msg{ margin:0 0 14px 0; line-height:1.35; }
  #anwAccessOverlay .actions{ display:flex; gap:10px; justify-content:flex-end; }
  #anwAccessOverlay a.btn, #anwAccessOverlay button.btn{
    display:inline-block; padding:10px 12px; border-radius:10px; border:0; cursor:pointer;
    text-decoration:none;
  }
  #anwAccessOverlay a.btn-primary, #anwAccessOverlay button.btn-primary{ background:#111; color:#fff; }
  #anwAccessOverlay a.btn-ghost, #anwAccessOverlay button.btn-ghost{ background:#eee; color:#111; }
</style>
<style id="anw-dashboard-gate-style">
  body.anw-locked .report-panel { display:none; }
  body.anw-locked .map-panel { display:none; }
</style>
<style id="anw-locked-style">
  .anw-locked .anw-protected { display: none !important; }
</style>
</head>
<body>
<header class="site-header">
<div class="brand">
<a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
<div class="brand-text">
<h1>Aderrig NW</h1>
<p class="muted">Adamstown</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a class="active" href="report.html">Report</a>
<a href="alerts.html">Community Alerts</a>
<a href="projects.html">Community Projects</a>
<a href="login.html">Login / Register</a>
<a href="dashboard.html">Dashboard</a>
<a href="household.html">Household</a>
<a href="admin.html">Admin</a>
</nav>
</header>
<main class="wrap">
<section class="card">
<h2>Report an incident</h2>
<p class="muted tiny">
      This tool helps you prepare an incident report to send to Gardaí using your own email.
      The Aderrig Neighbourhood Watch website does <strong>not</strong> upload or store photos, videos or other files —
      only the text you enter here is kept locally in this browser.
    </p>
<div class="tiny muted" id="anwAccessNotice" style="margin-top:12px; display:none;">
      You are not logged in. Please <a href="login.html">log in</a> or <a href="login.html#signup">register</a> to continue.
    </div>
<div class="actions" style="gap:0.5rem; justify-content:flex-start; flex-wrap:wrap; margin-top:0.75rem;">
<button class="btn btn-line" id="btnTabReport" onclick="window.location.href='report.html'" type="button">Report incident</button>
<button class="btn btn-line" id="btnTabStatus" onclick="window.location.href='report.html#status'" type="button">My reports status</button>
<button class="btn btn-line active" id="btnTabMap" type="button">Incidents map</button>
</div>
</section>
<section class="card anw-protected">
<h2>Incidents map</h2>
<div class="actions" style="gap:0.75rem; justify-content:flex-start; flex-wrap:wrap; margin-bottom:1rem;">
<div class="field" style="min-width:180px;">
<label class="tiny muted" for="mapCategory">Category</label>
<select class="input" id="mapCategory" style="width:100%;">
<option value="all">All</option>
<option value="Suspicious activity">Suspicious activity</option>
<option value="Burglary / attempted burglary">Burglary / attempted burglary</option>
<option value="Damage / vandalism">Damage / vandalism</option>
<option value="Anti-social behaviour">Anti-social behaviour</option>
<option value="Theft / vehicle related">Theft / vehicle related</option>
<option value="other">Other</option>
</select>
</div>
<div class="field" style="min-width:160px;">
<label class="tiny muted" for="mapPeriod">Period</label>
<select class="input" id="mapPeriod" style="width:100%;">
<option value="all">All</option>
<option value="7">Last 7 days</option>
<option value="30">Last 30 days</option>
<option value="90">Last 90 days</option>
<option value="365">Last 12 months</option>
</select>
</div>
<div style="display:flex; gap:0.5rem; align-items:flex-end;">
<button aria-label="Fit map to markers" class="btn" id="btnMapFit" type="button">Fit</button>
<button aria-label="Refresh incidents on map" class="btn btn-line" id="btnMapRefresh" type="button">Refresh</button>
</div>
</div>
<div id="mapWrap" style="border-radius:18px; border:1px solid #e4e7eb; overflow:hidden; background:#f3f6fb; min-height:420px;">
<div id="map" style="width:100%; height:420px;"></div>
</div>
<p class="tiny muted" style="margin-top:10px;">
      If the map stays blank, check that the Google Maps API key is set and enabled (Maps JavaScript API) and that billing is enabled for the project.
    </p>
</section>
</main>
<footer class="site-footer">
<span class="page-access">Private Page</span>
<div style="text-align:center;">
    © 2025 Aderrig NW · All rights reserved ·
    <a href="privacy.html">Privacy Policy</a>
</div>
</footer>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><script src="assets/identity.js"></script><script src="assets/app-core.js"></script>
<script>
/**
 * Incidents Map
 * - This page WAS a placeholder (no Google Maps script / no container), so nothing could render.
 * - Set your API key below (or inject via build env) to enable the live map.
 */
let GOOGLE_MAPS_API_KEY = window.GOOGLE_MAPS_API_KEY || ""; // browser key only

// If the key was not injected at build time (common), fetch it from the config function.
async function ensureMapsKey(){
  if(GOOGLE_MAPS_API_KEY && !String(GOOGLE_MAPS_API_KEY).includes("{{")) return GOOGLE_MAPS_API_KEY;
  try{
    const res = await fetch('/.netlify/functions/config', { cache: 'no-store' });
    const data = await res.json();
    const k = data && data.googleMapsApiKey;
    if(k) GOOGLE_MAPS_API_KEY = k;
  }catch(e){}
  return GOOGLE_MAPS_API_KEY;
}


let map;
let markers = [];

async function loadGoogleMaps() {
  await ensureMapsKey();
  // If key not set, show a friendly placeholder instead of failing silently.
  if(!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY" || String(GOOGLE_MAPS_API_KEY).includes("{{")) {
    const el = document.getElementById('map');
    if(el) {
      el.innerHTML = '<div style="padding:28px; text-align:center; color:#6d7680;">' +
        '<strong>Google Maps not configured</strong><br><br>' +
        'Set <code>GOOGLE_MAPS_BROWSER_KEY</code> in Netlify Environment variables (or configure <code>/.netlify/functions/config</code>) to enable the interactive map.' +
        '</div>';
    }
    return;
  }

  const s = document.createElement('script');
  s.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(GOOGLE_MAPS_API_KEY) + '&callback=initMap';
  s.async = true;
  s.defer = true;
  document.head.appendChild(s);
}

function initMap() {
  // Default centre (Adamstown / Lucan area) — adjust as needed
  const centre = { lat: 53.3385, lng: -6.4555 };

  map = new google.maps.Map(document.getElementById('map'), {
    center: centre,
    zoom: 13,
    mapTypeControl: false,
    fullscreenControl: true,
    streetViewControl: false
  });

  // First render
  refreshMap();
}

// Example: load incidents from central store (if you later store coordinates)
// For now we support incidents with {lat,lng,category,createdAt,title}
async function loadIncidents() {
  try { await window.anwInitStore?.(); } catch(e) { /* store init failed (offline/local). */ }
  const incidents = window.anwLoad ? window.anwLoad(window.ANW_KEYS?.INCIDENTS || 'anw_incidents', []) : [];
  return Array.isArray(incidents) ? incidents : [];
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

function withinDays(iso, days) {
  if(!days || days === 'all') return true;
  const n = Number(days);
  if(!n) return true;
  const d = new Date(iso || '');
  if(String(d) === 'Invalid Date') return true;
  const cutoff = Date.now() - n * 24 * 60 * 60 * 1000;
  return d.getTime() >= cutoff;
}

async function refreshMap() {
  if(!map || !window.google || !google.maps) return;

  const cat = document.getElementById('mapCategory')?.value || 'all';
  const per = document.getElementById('mapPeriod')?.value || 'all';

  const items = await loadIncidents();

  // Only incidents that have coordinates can be shown
  const filtered = items.filter(i => {
    const okCoords = typeof i.lat === 'number' && typeof i.lng === 'number';
    if(!okCoords) return false;
    const okCat = (cat === 'all') ? true : String(i.category || i.type || 'other') === cat;
    const okPer = withinDays(i.createdAt || i.date || i.when, per);
    return okCat && okPer;
  });

  clearMarkers();

  const bounds = new google.maps.LatLngBounds();

  filtered.forEach(i => {
    const pos = { lat: i.lat, lng: i.lng };
    bounds.extend(pos);

    const m = new google.maps.Marker({
      position: pos,
      map,
      title: (i.title || i.category || 'Incident')
    });

    const info = new google.maps.InfoWindow({
      content:
        '<div style="min-width:220px;">' +
        '<div style="font-weight:800;">' + escapeHtml(i.category || i.type || 'Incident') + '</div>' +
        '<div style="margin-top:4px; color:#6b7280; font-size:12px;">' + escapeHtml(i.createdAt || i.date || '') + '</div>' +
        (i.address ? ('<div style="margin-top:6px; font-size:12px; color:#374151;">' + escapeHtml(i.address) + '</div>') : '') +
        (i.description ? ('<div style="margin-top:8px; font-size:13px;">' + escapeHtml(i.description) + '</div>') : '') +
        '</div>'
    });

    m.addListener('click', () => info.open({ map, anchor: m }));
    markers.push(m);
  });

  // If we have markers, fit bounds; else keep default centre
  if(filtered.length) map.fitBounds(bounds);
}

function fitMap() {
  if(!map || !markers.length) return;
  const bounds = new google.maps.LatLngBounds();
  markers.forEach(m => bounds.extend(m.getPosition()));
  map.fitBounds(bounds);
}

function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

document.addEventListener('DOMContentLoaded', async () => {
  // Dashboard-standard gate:
  // - Tabs/layout remain visible
  // - Protected map card is hidden until user is logged in + approved
  // - Inline notice appears under the header (anwAccessNotice) and disappears automatically when allowed

  const notice = document.getElementById('anwAccessNotice');
  const protectedEls = Array.from(document.querySelectorAll('.anw-protected'));

  const showNotice = (msgHtml) => {
    if(notice){
      notice.style.display = 'block';
      notice.innerHTML = msgHtml;
    }
  };
  const hideNotice = () => { if(notice) notice.style.display = 'none'; };

  const hideProtected = () => protectedEls.forEach(el => { el.style.display = 'none'; });
  const showProtected = () => protectedEls.forEach(el => { el.style.display = ''; });

  const ensureIdentityUser = async () => {
    if(!window.netlifyIdentity) return null;
    return await new Promise((resolve)=>{
      let done=false;
      const finish=(u)=>{ if(done) return; done=true; resolve(u||null); };
      try{
        window.netlifyIdentity.on('init', (u)=>finish(u));
        window.netlifyIdentity.init();
      }catch(e){}
      setTimeout(()=>{
        try{
          const u = window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();
          finish(u);
        }catch(e){ finish(null); }
      }, 300);
    });
  };

  const getRegistryProfile = async (user) => {
    try { await window.anwInitStore?.(); } catch(e){}
    try{
      const users = (window.anwLoad && window.ANW_KEYS) ? window.anwLoad(window.ANW_KEYS.USERS, []) : [];
      const email = String((user && user.email) || '').toLowerCase();
      return (users||[]).find(u => String(u.email||'').toLowerCase() === email) || null;
    }catch(e){
      return null;
    }
  };

  const user = await ensureIdentityUser();
  if(!user){
    hideProtected();
    showNotice('You are not logged in. Please <a href="login.html">log in</a> or <a href="login.html#signup">register</a> to view the incidents map.');
    return;
  }

  const profile = await getRegistryProfile(user);
  if(!profile){
    hideProtected();
    showNotice('Your account is logged in, but you are not registered/approved yet. Please wait for approval.');
    return;
  }

  const status = String(profile.status || profile.accountStatus || '').toLowerCase();
  const approved = (profile.approved === true) || (profile.active === true) || status === 'active' || status === 'approved';
  if(!approved){
    hideProtected();
    showNotice('Your account is not approved yet. Please wait for approval.');
    return;
  }

  // Allowed
  showProtected();
  hideNotice();

  // Wire up controls (avoid "dead" buttons)
  const btnFit = document.getElementById('btnMapFit');
  const btnRefresh = document.getElementById('btnMapRefresh');
  const selCat = document.getElementById('mapCategory');
  const selPer = document.getElementById('mapPeriod');

  if(btnFit) btnFit.addEventListener('click', () => { try{ fitMap(); }catch(e){} });
  if(btnRefresh) btnRefresh.addEventListener('click', () => { try{ refreshMap(); }catch(e){} });
  if(selCat) selCat.addEventListener('change', () => { try{ refreshMap(); }catch(e){} });
  if(selPer) selPer.addEventListener('change', () => { try{ refreshMap(); }catch(e){} });

  // Only load the map once authorised
  loadGoogleMaps();

});
</script>
<div aria-live="polite" aria-modal="true" id="anwAccessOverlay" role="dialog">
<div class="box">
<h3 class="title" id="anwAccessTitle">Private Page</h3>
<p class="msg" id="anwAccessMsg">This page is private.</p>
<div class="actions" id="anwAccessActions"></div>
</div>
</div>
<script src="assets/acl-guard.js"></script>
</body>
</html>
