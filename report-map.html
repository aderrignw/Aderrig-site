<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Map — Aderrig Neighbourhood Watch</title>
  <!-- Keep using the site-wide stylesheet at /style.css -->
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Fallbacks in case your global CSS doesn’t style this page yet */
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin: 12px 0 14px; }
    .toolbar label { display:flex; gap:8px; align-items:center; }
    .toolbar select, .toolbar button { padding: 8px 10px; }
    #map { width: 100%; height: 65vh; min-height: 520px; border-radius: 12px; overflow:hidden; background:#eee; }
    .muted { opacity: .8; }
    .statusline { display:flex; gap:12px; align-items:center; margin: 10px 0; }
  </style>
</head>

<body>
  <!-- Header / nav (same links you already use in the site) -->
  <header class="container">
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
      <div style="font-weight:800;letter-spacing:.5px;">ANW</div>
      <div>
        <div style="font-size:20px;font-weight:700;line-height:1.2;">Aderrig Neighbourhood Watch <span class="muted" style='font-weight:500;'>Adamstown · Community-led · Ireland</span></div>
        <nav style="margin-top:6px;display:flex;gap:14px;flex-wrap:wrap;">
          <a href="/index.html">Home</a>
          <a href="/about.html">About</a>
          <a href="/report-map.html" aria-current="page" style="font-weight:700;text-decoration:underline;">Report</a>
          <a href="/alerts.html">Community Alerts</a>
          <a href="/projects.html">Community Projects</a>
          <a href="/login.html">Login / Register</a>
          <a href="/dashboard.html">Dashboard</a>
          <a href="/admin.html">Admin</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <h2 style="margin: 14px 0 8px;">Report Map</h2>

    <div class="toolbar" role="region" aria-label="Filters">
      <label>
        Category
        <select id="categorySelect">
          <option value="all">All</option>
        </select>
      </label>

      <label>
        Period
        <select id="periodSelect">
          <option value="all">All</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
          <option value="365d">Last 12 months</option>
        </select>
      </label>

      <button id="fitBtn" type="button">Fit</button>
      <button id="refreshBtn" type="button">Refresh</button>
    </div>

    <div class="statusline">
      <div>Loaded <strong id="count">0</strong> incidents.</div>
      <button id="reloadBtn" type="button">Reload</button>
      <div id="msg" class="muted" style="margin-left:auto;"></div>
    </div>

    <div id="map" aria-label="Map"></div>
  </main>

  <script>
    // --- Config helpers ---
    async function fetchConfig() {
      // Your site already calls /config (seen in Network). We'll try that first.
      // Accepts: { GOOGLE_MAPS_API_KEY }, { googleMapsApiKey }, { key }, or plain text.
      const candidates = ["/config", "/.netlify/functions/config"];
      for (const url of candidates) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) continue;

          const ct = (res.headers.get("content-type") || "").toLowerCase();
          if (ct.includes("application/json")) {
            const data = await res.json();
            const key =
              data?.GOOGLE_MAPS_API_KEY ||
              data?.googleMapsApiKey ||
              data?.google_maps_api_key ||
              data?.mapsKey ||
              data?.key;
            if (key) return { mapsKey: key };
          } else {
            const text = (await res.text()).trim();
            if (text && !text.toLowerCase().includes("not found")) return { mapsKey: text };
          }
        } catch (_) {}
      }
      return { mapsKey: null };
    }

    // --- Incidents (Netlify Function store) ---
    async function loadIncidentsFromStore() {
      // store function supports GET /.netlify/functions/store?key=incidents
      const res = await fetch("/.netlify/functions/store?key=incidents", { cache: "no-store" });
      if (!res.ok) throw new Error("store request failed: " + res.status);
      const data = await res.json();

      // Accept either: { key, value } or raw array
      const value = Array.isArray(data) ? data : (data?.value ?? []);
      if (typeof value === "string") {
        try { return JSON.parse(value) || []; } catch { return []; }
      }
      return Array.isArray(value) ? value : [];
    }

    function getLatLng(incident) {
      const lat =
        incident?.lat ?? incident?.latitude ?? incident?.location?.lat ?? incident?.location?.latitude ?? incident?.position?.lat;
      const lng =
        incident?.lng ?? incident?.lon ?? incident?.longitude ?? incident?.location?.lng ?? incident?.location?.lon ?? incident?.location?.longitude ?? incident?.position?.lng;
      if (typeof lat === "number" && typeof lng === "number") return { lat, lng };
      // sometimes stored as strings:
      const latN = Number(lat), lngN = Number(lng);
      if (Number.isFinite(latN) && Number.isFinite(lngN)) return { lat: latN, lng: lngN };
      return null;
    }

    function getCategory(incident) {
      return (incident?.category ?? incident?.type ?? incident?.kind ?? "Uncategorized").toString();
    }

    function getDateMs(incident) {
      const d = incident?.date ?? incident?.createdAt ?? incident?.timestamp ?? incident?.time;
      if (!d) return null;
      const ms = (typeof d === "number") ? d : Date.parse(d);
      return Number.isFinite(ms) ? ms : null;
    }

    // --- Map rendering ---
    let map, markers = [], lastIncidents = [];

    function clearMarkers() {
      for (const m of markers) m.setMap(null);
      markers = [];
    }

    function fitToMarkers() {
      if (!map || markers.length === 0) return;
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds);
    }

    function applyFiltersAndRender() {
      const cat = document.getElementById("categorySelect").value;
      const period = document.getElementById("periodSelect").value;

      const now = Date.now();
      let minMs = null;
      if (period === "7d") minMs = now - 7*24*60*60*1000;
      else if (period === "30d") minMs = now - 30*24*60*60*1000;
      else if (period === "365d") minMs = now - 365*24*60*60*1000;

      const filtered = lastIncidents.filter(i => {
        if (cat !== "all" && getCategory(i) !== cat) return false;
        if (minMs) {
          const ms = getDateMs(i);
          if (ms && ms < minMs) return false;
        }
        return !!getLatLng(i);
      });

      document.getElementById("count").textContent = String(filtered.length);

      clearMarkers();
      for (const inc of filtered) {
        const ll = getLatLng(inc);
        if (!ll) continue;

        const titleParts = [];
        titleParts.push(getCategory(inc));
        const ms = getDateMs(inc);
        if (ms) titleParts.push(new Date(ms).toLocaleString());
        if (inc?.title) titleParts.push(String(inc.title));

        const marker = new google.maps.Marker({
          map,
          position: ll,
          title: titleParts.filter(Boolean).join(" • "),
        });

        const infoHtml = `
          <div style="max-width:260px">
            <div style="font-weight:700;margin-bottom:6px">${escapeHtml(getCategory(inc))}</div>
            ${ms ? `<div class="muted" style="margin-bottom:6px">${escapeHtml(new Date(ms).toLocaleString())}</div>` : ""}
            ${inc?.title ? `<div style="margin-bottom:6px">${escapeHtml(String(inc.title))}</div>` : ""}
            ${inc?.description ? `<div class="muted">${escapeHtml(String(inc.description))}</div>` : ""}
          </div>
        `;
        const info = new google.maps.InfoWindow({ content: infoHtml });
        marker.addListener("click", () => info.open({ map, anchor: marker }));

        markers.push(marker);
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // Google Maps callback
    window.initMap = async function initMap() {
      // Center around Dublin by default
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 53.3498, lng: -6.2603 },
        zoom: 10,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
      });

      await refresh();
    };

    async function refresh() {
      const msg = document.getElementById("msg");
      msg.textContent = "Loading…";
      try {
        lastIncidents = await loadIncidentsFromStore();

        // Fill categories dropdown from data
        const categories = Array.from(new Set(lastIncidents.map(getCategory))).sort((a,b)=>a.localeCompare(b));
        const sel = document.getElementById("categorySelect");
        const current = sel.value || "all";
        sel.innerHTML = '<option value="all">All</option>' + categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
        sel.value = categories.includes(current) ? current : "all";

        applyFiltersAndRender();
        msg.textContent = "";
      } catch (e) {
        console.error(e);
        msg.textContent = "Failed to load incidents.";
      }
    }

    // Wire UI
    document.getElementById("refreshBtn").addEventListener("click", refresh);
    document.getElementById("reloadBtn").addEventListener("click", refresh);
    document.getElementById("fitBtn").addEventListener("click", fitToMarkers);
    document.getElementById("categorySelect").addEventListener("change", applyFiltersAndRender);
    document.getElementById("periodSelect").addEventListener("change", applyFiltersAndRender);

    // Boot: load config, then load Google Maps script
    (async () => {
      const { mapsKey } = await fetchConfig();
      if (!mapsKey) {
        document.getElementById("msg").textContent = "Missing GOOGLE_MAPS_API_KEY.";
        return;
      }

      const s = document.createElement("script");
      const params = new URLSearchParams({
        key: mapsKey,
        v: "weekly",
        callback: "initMap",
        loading: "async",
      });
      s.src = "https://maps.googleapis.com/maps/api/js?" + params.toString();
      s.async = true;
      s.defer = true;
      s.onerror = () => { document.getElementById("msg").textContent = "Failed to load Google Maps."; };
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
