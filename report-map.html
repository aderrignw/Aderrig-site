<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aderrig Neighbourhood Watch — Report</title>

  <!-- CSS PRINCIPAL (CORRETO) -->
  <link rel="stylesheet" href="/assets/style.css">

  <!-- CSS DE SEGURANÇA (caso o principal falhe) -->
  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f6f7f8; }
    .container { max-width:1200px; margin:0 auto; padding:16px; }
    header { margin-bottom:16px; }
    nav a { margin-right:12px; text-decoration:none; color:#0b5; font-weight:500; }
    .toolbar { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
    select, button { padding:8px 10px; }
    #map { width:100%; height:70vh; min-height:420px; background:#e5e5e5; border-radius:12px; }
    .status { margin:10px 0; }
  </style>
</head>

<body>
<div class="container">

<header>
  <strong>ANW</strong><br>
  <strong>Aderrig Neighbourhood Watch</strong> Adamstown · Community-led · Ireland
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="report-map.html">Report</a>
    <a href="alerts.html">Community Alerts</a>
    <a href="projects.html">Community Projects</a>
    <a href="login.html">Login / Register</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<div class="toolbar">
  <label>Category
    <select id="category">
      <option value="all">All</option>
    </select>
  </label>

  <label>Period
    <select id="period">
      <option value="all">All</option>
      <option value="24h">Last 24h</option>
      <option value="7d">Last 7 days</option>
      <option value="30d">Last 30 days</option>
    </select>
  </label>

  <button id="btnFit">Fit</button>
  <button id="btnRefresh">Refresh</button>
</div>

<div class="status">
  Loaded <span id="count">0</span> incidents.
  <button id="btnReload">Reload</button>
</div>

<div id="map"></div>

</div>

<script>
let map, markers = [], infoWindow;

function loadGoogleMaps(apiKey){
  return new Promise((resolve, reject)=>{
    if(window.google && window.google.maps) return resolve();
    const s = document.createElement("script");
    s.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&v=weekly`;
    s.async = true;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function init(){
  try{
    const r = await fetch("/.netlify/functions/config");
    const cfg = await r.json();
    const apiKey = cfg.apiKey || cfg.GOOGLE_MAPS_API_KEY;
    await loadGoogleMaps(apiKey);

    map = new google.maps.Map(document.getElementById("map"), {
      center:{lat:53.3498,lng:-6.2603},
      zoom:11
    });

    infoWindow = new google.maps.InfoWindow();
    loadIncidents();
  }catch(e){
    console.error(e);
  }
}

async function loadIncidents(){
  const r = await fetch("/.netlify/functions/store?key=incidents");
  const j = await r.json();
  const data = Array.isArray(j.value) ? j.value : [];
  document.getElementById("count").textContent = data.length;

  markers.forEach(m=>m.setMap(null));
  markers = [];

  const bounds = new google.maps.LatLngBounds();

  data.forEach(x=>{
    if(!x.lat || !x.lng) return;
    const m = new google.maps.Marker({
      position:{lat:+x.lat,lng:+x.lng},
      map
    });
    markers.push(m);
    bounds.extend(m.getPosition());
  });

  if(markers.length) map.fitBounds(bounds);
}

document.getElementById("btnReload").onclick = init;
document.getElementById("btnRefresh").onclick = loadIncidents;
document.getElementById("btnFit").onclick = ()=>{
  if(!markers.length) return;
  const b = new google.maps.LatLngBounds();
  markers.forEach(m=>b.extend(m.getPosition()));
  map.fitBounds(b);
};

init();
</script>
</body>
</html>
