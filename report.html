<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report — Aderrig Neighbourhood Watch</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* Keep report sub-tabs aligned like other pages */
    .report-tabs{ display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-start; }
    .report-tabs .btn{ flex:0 0 auto; margin:0; }
    button.btn, button.btn-line{ font: inherit; }
    button.btn-line{ background:transparent; border:1px solid rgba(46,125,80,0.45); color:#2e7d50; }
    button.btn-line:hover{ border-color: rgba(46,125,80,0.75); }
    button.btn-line:active{ transform: translateY(1px); }
  </style>
</head>

<body>

<header class="site-header">
  <div class="brand">
    <div class="logo">ANW</div>
    <div class="brand-text">
      <h1>Aderrig Neighbourhood Watch</h1>
      <p class="muted">Adamstown · Community-led · Ireland</p>
    </div>
  </div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="report.html" class="active">Report</a>
    <a href="alerts.html">Community Alerts</a>
    <a href="projects.html">Community Projects</a>
    <a href="login.html">Login / Register</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="household.html">Household</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main class="wrap">
  <section class="card">
    <h2>Report an incident</h2>
    <p class="muted tiny">
      Use this form to record an incident and prepare a message you can send to Garda&iacute; with your own email.
      The website stores only the <strong>text</strong> you enter so you can track status.
    </p>

    <!-- Sub-tabs (match Report-map) -->
    <div class="actions report-tabs" style="gap:0.5rem; margin-top:0.75rem;">
      <button type="button" class="btn btn-line report-tab active" data-tab="tabNew">Report incident</button>
      <button type="button" class="btn btn-line report-tab" data-tab="tabStatus">My reports status</button>
      <button type="button" class="btn btn-line" onclick="window.location.href='report-map.html'">Incidents map</button>
    </div>
  </section>

  <!-- ================= NEW REPORT ================= -->
  <section class="card report-panel" id="tabNew">
    <h3>Incident details</h3>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="field">
        <label>Date</label>
        <input id="rDate" type="date" />
      </div>
      <div class="field">
        <label>Time</label>
        <input id="rTime" type="time" />
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="field">
        <label>Category</label>
        <select id="rCategory">
          <option value="">Select…</option>
          <option>Suspicious activity</option>
          <option>Burglary / attempted burglary</option>
          <option>Damage / vandalism</option>
          <option>Anti-social behaviour</option>
          <option>Theft / vehicle related</option>
          <option>Other</option>
        </select>
      </div>
      <div class="field">
        <label>Location (street / area)</label>
        <input id="rLocation" type="text" placeholder="e.g., Aderrig Green (near playground)" />
      </div>
    </div>

    <div class="field">
      <label>What happened? (description)</label>
      <textarea id="rDesc" rows="6" placeholder="Describe what you saw/heard. Include any vehicle description, direction of travel, number of people, etc."></textarea>
      <p class="tiny muted" style="margin:0.4rem 0 0;">
        Tip: Don’t include sensitive personal data. If you have photos/videos, attach them directly in your email to Garda&iacute;.
      </p>
    </div>

    <h3 style="margin-top:1rem;">Your details (optional)</h3>
    <p class="tiny muted" style="margin-top:0;">
      If you are logged in, we will use your account email automatically.
    </p>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="field">
        <label>Your name</label>
        <input id="rName" type="text" placeholder="Optional" />
      </div>
      <div class="field">
        <label>Your email</label>
        <input id="rEmail" type="email" placeholder="Optional (or login)" />
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="field">
        <label>Your phone</label>
        <input id="rPhone" type="tel" placeholder="Optional" />
      </div>
      <div class="field">
        <label>Garda station email (optional)</label>
        <input id="rGarda" type="email" placeholder="e.g., lucan.garda@…" />
      </div>
    </div>

    <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
      <button type="button" class="btn btn-line" id="btnPreview">Preview email</button>
      <button type="button" class="btn" id="btnSubmit">Save report</button>
    </div>

    <div id="rMsg" class="msg"></div>

    <div id="previewBlock" class="card" style="display:none; background:#f9fafb; margin-top:0.75rem;">
      <h3 style="margin-top:0;">Email preview</h3>
      <p class="tiny muted" style="margin-top:0;">
        Use <strong>Copy</strong> or <strong>Open email</strong> to send with your own email client.
      </p>
      <div class="field">
        <label>Subject</label>
        <input id="pSubject" type="text" readonly />
      </div>
      <div class="field">
        <label>Body</label>
        <textarea id="pBody" rows="10" readonly></textarea>
      </div>
      <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
        <button type="button" class="btn btn-line" id="btnCopy">Copy</button>
        <button type="button" class="btn" id="btnMailto">Open email</button>
      </div>
      <p id="copyMsg" class="tiny muted" style="margin:0.5rem 0 0;"></p>
    </div>
  </section>

  <!-- ================= STATUS ================= -->
  <section class="card report-panel" id="tabStatus" style="display:none;">
    <h3>My reports status</h3>
    <p class="tiny muted" style="margin-top:0;">
      Shows reports created with your account email. If you’re not logged in, enter your email below.
    </p>

    <div class="actions" style="justify-content:flex-start; gap:0.5rem; flex-wrap:wrap;">
      <div class="field" style="min-width:260px; margin:0;">
        <label class="tiny muted">Email to search</label>
        <input id="sEmail" type="email" placeholder="your@email.com" />
      </div>
      <div style="display:flex; gap:0.5rem; align-items:flex-end;">
        <button type="button" class="btn" id="btnSearch">Search</button>
        <button type="button" class="btn btn-line" id="btnRefresh">Refresh</button>
      </div>
    </div>

    <div id="statusMsg" class="tiny muted" style="margin-top:0.5rem;"></div>

    <div style="overflow-x:auto; margin-top:0.75rem;">
      <table style="width:100%;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Category</th>
            <th>Location</th>
            <th>Status</th>
            <th style="width:160px;">Actions</th>
          </tr>
        </thead>
        <tbody id="statusBody"></tbody>
      </table>
    </div>
    <p id="statusEmpty" class="tiny muted" style="display:none; margin-top:0.5rem;">No reports found.</p>
  </section>

</main>

<footer>
  <div style="text-align:center;">
    © 2025 Aderrig NW · All rights reserved · <a href="privacy.html">Privacy Policy</a>
  </div>
</footer>

<script src="assets/app-core.js"></script>
<script>

(async function(){
  await anwInitStore();
  'use strict';

  const KEY_INCIDENTS = ANW_KEYS.INCIDENTS;
  const KEY_USERS = ANW_KEYS.USERS;

  function loadIncidents(){ return anwLoad(KEY_INCIDENTS, []); }
  function saveIncidents(list){ return anwSave(KEY_INCIDENTS, list); }
  function loadUsers(){ return anwLoad(KEY_USERS, []); }

  
  async function geocodeLocation(locationText){
    const q = (locationText || '').trim();
    if(!q) return null;
    try{
      const r = await fetch('/.netlify/functions/geocode?q=' + encodeURIComponent(q), { headers:{'accept':'application/json'} });
      const j = await r.json().catch(()=>null);
      if(j && j.ok && typeof j.lat === 'number' && typeof j.lng === 'number'){
        return { lat: j.lat, lng: j.lng, formatted_address: j.formatted_address || q };
      }
      return null;
    }catch(_){
      return null;
    }
  }
function nowISO(){ return new Date().toISOString(); }

  function genId(list){
    let max = 0;
    (list||[]).forEach(r=>{
      const n = parseInt(String(r.id||'').replace(/\D/g,''),10);
      if(!isNaN(n)) max = Math.max(max, n);
    });
    return 'RPT-' + String(max+1).padStart(4,'0');
  }

  function escapeNL(s){ return String(s||'').replace(/\r\n/g,'\n'); }

  function buildEmailPayload(report){
    const subj = `ANW Incident report ${report.id} — ${report.category || 'Incident'}`;
    const lines = [
      'Aderrig Neighbourhood Watch — Incident report',
      '',
      `Report ID: ${report.id}`,
      `Date/Time: ${report.date || '—'} ${report.time || ''}`.trim(),
      `Category: ${report.category || '—'}`,
      `Location: ${report.location || '—'}`,
      '',
      'Description:',
      report.description || '—',
      '',
      'Reporter (optional):',
      `Name: ${report.reporterName || '—'}`,
      `Email: ${report.reporterEmail || '—'}`,
      `Phone: ${report.reporterPhone || '—'}`,
      '',
      'Note: If you have photos/videos, please attach them to this email.'
    ];
    return { subject: subj, body: lines.join('\n') };
  }

  // ---------------- Tabs ----------------
  const tabBtns = document.querySelectorAll('.report-tab');
  const panels = document.querySelectorAll('.report-panel');
  function showTab(id){
    tabBtns.forEach(b=> b.classList.toggle('active', b.dataset.tab === id));
    panels.forEach(p=> p.style.display = (p.id === id ? 'block' : 'none'));
    if(id === 'tabStatus') renderStatus();
  }
  tabBtns.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

  // Deep link
  if(String(location.hash||'') === '#status') showTab('tabStatus');

  // ---------------- Prefill from session/user ----------------
  const loggedEmail = anwGetLoggedEmail();
  const users = loadUsers();
  const me = users.find(u => anwNormEmail(u.email) === loggedEmail) || null;
  if(me){
    document.getElementById('rName').value = me.name || '';
    document.getElementById('rEmail').value = me.email || '';
    document.getElementById('rPhone').value = me.phone || '';
    document.getElementById('sEmail').value = me.email || '';
  } else if(loggedEmail){
    document.getElementById('rEmail').value = loggedEmail;
    document.getElementById('sEmail').value = loggedEmail;
  }

  // default date/time
  const d = new Date();
  document.getElementById('rDate').value = d.toISOString().slice(0,10);
  document.getElementById('rTime').value = d.toTimeString().slice(0,5);

  // ---------------- Preview ----------------
  const previewBlock = document.getElementById('previewBlock');
  const pSubject = document.getElementById('pSubject');
  const pBody = document.getElementById('pBody');
  const copyMsg = document.getElementById('copyMsg');

  function readForm(){
    return {
      date: document.getElementById('rDate').value,
      time: document.getElementById('rTime').value,
      category: document.getElementById('rCategory').value,
      location: document.getElementById('rLocation').value.trim(),
      description: escapeNL(document.getElementById('rDesc').value.trim()),
      reporterName: document.getElementById('rName').value.trim(),
      reporterEmail: anwNormEmail(document.getElementById('rEmail').value),
      reporterPhone: document.getElementById('rPhone').value.trim(),
      gardaEmail: anwNormEmail(document.getElementById('rGarda').value)
    };
  }

  function validate(form){
    if(!form.date) return 'Please select a date.';
    if(!form.category) return 'Please choose a category.';
    if(!form.location) return 'Please enter a location.';
    if(!form.description) return 'Please describe what happened.';
    return '';
  }

  function updatePreview(tmpReport){
    const payload = buildEmailPayload(tmpReport);
    pSubject.value = payload.subject;
    pBody.value = payload.body;
    previewBlock.style.display = 'block';
    copyMsg.textContent = '';
  }

  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const form = readForm();
    const err = validate(form);
    if(err){
      document.getElementById('rMsg').textContent = err;
      document.getElementById('rMsg').className = 'msg err';
      return;
    }
    const tmp = Object.assign({ id: 'RPT-XXXX' }, form);
    updatePreview(tmp);
    document.getElementById('rMsg').textContent = '';
  });

  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(`Subject: ${pSubject.value}\n\n${pBody.value}`);
      copyMsg.textContent = 'Copied to clipboard.';
    }catch(e){
      copyMsg.textContent = 'Copy failed in this browser. You can select and copy manually.';
    }
  });

  document.getElementById('btnMailto').addEventListener('click', ()=>{
    const to = anwNormEmail(document.getElementById('rGarda').value) || '';
    const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(pSubject.value)}&body=${encodeURIComponent(pBody.value)}`;
    window.location.href = url;
  });

  // ---------------- Submit ----------------
  document.getElementById('btnSubmit').addEventListener('click', async ()=>{
    const form = readForm();
    const err = validate(form);
    if(err){
      document.getElementById('rMsg').textContent = err;
      document.getElementById('rMsg').className = 'msg err';
      return;
    }

    const incidents = loadIncidents();
    const id = genId(incidents);
    const report = Object.assign({}, form, {
      id,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      status: 'submitted'
    });

    // Attach coordinates automatically (so Report Map can place the pin)
    const geo = await geocodeLocation(report.location);
    if(geo){
      report.lat = geo.lat;
      report.lng = geo.lng;
      report.location = geo.formatted_address || report.location;
    }

    incidents.unshift(report);
    const ok = await saveIncidents(incidents);

    if(!ok){
      document.getElementById('rMsg').textContent = 'Could not save right now. Please try again.';
      document.getElementById('rMsg').className = 'msg err';
      return;
    }

    // Update preview with real ID
    updatePreview(report);

    document.getElementById('rMsg').textContent = `Saved. Your report ID is ${id}.`;
    document.getElementById('rMsg').className = 'msg ok';

    // Encourage status view
    renderStatus();
  });

  // ---------------- Status ----------------
  const statusBody = document.getElementById('statusBody');
  const statusEmpty = document.getElementById('statusEmpty');
  const statusMsg = document.getElementById('statusMsg');

  function fmtDate(iso){
    const s = String(iso||'');
    return s ? s.slice(0,10) : '—';
  }

  function renderStatus(){
    const incidents = loadIncidents();
    const email = anwNormEmail(document.getElementById('sEmail').value) || loggedEmail;
    const list = incidents.filter(r => anwNormEmail(r.reporterEmail) === anwNormEmail(email));

    statusBody.innerHTML = '';
    if(!email){
      statusMsg.textContent = 'Enter an email or login to see your reports.';
    }else{
      statusMsg.textContent = `Showing ${list.length} report(s) for ${email || '—'}.`;
    }

    if(!list.length){
      statusEmpty.style.display = 'block';
      return;
    }
    statusEmpty.style.display = 'none';

    list.sort((a,b)=> String(b.createdAt||'').localeCompare(String(a.createdAt||'')));
    list.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.date || fmtDate(r.createdAt)}</td>
        <td>${r.category || '—'}</td>
        <td>${r.location || '—'}</td>
        <td>${String(r.status||'submitted')}</td>
        <td>
          <button type="button" class="btn-line small" data-act="view" data-id="${r.id}">View</button>
          <button type="button" class="btn-line small" data-act="copy" data-id="${r.id}" style="margin-left:6px;">Copy email</button>
        </td>
      `;
      statusBody.appendChild(tr);
    });
  }

  statusBody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const incidents = loadIncidents();
    const r = incidents.find(x => x.id === id);
    if(!r) return;
    const payload = buildEmailPayload(r);

    if(act === 'view'){
      showTab('tabNew');
      document.getElementById('rMsg').textContent = `Loaded ${id} in preview (read-only).`;
      document.getElementById('rMsg').className = 'msg ok';
      pSubject.value = payload.subject;
      pBody.value = payload.body;
      previewBlock.style.display = 'block';
      copyMsg.textContent = '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    if(act === 'copy'){
      try{
        await navigator.clipboard.writeText(`Subject: ${payload.subject}\n\n${payload.body}`);
        statusMsg.textContent = `Copied email for ${id}.`;
      }catch(err){
        statusMsg.textContent = `Copy failed for ${id}.`;
      }
    }
  });

  document.getElementById('btnSearch').addEventListener('click', ()=> renderStatus());
  document.getElementById('btnRefresh').addEventListener('click', async ()=>{
    // Re-init store to refresh cache from KV
    await anwInitStore();
    renderStatus();
  });

  // initial render if status tab
  if(String(location.hash||'') === '#status') renderStatus();
})();

</script>

</body>
</html>
