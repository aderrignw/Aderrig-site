<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="page:report" name="anw-acl-key"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- Auth pre-check disabled (temporary public mode) -->
<script>
  (function(){
    try { document.documentElement.classList.remove('anw-preauth-hide'); } catch (_) {}
  })();
</script>
<title>Report — Aderrig Neighbourhood Watch</title>
<link href="assets/style.css" rel="stylesheet"/>
<style id="page-access-style">
  /* Public/Private indicator aligned to the same container as the footer (like Home) */
  .site-footer{ position: relative; text-align: center; }
  .site-footer .page-access{ position:absolute; left:0; color:green; font-weight:normal; }
</style>
<style id="anw-access-overlay-style">
  #anwAccessOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.35);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  #anwAccessOverlay .box{
    background:#fff; border-radius:12px; padding:18px 18px; max-width:520px; width:92%;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  #anwAccessOverlay .title{ font-size:1.1rem; margin:0 0 8px 0; }
  #anwAccessOverlay .msg{ margin:0 0 14px 0; line-height:1.35; }
  #anwAccessOverlay .actions{ display:flex; gap:10px; justify-content:flex-end; }
  #anwAccessOverlay a.btn, #anwAccessOverlay button.btn{
    display:inline-block; padding:10px 12px; border-radius:10px; border:0; cursor:pointer;
    text-decoration:none;
  }
  #anwAccessOverlay a.btn-primary, #anwAccessOverlay button.btn-primary{ background:#111; color:#fff; }
  #anwAccessOverlay a.btn-ghost, #anwAccessOverlay button.btn-ghost{ background:#eee; color:#111; }
</style>
<style id="anw-dashboard-gate-style">
  body.anw-locked .report-panel { display:none; }
  body.anw-locked .map-panel { display:none; }
</style>
</head>
<body>
<header class="site-header">
<div class="brand">
<a class="site-logo" href="index.html"><img alt="Aderrig Neighbourhood Watch" class="logo-img" src="assets/logo/logo.png"/></a>
<div class="brand-text">
<h1>Aderrig NW</h1>
<p class="muted">Adamstown</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a class="active" href="report.html">Report</a>
<a href="alerts.html">Community Alerts</a>
<a href="projects.html">Community Projects</a>
<a href="handbook.html">Handbook</a>
<a href="login.html">Login / Register</a>
<a href="dashboard.html">Dashboard</a>
<a href="household.html">Household</a>
<a href="admin.html">Admin</a>
</nav>
</header>
<main class="wrap">
<section class="card">
<h2>Report an incident</h2>
<p class="muted tiny">
      Use this form to record an incident and prepare a message you can send to Gardaí with your own email.
      The website stores only the <strong>text</strong> you enter so you can track status.
    </p>
<div class="tiny muted" id="anwAccessNotice" style="margin-top:12px; display:none;">
      You are not logged in. Please <a href="login.html">log in</a> or <a href="login.html#signup">register</a> to continue.
    </div>
<!-- Sub-tabs (match Report-map) -->
<div class="actions" style="gap:0.5rem; justify-content:flex-start; flex-wrap:wrap; margin-top:0.75rem;">
<button class="btn btn-line" id="btnTabReport" type="button">Report incident</button>
<button class="btn btn-line" id="btnTabStatus" type="button">My reports status</button>
<button class="btn btn-line" id="btnTabMap" onclick="window.location.href='report-map.html'" type="button">Incidents map</button>
</div>
</section>
<!-- ================= NEW REPORT ================= -->
<section class="card report-panel" id="tabNew">
<h3>Incident details</h3>
<div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
<div class="field">
<label>Date</label>
<input id="rDate" type="date"/>
</div>
<div class="field">
<label>Time</label>
<input id="rTime" type="time"/>
</div>
</div>
<div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
<div class="field">
<label>Category</label>
<select id="rCategory">
<option value="">Select…</option>
<option>Suspicious activity</option>
<option>Burglary / attempted burglary</option>
<option>Damage / vandalism</option>
<option>Anti-social behaviour</option>
<option>Theft / vehicle related</option>
<option>Other</option>
</select>
</div>
<div class="field">
<label>Location (street / area)</label>
<input id="rLocation" placeholder="e.g., Aderrig Green (near playground)" type="text"/>
</div>
</div>
<div class="field">
<label>What happened? (description)</label>
<textarea id="rDesc" placeholder="Describe what you saw/heard. Include any vehicle description, direction of travel, number of people, etc." rows="6"></textarea>
<p class="tiny muted" style="margin:0.4rem 0 0;">
        Tip: Don’t include sensitive personal data. If you have photos/videos, attach them directly in your email to Gardaí.
      </p>
        <label for="rFiles">Attachments (photos/videos)</label>
        <input id="rFiles" type="file" multiple accept="image/*,video/*,.pdf,.doc,.docx,.heic" />
        <p class="help">You can add multiple files. Files are only sent as email attachments (not stored on the website) — the site keeps only the filenames in the report.</p>

</div>
<h3 style="margin-top:1rem;">Your details (optional)</h3>
<p class="tiny muted" style="margin-top:0;">
      If you are logged in, we will use your account email automatically.
    </p>
<div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
<div class="field">
<label>Your name</label>
<input id="rName" placeholder="Optional" type="text"/>
</div>
<div class="field">
<label>Your email</label>
<input id="rEmail" placeholder="Optional (or login)" type="email"/>
</div>
</div>
<div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem;">
<div class="field">
<label>Your phone</label>
<input id="rPhone" placeholder="Optional" type="tel"/>
</div>
<div class="field">
<label>Garda station email (optional)</label>
<input id="rGarda" placeholder="e.g., lucan.garda@…" type="email"/>
</div>
</div>
<div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
<button class="btn btn-line" id="btnPreview" type="button">Preview email</button>
<button class="btn" id="btnSubmit" type="button">Save report</button>
</div>
<div class="msg" id="rMsg"></div>
<div class="card" id="previewBlock" style="display:none; background:#f9fafb; margin-top:0.75rem;">
<h3 style="margin-top:0;">Email preview</h3>
<p class="tiny muted" style="margin-top:0;">
        Use <strong>Copy</strong> or <strong>Open email</strong> to send with your own email client.
      </p>
<div class="field">
<label>Subject</label>
<input id="pSubject" readonly="" type="text"/>
</div>
<div class="field">
<label>Body</label>
<textarea id="pBody" readonly="" rows="10"></textarea>
</div>
<div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
<button class="btn btn-line" id="btnCopy" type="button">Copy</button>
<button class="btn" id="btnSendEmail" type="button">Send email (with attachments)</button>
<button class="btn" id="btnMailto" type="button">Open email</button>
</div>
<p class="tiny muted" id="copyMsg" style="margin:0.5rem 0 0;"></p>
</div>
</section>
<!-- ================= STATUS ================= -->
<section class="card report-panel" id="tabStatus" style="display:none;">
<h3>My reports status</h3>
<p class="tiny muted" style="margin-top:0;">
      Shows reports created with your account email.
    </p>
<div class="actions" style="justify-content:flex-start; gap:0.5rem; flex-wrap:wrap;">
<div class="field" style="min-width:260px; margin:0;">
<label class="tiny muted">Email to search</label>
<input id="sEmail" placeholder="your@email.com" type="email"/>
</div>
<div style="display:flex; gap:0.5rem; align-items:flex-end;">
<button class="btn" id="btnSearch" type="button">Search</button>
<button class="btn btn-line" id="btnRefresh" type="button">Refresh</button>
</div>
</div>
<div class="tiny muted" id="statusMsg" style="margin-top:0.5rem;"></div>
<div style="overflow-x:auto; margin-top:0.75rem;">
<table style="width:100%;">
<thead>
<tr>
<th>ID</th>
<th>Date</th>
<th>Category</th>
<th>Location</th>
<th>Status</th>
<th style="width:160px;">Actions</th>
</tr>
</thead>
<tbody id="statusBody"></tbody>
</table>
</div>
<p class="tiny muted" id="statusEmpty" style="display:none; margin-top:0.5rem;">No reports found.</p>
</section>
</main>
<footer class="site-footer">
  <div class="footer-row">
    <div class="footer-left">
      <span class="page-status">Private Page</span>
    </div>

    <div class="footer-center">
      © 2025 Aderrig NW · 
      <a href="privacy.html">Privacy Policy</a>
    </div>
  </div>
</footer>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><script src="assets/identity.js"></script><script src="assets/app-core.js"></script>
<script>
(async function(){
  'use strict';

  

  // --- Access control helpers (no auto-redirect) ---
  const anwShowAccessOverlay = (msg, actionsHtml) => {
    // Dashboard-style: keep layout visible, show inline notice under header, and disable protected panels
    document.body.classList.add('anw-locked');
    const n = document.getElementById('anwAccessNotice');
    if(n){
      n.style.display = 'block';
      // keep message simple + links (ignore actionsHtml to avoid inline onclick)
      n.innerHTML = `${msg} <a href="login.html">Log in</a> or <a href="login.html#signup">Register</a>.`;
    }
    const ov = document.getElementById('anwAccessOverlay');
    if(ov) ov.style.display = 'none';
  };

  const anwEnsureIdentityUser = async () => {
    if(!window.netlifyIdentity) return null;
    return await new Promise((resolve) => {
      let done = false;
      const finish = (u) => { if(done) return; done = true; resolve(u || null); };
      try {
        window.netlifyIdentity.on('init', (u) => finish(u));
        window.netlifyIdentity.init();
      } catch(_) {}
      setTimeout(() => {
        const u = (typeof window.netlifyIdentity.currentUser === 'function') ? window.netlifyIdentity.currentUser() : null;
        finish(u);
      }, 300);
    });
  };

// --- PRIVATE PAGE gate: must be logged in + registered + approved ---
  const returnTo = location.pathname + location.search + location.hash;
  const user = await anwEnsureIdentityUser();
  if(!window.ANW_PUBLIC_MODE && !user){
    try { sessionStorage.setItem('anw_return_to', returnTo); } catch(_) {}
    anwShowAccessOverlay(
      'This page is private. Please log in to continue.',
      `<a class="btn btn-primary" href="login.html" onclick="try{sessionStorage.setItem('anw_return_to','${returnTo.replace("'","\'")}')}catch(_){}">Log in</a>
       <a class="btn btn-ghost" href="index.html">Go to Home</a>`
    );
    return;
  }


  try { await anwInitStore(); } catch(e) { /* store init failed (offline/local). */ }
// --- UI helpers (site-style modal/toast) ---
  function anwToast(msg, type) {
    try {
      if (window.ANW && ANW.ui && typeof ANW.ui.toast === 'function') {
        ANW.ui.toast(String(msg || ''), type || 'info');
        return;
      }
    } catch {}
    // fallback: alert is overridden by app-core.js to the site modal
    if (type === 'error') alert(String(msg || 'Error'));
  }

  function anwModal(message, title) {
    try {
      if (window.ANW && ANW.ui && typeof ANW.ui.alert === 'function') {
        ANW.ui.alert(String(message || ''), { title: title || 'Message' });
        return;
      }
    } catch {}
    alert(String(message || ''));
  }

  async function anwConfirmModal(message, title) {
    try {
      if (typeof window.anwConfirm === 'function') {
        return await window.anwConfirm(String(message || ''), { title: title || 'Confirm' });
      }
    } catch {}
    return confirm(String(message || ''));
  }

  function anwSetMsg(id, value, type) {
    const el = document.getElementById(id);
    const v = (value === undefined || value === null) ? '' : value;
    const s = (typeof v === 'string') ? v : String(v);
    if (el) el.textContent = s;

    const trimmed = s.trim();
    if (!trimmed) return;

    // Use toast for normal feedback, modal for validation/errors
    if (type === 'error') {
      anwToast(trimmed, 'error');
      anwModal(trimmed, 'Error');
    } else if (type === 'warn') {
      anwToast(trimmed, 'warn');
    } else if (type) {
      anwToast(trimmed, type);
    } else {
      anwToast(trimmed, 'info');
    }
  }

  const KEY_INCIDENTS = ANW_KEYS.INCIDENTS;
  const KEY_USERS = ANW_KEYS.USERS;

  function loadIncidents(){ return anwLoad(KEY_INCIDENTS, []); }
  function saveIncidents(list){ return anwSave(KEY_INCIDENTS, list); }
  function loadUsers(){ return anwLoad(KEY_USERS, []); }

  async function geocodeLocation(locationText){
    const q = (locationText || '').trim();
    if(!q) return null;
    try{
      const r = await fetch('/.netlify/functions/geocode?q=' + encodeURIComponent(q), { headers:{'accept':'application/json'} });
      const j = await r.json().catch(()=>null);
      if(j && j.ok && typeof j.lat === 'number' && typeof j.lng === 'number'){
        return { lat: j.lat, lng: j.lng, formatted_address: j.formatted_address || q };
      }
      return null;
    }catch(_){
      return null;
    }
  }

  function nowISO(){ return new Date().toISOString(); }

  function genId(list){
    let max = 0;
    (list||[]).forEach(r=>{
      const n = parseInt(String(r.id||'').replace(/\D/g,''),10);
      if(!isNaN(n)) max = Math.max(max, n);
    });
    return 'RPT-' + String(max+1).padStart(4,'0');
  }

  function escapeNL(s){ return String(s||'').replace(/\r\n/g,'\n'); }

  function buildEmailPayload(report){
    const subj = `ANW Incident report ${report.id} — ${report.category || 'Incident'}`;
    const lines = [
      'Aderrig Neighbourhood Watch — Incident report',
      '',
      `Report ID: ${report.id}`,
      `Date/Time: ${report.date || '—'} ${report.time || ''}`.trim(),
      `Category: ${report.category || '—'}`,
      `Location: ${report.location || '—'}`,
      '',
      'Description:',
      report.description || '—',
      '',
      'Reporter (optional):',
      `Name: ${report.reporterName || '—'}`,
      `Email: ${report.reporterEmail || '—'}`,
      `Phone: ${report.reporterPhone || '—'}`,
      '',
      'Attachments (filenames only):',
      ...(report.attachments && report.attachments.length ? report.attachments : ['—']),
      '',
      'Note: Attachments are included automatically when using the “Send email (with attachments)” button.'
    ];
    return { subject: subj, body: lines.join('\n') };
  }

  // ---------------- Tabs ----------------
  const btnTabReport = document.getElementById('btnTabReport');
  const btnTabStatus = document.getElementById('btnTabStatus');
  const btnTabMap = document.getElementById('btnTabMap');
  const panels = document.querySelectorAll('.report-panel');

  function setTabButtons(activeId){
    if(btnTabReport) btnTabReport.classList.toggle('active', activeId === 'tabNew');
    if(btnTabStatus) btnTabStatus.classList.toggle('active', activeId === 'tabStatus');
    if(btnTabMap) btnTabMap.classList.remove('active'); // map is separate page
  }

  function showTab(id){
    setTabButtons(id);
    panels.forEach(p => p.style.display = (p.id === id ? 'block' : 'none'));
    if(id === 'tabStatus') renderStatus();
  }

  if(btnTabReport){
    btnTabReport.addEventListener('click', ()=>{
      if(location.hash) history.replaceState(null, '', location.pathname + location.search);
      showTab('tabNew');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  if(btnTabStatus){
    btnTabStatus.addEventListener('click', ()=>{
      location.hash = '#status';
      showTab('tabStatus');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  if(String(location.hash||'') === '#status') {
    showTab('tabStatus');
  } else {
    showTab('tabNew');
  }

  // ---------------- Prefill from session/user ----------------
  const loggedEmail = anwGetLoggedEmail();
  const users = loadUsers();
  const me = users.find(u => anwNormEmail(u.email) === loggedEmail) || null;

  // Registry / approval enforcement (no auto-redirect)
  if(!me){
    anwShowAccessOverlay(
      'This page is private. Your account is logged in, but you are not registered/approved for the residents area yet.',
      `<a class="btn btn-ghost" href="index.html">Go to Home</a>`
    );
    return;
  }
  const status = String(me.status || me.accountStatus || '').toLowerCase();
  const approved = (me.approved === true) || (me.active === true) || status === 'active' || status === 'approved';
  if(!approved){
    anwShowAccessOverlay(
      'Your account is not approved yet. Please wait for approval to access Reports.',
      `<a class="btn btn-ghost" href="index.html">Go to Home</a>`
    );
    return;
  }

  
  // Authorized: hide notice and enable panels
  document.body.classList.remove('anw-locked');
  const __n=document.getElementById('anwAccessNotice'); if(__n) __n.style.display='none';
if(me){
    document.getElementById('rName').value = me.name || '';
    document.getElementById('rEmail').value = me.email || '';
    document.getElementById('rPhone').value = me.phone || '';
    document.getElementById('sEmail').value = me.email || '';
  } else if(loggedEmail){
    document.getElementById('rEmail').value = loggedEmail;
    document.getElementById('sEmail').value = loggedEmail;
  }

  

    // Lock email fields to the logged-in account
    const rEmailEl = document.getElementById('rEmail');
    const sEmailEl = document.getElementById('sEmail');
    if(rEmailEl){ rEmailEl.readOnly = true; }
    if(sEmailEl){ sEmailEl.readOnly = true; }

const d = new Date();
  document.getElementById('rDate').value = d.toISOString().slice(0,10);
  document.getElementById('rTime').value = d.toTimeString().slice(0,5);

  // ---------------- Preview ----------------
  const previewBlock = document.getElementById('previewBlock');
  const pSubject = document.getElementById('pSubject');
  const pBody = document.getElementById('pBody');
  const copyMsg = document.getElementById('copyMsg');

  function readForm(){
    return {
      date: document.getElementById('rDate').value,
      time: document.getElementById('rTime').value,
      category: document.getElementById('rCategory').value,
      location: document.getElementById('rLocation').value.trim(),
      description: escapeNL(document.getElementById('rDesc').value.trim()),
      reporterName: document.getElementById('rName').value.trim(),
      reporterEmail: anwNormEmail(document.getElementById('rEmail').value),
      reporterPhone: document.getElementById('rPhone').value.trim(),
      gardaEmail: anwNormEmail(document.getElementById('rGarda').value),
      attachments: Array.from(document.getElementById('rFiles').files || []).map(f => f.name)
    };
  }

  function validate(form){
    if(!form.date) return 'Please select a date.';
    if(!form.category) return 'Please choose a category.';
    if(!form.location) return 'Please enter a location.';
    if(!form.description) return 'Please describe what happened.';
    return '';
  }

  function updatePreview(tmpReport){
    const payload = buildEmailPayload(tmpReport);
    pSubject.value = payload.subject;
    pBody.value = payload.body;
    previewBlock.style.display = 'block';
    copyMsg.textContent = '';
  }

  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const form = readForm();
    const err = validate(form);
    if(err){
      anwSetMsg('rMsg', err, 'warn');
      document.getElementById('rMsg').className = 'msg err';
      return;
    }
    const tmp = Object.assign({ id: 'RPT-XXXX' }, form);
    updatePreview(tmp);
    anwSetMsg('rMsg', '', 'info');
  });

  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(`Subject: ${pSubject.value}\n\n${pBody.value}`);
      copyMsg.textContent = 'Copied to clipboard.';
    }catch(e){
      copyMsg.textContent = 'Copy failed in this browser. You can select and copy manually.';
    }
  });

  
  document.getElementById('btnSendEmail').addEventListener('click', async ()=>{
    try{
      const to = anwNormEmail(document.getElementById('rGarda').value) || '';
      if(!to){
        alert('Please enter a recipient email in the Garda/Manager Email field before sending.');
        return;
      }

      const files = Array.from(document.getElementById('rFiles').files || []);
      // Convert to base64 (Resend expects base64 content)
      const attachments = [];
      for(const f of files){
        // Safety: avoid very large files in free plans / browser memory
        const maxBytes = 10 * 1024 * 1024; // 10 MB each
        if(f.size > maxBytes){
          alert(`File too large: ${f.name} (${Math.round(f.size/1024/1024)}MB). Please keep each file under 10MB.`);
          return;
        }
        const b64 = await new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = ()=> resolve(String(reader.result).split(',')[1] || '');
          reader.onerror = ()=> reject(new Error('Failed to read file: ' + f.name));
          reader.readAsDataURL(f);
        });
        attachments.push({ filename: f.name, content: b64 });
      }

      const payload = {
        to,
        subject: pSubject.value,
        text: pBody.value,
        attachments
      };

      const res = await fetch('/.netlify/functions/send-incident-email', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(()=> ({}));
      if(!res.ok){
        const msg = out && (out.error || out.message) ? (out.error || out.message) : 'Failed to send email.';
        alert(msg);
        return;
      }

      alert('Email sent successfully (attachments included).');
    }catch(err){
      console.error(err);
      alert('Error sending email. Check console logs.');
    }
  });

document.getElementById('btnMailto').addEventListener('click', ()=>{
    const to = anwNormEmail(document.getElementById('rGarda').value) || '';
    const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(pSubject.value)}&body=${encodeURIComponent(pBody.value)}`;
    window.location.href = url;
  });

  // ---------------- Submit ----------------
  document.getElementById('btnSubmit').addEventListener('click', async ()=>{
    const form = readForm();
    const err = validate(form);
    if(err){
      anwSetMsg('rMsg', err, 'warn');
      document.getElementById('rMsg').className = 'msg err';
      return;
    }

    const incidents = loadIncidents();
    const id = genId(incidents);
    const report = Object.assign({}, form, {
      id,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      status: 'submitted'
    });

    const geo = await geocodeLocation(report.location);
    if(geo){
      report.lat = geo.lat;
      report.lng = geo.lng;
      report.location = geo.formatted_address || report.location;
    }

    incidents.unshift(report);
    const ok = await saveIncidents(incidents);

    if(!ok){
      anwSetMsg('rMsg', 'Could not save right now. Please try again.', 'error');
      document.getElementById('rMsg').className = 'msg err';
      return;
    }

    updatePreview(report);

    anwSetMsg('rMsg', `Saved. Your report ID is ${id}.`, 'info');
    document.getElementById('rMsg').className = 'msg ok';

    renderStatus();
  });

  // ---------------- Status ----------------
  const statusBody = document.getElementById('statusBody');
  const statusEmpty = document.getElementById('statusEmpty');
  const statusMsg = document.getElementById('statusMsg');

  function fmtDate(iso){
    const s = String(iso||'');
    return s ? s.slice(0,10) : '—';
  }

  function renderStatus(){
    const incidents = loadIncidents();
    const email = anwNormEmail(document.getElementById('sEmail').value) || loggedEmail;
    const list = incidents.filter(r => anwNormEmail(r.reporterEmail) === anwNormEmail(email));

    statusBody.innerHTML = '';
    if(!email){
      statusMsg.textContent = 'Enter an email or login to see your reports.';
    }else{
      statusMsg.textContent = `Showing ${list.length} report(s) for ${email || '—'}.`;
    }

    if(!list.length){
      statusEmpty.style.display = 'block';
      return;
    }
    statusEmpty.style.display = 'none';

    list.sort((a,b)=> String(b.createdAt||'').localeCompare(String(a.createdAt||'')));
    list.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.date || fmtDate(r.createdAt)}</td>
        <td>${r.category || '—'}</td>
        <td>${r.location || '—'}</td>
        <td>${String(r.status||'submitted')}</td>
        <td>
          <button type="button" class="btn btn-line small" data-act="view" data-id="${r.id}">View</button>
          <button type="button" class="btn btn-line small" data-act="copy" data-id="${r.id}" style="margin-left:6px;">Copy email</button>
        </td>
      `;
      statusBody.appendChild(tr);
    });
  }

  statusBody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const incidents = loadIncidents();
    const r = incidents.find(x => x.id === id);
    if(!r) return;
    const payload = buildEmailPayload(r);

    if(act === 'view'){
      showTab('tabNew');
      anwSetMsg('rMsg', `Loaded ${id} in preview (read-only).`, 'info');
      document.getElementById('rMsg').className = 'msg ok';
      pSubject.value = payload.subject;
      pBody.value = payload.body;
      previewBlock.style.display = 'block';
      copyMsg.textContent = '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    if(act === 'copy'){
      try{
        await navigator.clipboard.writeText(`Subject: ${payload.subject}\n\n${payload.body}`);
        statusMsg.textContent = `Copied email for ${id}.`;
        anwToast(`Copied email for ${id}.`, 'success');
      }catch(err){
        statusMsg.textContent = `Copy failed for ${id}.`;
        anwToast(`Copy failed for ${id}.`, 'error');
      }
    }
  });

  document.getElementById('btnSearch').addEventListener('click', ()=> renderStatus());
  document.getElementById('btnRefresh').addEventListener('click', async ()=>{
    await anwInitStore();
    renderStatus();
  });

  if(String(location.hash||'') === '#status') renderStatus();
})();
</script>
<div aria-live="polite" aria-modal="true" id="anwAccessOverlay" role="dialog">
<div class="box">
<h3 class="title" id="anwAccessTitle">Private Page</h3>
<p class="msg" id="anwAccessMsg">This page is private.</p>
<div class="actions" id="anwAccessActions"></div>
</div>
</div>
<script src="assets/acl-guard.js"></script>
</body>
</html>
