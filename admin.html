<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Aderrig NW</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    body{background:#f5f7f6;}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;}
    .card{background:#fff;border:1px solid rgba(17,24,39,.10);border-radius:18px;box-shadow:0 12px 30px rgba(17,24,39,.06);padding:18px;margin-bottom:16px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid rgba(17,24,39,.10);text-align:left;font-size:14px;}
    th{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:#2f7d5b;}
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:rgba(47,125,91,.10);color:#2f7d5b;font-weight:700;font-size:12px;}
    .badge.pending{background:rgba(176,42,55,.10);color:#b02a37;}
    .btn{cursor:pointer}
    .btn.small{padding:6px 10px;border-radius:999px;font-size:13px;}
    .muted{opacity:.75}
    .msg{margin-top:10px}
    .msg.ok{color:#0f5132}
    .msg.err{color:#b02a37}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <a class="site-logo" href="index.html"><img class="logo-img" src="assets/logo/logo.png" alt="Aderrig Neighbourhood Watch" /></a>
      <div class="brand-text">
        <h1>Aderrig NW</h1>
        <p class="muted">Adamstown</p>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="report.html">Report</a>
      <a href="alerts.html">Community Alerts</a>
      <a href="projects.html">Community Projects</a>
      <a href="handbook.html">Handbook</a>
      <a href="login.html">Login / Register</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="household.html">Household</a>
      <a class="active" href="admin.html">Admin</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Admin</h2>
      <p class="muted" style="margin:0;">
        This page manages registrations stored in <code>anw_users</code>.
      </p>
      <div class="row" style="margin-top:12px;justify-content:space-between;">
        <div class="row">
          <button class="btn btn-line small" id="btnRefresh" type="button">Refresh list</button>
          <button class="btn btn-line small" id="btnLogout" type="button">Logout</button>
        </div>
        <div class="muted" id="whoami"></div>
      </div>
      <div class="msg" id="topMsg"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">Registrations</h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Eircode</th>
              <th>Role</th>
              <th>Status</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted" style="margin:10px 0 0 0;font-size:13px;">
        Tip: If you only want to unblock yourself: set your own status to <strong>active</strong>.
      </p>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-row">
      <div class="footer-left">
        <span class="page-status">Private Page</span>
      </div>
      <div class="footer-center">© 2025 Aderrig NW · <a href="privacy.html">Privacy Policy</a></div>
    </div>
  </footer>

  <!-- Identity + core -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="assets/app-core.js"></script>

  <script>
  (async function(){
    const rowsEl = document.getElementById('rows');
    const topMsg = document.getElementById('topMsg');
    const whoami = document.getElementById('whoami');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnLogout = document.getElementById('btnLogout');

    function setMsg(text, kind){
      topMsg.textContent = text || '';
      topMsg.className = 'msg' + (kind ? (' ' + kind) : '');
    }

    function badge(status){
      const st = String(status||'pending').toLowerCase();
      const cls = st === 'active' || st === 'approved' ? '' : ' pending';
      const label = (st === 'active' || st === 'approved') ? 'active' : st;
      return '<span class="badge'+cls+'">'+label+'</span>';
    }

    async function ensureLoggedIn(){
      if(!window.netlifyIdentity){
        setMsg('Netlify Identity not available.', 'err');
        return null;
      }
      // If user is not logged in, show widget
      const current = window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();
      if(current) return current;

      setMsg('Please log in (a Netlify Identity popup will open).', 'err');
      window.netlifyIdentity.open('login');
      return await new Promise(resolve => {
        window.netlifyIdentity.on('login', user => resolve(user));
        setTimeout(()=>resolve(null), 20000);
      });
    }

    async function loadUsers(){
      setMsg('', '');
      rowsEl.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';
      await anwInitStore();
      const users = anwLoad(ANW_KEYS.USERS, []);
      return Array.isArray(users) ? users : [];
    }

    function isAdminRecord(u){
      const role = String(u && (u.role || u.roles || '')).toLowerCase();
      return role.includes('admin') || role.includes('owner');
    }
    function isActive(u){
      const st = String(u && (u.status || 'pending')).toLowerCase();
      return st === 'active' || st === 'approved';
    }

    async function render(){
      const idUser = await ensureLoggedIn();
      if(!idUser){ rowsEl.innerHTML = '<tr><td colspan="6" class="muted">Not logged in.</td></tr>'; return; }

      whoami.textContent = 'Logged in: ' + (idUser.email || '');

      const users = await loadUsers();
      const me = users.find(x => (x.email||'').toLowerCase() === (idUser.email||'').toLowerCase()) || null;

      if(!me){
        setMsg('Your profile record was not found in anw_users. Open /login.html and register once.', 'err');
      } else if(!(isAdminRecord(me) && isActive(me))){
        setMsg('You are logged in, but your anw_users record is not an active admin/owner. Current status: ' + (me.status||'pending'), 'err');
      } else {
        setMsg('Admin access OK.', 'ok');
      }

      rowsEl.innerHTML = '';
      if(!users.length){
        rowsEl.innerHTML = '<tr><td colspan="6" class="muted">No registrations yet.</td></tr>';
        return;
      }

      for(const u of users){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(u.name||'').toString()}</td>
          <td>${(u.email||'').toString()}</td>
          <td>${(u.eircode||'').toString()}</td>
          <td>${(u.role||'resident').toString()}</td>
          <td>${badge(u.status)}</td>
          <td>
            <button class="btn small" data-act="approve">Set active</button>
            <button class="btn btn-line small" data-act="pending">Set pending</button>
            <button class="btn btn-line small" data-act="owner">Make owner</button>
          </td>
        `;
        tr.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const act = btn.getAttribute('data-act');
            const email = (u.email||'').toLowerCase();
            try{
              const latest = await loadUsers();
              const idx = latest.findIndex(x => (x.email||'').toLowerCase() === email);
              if(idx < 0) throw new Error('User not found');
              const next = [...latest];
              const rec = {...next[idx]};
              if(act === 'approve'){ rec.status = 'active'; }
              if(act === 'pending'){ rec.status = 'pending'; }
              if(act === 'owner'){ rec.role = 'owner'; rec.status = 'active'; rec.residentType = rec.residentType || 'Owner'; }
              rec.updatedAt = new Date().toISOString();
              next[idx] = rec;
              await anwSave(ANW_KEYS.USERS, next);
              setMsg('Saved.', 'ok');
              await render();
            }catch(e){
              setMsg('Save failed: ' + (e && e.message ? e.message : String(e)), 'err');
            }
          });
        });
        rowsEl.appendChild(tr);
      }
    }

    btnRefresh.addEventListener('click', ()=>render());
    btnLogout.addEventListener('click', ()=>{
      try{ window.netlifyIdentity.logout(); }catch(e){}
      location.href = 'login.html';
    });

    // auto render
    await render();
  })();
  </script>

  <!-- IMPORTANT:
       We intentionally DO NOT load assets/acl-guard.js on this page while bootstrapping.
       After everything works, we can re-enable ACL guard with proper admin checks. -->
</body>
</html>
