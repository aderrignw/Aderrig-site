<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Aderrig NW</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .msg{margin-top:10px}
    .msg.ok{color:#0f5132}
    .msg.error{color:#b02a37}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:left}
    th{font-size:.85rem;letter-spacing:.02em;color:#1f5c45}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid rgba(17,24,39,.15)}
    .pill.active{background:rgba(15,81,50,.06)}
    .pill.pending{background:rgba(255,193,7,.08)}
    .pill.suspended{background:rgba(176,42,55,.06)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:.85rem}
  </style>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <a class="site-logo" href="index.html"><img class="logo-img" alt="Aderrig Neighbourhood Watch" src="assets/logo/logo.png"></a>
      <div class="brand-text">
        <h1>Aderrig NW</h1>
        <p class="muted">Adamstown</p>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="report.html">Report</a>
      <a href="alerts.html">Community Alerts</a>
      <a href="projects.html">Community Projects</a>
      <a href="handbook.html">Handbook</a>
      <a href="login.html">Login / Register</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="household.html">Household</a>
      <a class="active" href="admin.html">Admin</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Admin</h2>
      <p class="muted">This page manages registrations stored in <code>anw_users</code>.</p>

      <div class="row" style="margin-top:10px;">
        <div class="actions">
          <button class="btn" id="btnRefresh" type="button">Refresh list</button>
          <button class="btn btn-line" id="btnLogout" type="button">Logout</button>
        </div>
        <div class="tiny muted" id="who"></div>
      </div>

      <div class="msg" id="msg"></div>
      <div class="tiny muted" id="hint" style="margin-top:6px;"></div>
    </section>

    <section class="card" style="margin-top:14px;">
      <h3 class="h3">Registrations</h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>NAME</th>
              <th>EMAIL</th>
              <th>EIRCODE</th>
              <th>ROLE</th>
              <th>STATUS</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="muted">No registrations yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

<script>
(function(){
  'use strict';

  const API = '/.netlify/functions/store';
  const KEY = 'anw_users';

  const elMsg = document.getElementById('msg');
  const elRows = document.getElementById('rows');
  const elWho = document.getElementById('who');
  const elHint = document.getElementById('hint');

  function setMsg(text, kind){
    elMsg.textContent = text || '';
    elMsg.className = 'msg' + (kind ? (' ' + kind) : '');
  }

  function pill(status){
    const st = String(status || '').toLowerCase();
    const cls = st === 'active' || st === 'approved' ? 'active' : (st === 'suspended' ? 'suspended' : 'pending');
    return '<span class="pill ' + cls + '">' + (st || 'pending') + '</span>';
  }

  async function ensureIdentity(){
    if(!window.netlifyIdentity) throw new Error('Netlify Identity widget not loaded.');
    try{ window.netlifyIdentity.init(); }catch(e){}
    // Wait for currentUser to be available after init (max 5s)
    const start = Date.now();
    while(Date.now() - start < 5000){
      const u = window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();
      if(u && u.email) return u;
      await new Promise(r=>setTimeout(r, 80));
    }
    return null;
  }

  async function getToken(){
    const u = await ensureIdentity();
    if(!u) return null;
    if(elWho) elWho.textContent = 'Logged in: ' + u.email;
    try{
      // gotrue-js user has jwt()
      if(typeof u.jwt === 'function') return await u.jwt();
    }catch(e){}
    // Fallback: try to read token from user object (older widget)
    return u.token && u.token.access_token ? u.token.access_token : null;
  }

  async function apiGetUsers(){
    const token = await getToken();
    if(!token) throw new Error('Not logged in. Please open /login.html and log in first.');
    const url = API + '?key=' + encodeURIComponent(KEY);
    const res = await fetch(url, {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
    return Array.isArray(data.value) ? data.value : [];
  }

  async function apiSaveUsers(list){
    const token = await getToken();
    if(!token) throw new Error('Not logged in.');
    const url = API + '?key=' + encodeURIComponent(KEY);
    const res = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(list)
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
    return true;
  }

  function render(users){
    const rows = [];
    for(const u of users){
      const email = (u && u.email) ? String(u.email) : '';
      const name = (u && u.name) ? String(u.name) : '';
      const eir = (u && u.eircode) ? String(u.eircode) : '';
      const role = (u && (u.role || u.residentType)) ? String(u.role || u.residentType) : '';
      const status = (u && u.status) ? String(u.status) : 'pending';

      rows.push(
        '<tr>' +
          '<td>' + escapeHtml(name) + '</td>' +
          '<td>' + escapeHtml(email) + '</td>' +
          '<td>' + escapeHtml(eir) + '</td>' +
          '<td>' + escapeHtml(role) + '</td>' +
          '<td>' + pill(status) + '</td>' +
          '<td class="actions">' +
            '<button class="btn btn-line tiny" data-act="approve" data-email="' + encodeAttr(email) + '">Approve</button>' +
            '<button class="btn btn-line tiny" data-act="pending" data-email="' + encodeAttr(email) + '">Pending</button>' +
            '<button class="btn btn-line tiny" data-act="suspend" data-email="' + encodeAttr(email) + '">Suspend</button>' +
          '</td>' +
        '</tr>'
      );
    }
    elRows.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="6" class="muted">No registrations yet.</td></tr>';
  }

  function encodeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function refresh(){
    setMsg('', '');
    elHint.textContent = '';
    try{
      const users = await apiGetUsers();
      render(users);

      // Friendly hint: if the server only returns YOUR record (non-admin),
      // it will be an array of length 1.
      if(users.length === 1){
        elHint.textContent = 'Tip: If you only see 1 record, the server thinks you are not admin yet. But your MASTER record should still be visible here.';
      }
      setMsg('Loaded ' + users.length + ' record(s).', 'ok');
    }catch(e){
      setMsg(e.message || String(e), 'error');
    }
  }

  async function setStatus(email, status){
    setMsg('', '');
    try{
      const users = await apiGetUsers();
      const i = users.findIndex(x => String(x?.email||'').toLowerCase() === String(email||'').toLowerCase());
      if(i < 0) throw new Error('User not found in list: ' + email);
      users[i] = Object.assign({}, users[i], { status: status, updatedAt: new Date().toISOString() });
      await apiSaveUsers(users);
      await refresh();
    }catch(e){
      setMsg(e.message || String(e), 'error');
    }
  }

  document.getElementById('btnRefresh').addEventListener('click', refresh);

  document.getElementById('btnLogout').addEventListener('click', () => {
    try{ window.netlifyIdentity.logout(); }catch(e){}
    location.href = 'login.html';
  });

  elRows.addEventListener('click', (ev) => {
    const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-act]') : null;
    if(!btn) return;
    const act = btn.getAttribute('data-act');
    const email = btn.getAttribute('data-email');
    if(!email) return;

    if(act === 'approve') return setStatus(email, 'active');
    if(act === 'pending') return setStatus(email, 'pending');
    if(act === 'suspend') return setStatus(email, 'suspended');
  });

  // Auto-load
  refresh();
})();
</script>

</body>
</html>
