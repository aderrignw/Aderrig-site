<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel — Aderrig NW</title>
<link rel="stylesheet" href="assets/style.css" />

<style>
  /* keep admin sub-tabs aligned like other site tabs (no justified spacing) */
  .admin-tabs, .resident-tabs {
    display:flex;
    gap:0.5rem;
    flex-wrap:wrap;
    justify-content:flex-start !important;
    align-items:center;
  }
  .admin-tabs .btn, .resident-tabs .btn {
    flex:0 0 auto !important;
    margin:0 !important;
  }

  /* Modal (Resident details) - align with site style */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(10,20,15,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding:24px;
    z-index:9999;
  }
  .modal .modal-content{
    width:min(760px, 100%);
    max-height: calc(100vh - 48px);
    overflow:auto;
    border-radius:18px;
    box-shadow:0 24px 64px rgba(0,0,0,0.25);
  }
  .modal .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  @media (max-width:720px){ .modal .grid-2{ grid-template-columns:1fr; } }
  .modal .field input, .modal .field select{ width:100%; box-sizing:border-box; }

  /* Ensure buttons render the same for <button> and <a> */
  button.btn, button.btn-line{ font: inherit; }

  /* Ensure outlined buttons look like site standard even on <button> */
  button.btn-line{
    background: transparent;
    border: 1px solid rgba(46, 125, 80, 0.45);
    color: #2e7d50;
  }
  button.btn-line:hover{ border-color: rgba(46, 125, 80, 0.75); }
  button.btn-line:active{ transform: translateY(1px); }

  /* --- Admin edit modal polish --- */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 9999;
  }
  .modal.show{ display:flex !important; }
  .modal-content{
    width: min(980px, 96vw);
    max-height: 90vh;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    overflow: hidden;
    border: 1px solid var(--line);
    display:flex;
    flex-direction:column;
  }
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    padding: 18px 18px 14px;
    background: #fff;
    border-bottom: 1px solid var(--line);
  }
  .modal-header h3{
    margin:0;
    font-size: 1.25rem;
  }
  .modal-header .sub{
    margin:6px 0 0;
    color: var(--muted);
    font-size: .92rem;
  }
  .modal-body{
    padding: 16px 18px 8px;
    overflow:auto;
  }
  .modal-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px 18px;
    align-items:start;
  }
  .modal-grid .span-2{ grid-column: 1 / -1; }
  .modal-footer{
    padding: 14px 18px;
    border-top: 1px solid var(--line);
    background: #fff;
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  @media (max-width: 780px){
    .modal-grid{ grid-template-columns: 1fr; }
    .modal-grid .span-2{ grid-column:auto; }
  }

  button.btn-line{
    background: transparent;
    border: 1px solid rgba(46, 125, 80, 0.45);
    color: #2e7d50;
  }
  button.btn-line:hover{ border-color: rgba(46, 125, 80, 0.75); }
  button.btn-line:active{ transform: translateY(1px); }
</style>
</head>

<body>

<header class="site-header">
  <div class="brand">
    <div class="logo">ANW</div>
    <div class="brand-text">
      <h1>Aderrig Neighbourhood Watch</h1>
      <p class="muted">Adamstown · Community-led · Ireland</p>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="report.html">Report</a>
    <a href="alerts.html">Community Alerts</a>
    <a href="projects.html">Community Projects</a>
    <a href="login.html">Login / Register</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="household.html">Household</a>
    <a href="admin.html" class="active">Admin</a>
  </nav>
</header>

<main class="wrap">

  <section class="card">
    <h2>Admin panel</h2>
    <p class="muted">Manage resident registrations, elections and volunteer tasks.</p>

    <div class="actions admin-tabs" style="margin-top:0.5rem;">
      <button type="button" class="btn small admin-tab active" data-tab="tabResidents">Residents</button>
      <button type="button" class="btn small admin-tab" data-tab="tabTasks">Volunteer tasks</button>
      <button type="button" class="btn small admin-tab" data-tab="tabElections">Elections</button>
      <button type="button" class="btn small admin-tab" data-tab="tabReports">Reports</button>
      <button type="button" class="btn small admin-tab" data-tab="tabTools">Tools</button>
    </div>
  </section>

  <!-- ================= RESIDENTS ================= -->
  <section class="card admin-tab-content" id="tabResidents">
    <h3>Residents</h3>

    <div class="actions resident-tabs" style="margin-top:0.25rem;">
      <button type="button" class="btn small resident-tab active" data-subtab="subPending">Pending</button>
      <button type="button" class="btn small resident-tab" data-subtab="subApproved">Approved</button>
      <button type="button" class="btn small resident-tab" data-subtab="subAll">All</button>
    </div>

    <div id="resSummary" class="tiny muted" style="margin-top:0.5rem;"></div>

    <div style="overflow-x:auto; margin-top:0.75rem;">
      <table style="width:100%;">
        <thead>
          <tr>
            <th>Reg No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Eircode</th>
            <th>Status</th>
            <th>Roles</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody id="resBody"></tbody>
      </table>
    </div>

    <p id="resEmpty" class="tiny muted" style="display:none; margin-top:0.5rem;">No residents found.</p>
  </section>

  <!-- Modal: view/edit resident -->
  <div id="modalResident" class="modal" style="display:none;">
    <div class="modal-content card">
      <div class="modal-header">
        <div>
          <h3 style="margin:0;">Resident details</h3>
          <p class="sub" style="margin-top:0.25rem;">
        Email, Eircode and Registration No are protected and cannot be changed.
      </p>
        </div>
        <button type="button" class="btn-line small" id="btnCloseResident">Close</button>
      </div>
      <div class="modal-body">
        <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Registration No</label>
          <input id="mRegId" type="text" disabled>
        </div>
        <div class="field">
          <label>Status</label>
          <input id="mStatus" type="text" disabled>
      </div>
      <div class="modal-footer" id="residentFooterActions">
        <!-- Buttons move here -->
      </div>
</div>
      </div>

      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Full name</label>
          <input id="mName" type="text">
        </div>
        <div class="field">
          <label>Phone</label>
          <input id="mPhone" type="text">
        </div>
      </div>

      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Email</label>
          <input id="mEmail" type="email" disabled>
        </div>
        <div class="field">
          <label>Eircode</label>
          <input id="mEir" type="text" disabled>
        </div>
      </div>

      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Resident type</label>
          <select id="mType">
            <option value="">Select…</option>
            <option value="owner">Owner</option>
            <option value="tenant">Tenant</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label>Management company</label>
          <input id="mMgmt" type="text">
        </div>
      </div>

      <div class="field">
        <label>Roles</label>
        <label class="chk"><input id="mCoord" type="checkbox"> <span>Street Coordinator</span></label>
        <label class="chk"><input id="mVol" type="checkbox"> <span>Volunteer</span></label>
        <label class="chk"><input id="mAlertAdmin" type="checkbox" disabled> <span>Community Alerts admin (set after approval)</span></label>

        <div style="margin:0.5rem 0 0 1.25rem;">
          <p class="tiny muted" style="margin:0 0 0.25rem;">Volunteer roles (6):</p>
          <div style="display:grid; grid-template-columns:repeat(2, minmax(180px, 1fr)); column-gap:18px; row-gap:4px;">
            <label class="chk"><input id="mVStreet" type="checkbox"> <span>Street watch / patrols</span></label>
            <label class="chk"><input id="mVLeaf" type="checkbox"> <span>Distribute leaflets</span></label>
            <label class="chk"><input id="mVTech" type="checkbox"> <span>Tech support</span></label>
            <label class="chk"><input id="mVEld" type="checkbox"> <span>Elderly checks</span></label>
            <label class="chk"><input id="mVMeet" type="checkbox"> <span>Meeting organiser</span></label>
            <label class="chk"><input id="mVTrans" type="checkbox"> <span>Translation</span></label>
          </div>
        </div>
      </div>

      <p class="tiny muted" id="mMsg" style="margin-top:0.5rem;"></p>

      <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
        <button type="button" class="btn-line small" id="btnReject">Reject</button>
        <button type="button" class="btn small" id="btnSaveResident">Save</button>
        <button type="button" class="btn small" id="btnApprove">Approve</button>
      </div>
    </div>
  </div>

  <!-- Modal: view interest (replaces alert) -->
  <div id="modalInterest" class="modal" style="display:none;">
    <div class="modal-content card">
      <div class="actions" style="justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Candidate interest</h3>
        <button type="button" class="btn-line small" id="btnCloseInterest">Close</button>
      </div>

      <div class="grid-2" style="gap:1rem; margin-top:0.5rem;">
        <div class="field">
          <label>Candidate</label>
          <input id="iName" type="text" disabled>
        </div>
        <div class="field">
          <label>Email</label>
          <input id="iEmail" type="text" disabled>
        </div>
      </div>

      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Role</label>
          <input id="iRole" type="text" disabled>
        </div>
        <div class="field">
          <label>Status</label>
          <input id="iStatus" type="text" disabled>
        </div>
      </div>

      <div class="field">
        <label>Submitted</label>
        <input id="iDate" type="text" disabled>
      </div>

      <div class="field">
        <label>Motivation / experience</label>
        <textarea id="iText" rows="8" readonly></textarea>
      </div>

      <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn-line" type="button" id="btnInterestReject">Reject</button>
        <button class="btn" type="button" id="btnInterestApprove">Approve</button>
      </div>
    </div>
  </div>

  <!-- ================= TASKS ================= -->
  <section class="card admin-tab-content" id="tabTasks" style="display:none;">
    <h3>Volunteer tasks</h3>
    <p class="tiny muted" style="margin-top:0;">
      Tasks are managed in the Household section. This area provides an admin summary only.
    </p>

    <div id="tasksBox" class="card" style="background:#f9fafb;">
      <p class="tiny muted" style="margin:0;">
        Open <a href="household.html">Household</a> to create and monitor volunteer tasks.
      </p>
    </div>
  </section>

  <!-- ================= ELECTIONS ================= -->
  <section class="card admin-tab-content" id="tabElections" style="display:none;">
    <h3>Elections</h3>

    <div class="actions resident-tabs" style="margin-top:0.25rem;">
      <button type="button" class="btn small elect-tab active" data-subtab="subManage">Manage</button>
      <button type="button" class="btn small elect-tab" data-subtab="subCandidates">Candidates</button>
      <button type="button" class="btn small elect-tab" data-subtab="subResults">Results</button>
    </div>

    <!-- Manage -->
    <div id="subManage" class="elect-subtab" style="margin-top:0.75rem;">
      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Role</label>
          <select id="elRole">
            <option value="">Select…</option>
            <option value="area">Area Coordinator</option>
            <option value="assistant">Assistant Area Coordinator</option>
          </select>
        </div>
        <div class="field">
          <label>Status</label>
          <select id="elStatus">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="gap:1rem;">
        <div class="field">
          <label>Start date</label>
          <input id="elStart" type="date">
        </div>
        <div class="field">
          <label>End date</label>
          <input id="elEnd" type="date">
        </div>
      </div>

      <p class="tiny muted" id="elMsg" style="margin-top:0.5rem;"></p>

      <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn" type="button" id="btnCreateElection">Create / Update</button>
      </div>

      <div style="overflow-x:auto; margin-top:0.75rem;">
        <table style="width:100%;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Role</th>
              <th>Period</th>
              <th>Status</th>
              <th>Winner</th>
              <th style="width:200px;">Actions</th>
            </tr>
          </thead>
          <tbody id="elBody"></tbody>
        </table>
      </div>
      <p id="elEmpty" class="tiny muted" style="display:none; margin-top:0.5rem;">No elections configured.</p>
    </div>

    <!-- Candidates -->
    <div id="subCandidates" class="elect-subtab" style="display:none; margin-top:0.75rem;">
      <p class="tiny muted" style="margin-top:0;">
        Candidates come from residents who submitted Interest in their dashboard and were approved here.
      </p>

      <div style="overflow-x:auto; margin-top:0.75rem;">
        <table style="width:100%;">
          <thead>
            <tr>
              <th>Role</th>
              <th>Reg No</th>
              <th>Name</th>
              <th>Email</th>
              <th>Interest status</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="candBody"></tbody>
        </table>
      </div>
      <p id="candEmpty" class="tiny muted" style="display:none; margin-top:0.5rem;">No interests submitted.</p>
    </div>

    <!-- Results -->
    <div id="subResults" class="elect-subtab" style="display:none; margin-top:0.75rem;">
      <p class="tiny muted" style="margin-top:0;">
        Results are calculated from votes stored as 1 vote per household (Reg No) per role.
        A winner is declared only if the leading candidate reaches at least <strong>60%</strong> of total approved households.
      </p>

      <div id="resultsBox"></div>
    </div>

  </section>

  <!-- ================= REPORTS ================= -->
  <section class="card admin-tab-content" id="tabReports" style="display:none;">
    <h3>Reports</h3>
    <p class="tiny muted" style="margin-top:0;">
      Reports are submitted in the Report section. This admin page does not modify report design.
    </p>
    <div class="card" style="background:#f9fafb;">
      <p class="tiny muted" style="margin:0;">
        Open <a href="report.html">Report</a> to view submissions. (If you use localStorage for reports, keep it consistent there.)
      </p>
    </div>
  </section>

  <!-- ================= TOOLS ================= -->
  <section class="card admin-tab-content" id="tabTools" style="display:none;">
    <h3>Tools</h3>
    <p class="tiny muted" style="margin-top:0;">
      Maintenance tools for localStorage. Use carefully.
    </p>

    <div class="actions" style="justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
      <button type="button" class="btn-line" id="btnExport">Export data (JSON)</button>
      <button type="button" class="btn-line" id="btnImport">Import data (JSON)</button>
      <button type="button" class="btn-line" id="btnClearSession">Clear session</button>
      <button type="button" class="btn-line" id="btnResetAll">Reset ALL data</button>
</div>

    <p class="tiny muted" id="toolsMsg" style="margin-top:0.5rem;"></p>

    <textarea id="toolsArea" rows="10" style="width:100%;"></textarea>
  </section>

</main>

<footer>
  <div style="text-align:center;">
    © 2025 Aderrig NW · All rights reserved · <a href="privacy.html">Privacy Policy</a>
  </div>
</footer>

<script src="assets/app-core.js"></script>
<script>
(async function(){
  await anwInitStore();
  'use strict';

  const KEY_USERS = ANW_KEYS.USERS;
  const KEY_ELECTIONS = ANW_KEYS.ELECTIONS;
  const KEY_VOTES = ANW_KEYS.VOTES;

  function loadUsers(){ return anwLoad(KEY_USERS, []); }
  function saveUsers(list){ anwSave(KEY_USERS, list); }
  function loadElections(){ return anwLoad(KEY_ELECTIONS, []); }
  function saveElections(list){ anwSave(KEY_ELECTIONS, list); }
  function loadVotes(){ return anwLoad(KEY_VOTES, {}); }
  function saveVotes(v){ anwSave(KEY_VOTES, v); }

  function isApprovedStatus(st){
    const s = String(st||'').toLowerCase();
    return s === 'approved' || s === 'active';
  }

  /* ---------------- Tabs ---------------- */
  const adminBtns = document.querySelectorAll('.admin-tab');
  const adminPanels = document.querySelectorAll('.admin-tab-content');

  function showAdminTab(id){
    adminBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === id));
    adminPanels.forEach(p => p.style.display = (p.id === id ? 'block' : 'none'));
  }
  adminBtns.forEach(b => b.addEventListener('click', ()=> showAdminTab(b.dataset.tab)));

  const resBtns = document.querySelectorAll('.resident-tab');
  function showResSub(id){
    resBtns.forEach(b => b.classList.toggle('active', b.dataset.subtab === id));
    window.__resFilter = id;
    renderResidents();
  }
  resBtns.forEach(b => b.addEventListener('click', ()=> showResSub(b.dataset.subtab)));
  window.__resFilter = 'subPending';

  const electBtns = document.querySelectorAll('.elect-tab');
  const electPanels = document.querySelectorAll('.elect-subtab');
  function showElectSub(id){
    electBtns.forEach(b => b.classList.toggle('active', b.dataset.subtab === id));
    electPanels.forEach(p => p.style.display = (p.id === id ? 'block' : 'none'));
    if(id === 'subManage') renderElections();
    if(id === 'subCandidates') renderCandidates();
    if(id === 'subResults') renderResults();
  }
  electBtns.forEach(b => b.addEventListener('click', ()=> showElectSub(b.dataset.subtab)));

  /* ---------------- Modal helpers (keeps site style) ---------------- */
  function ensureBackdrop(modalEl, onClose){
    if(!modalEl) return;
    if(!modalEl.__anwBackdropBound){
      modalEl.addEventListener('click', (e)=>{
        if(e.target === modalEl) onClose();
      });
      const content = modalEl.querySelector('.modal-content');
      if(content) content.addEventListener('click', (e)=> e.stopPropagation());
      modalEl.__anwBackdropBound = true;
    }
  }

  /* ---------------- Residents table ---------------- */
  const resBody = document.getElementById('resBody');
  const resEmpty = document.getElementById('resEmpty');
  const resSummary = document.getElementById('resSummary');

  let selectedEmail = null;

  function formatRoles(u){
    const roles = [];
    if(u.isCoordinator) roles.push('Coordinator');
    if(u.isVolunteer) roles.push('Volunteer');
    const vr = u.vol_roles || {};
    const vCount = ['streetWatch','leaflets','tech','elderly','meetings','translation'].filter(k => !!vr[k]).length;
    if(vCount) roles.push(vCount + ' volunteer role(s)');
    return roles.join(', ') || '—';
  }

  function renderResidents(){
    const users = loadUsers();
    let list = users.slice();

    const f = window.__resFilter;
    if(f === 'subPending'){
      list = list.filter(u => String(u.status||'pending').toLowerCase() === 'pending');
    } else if(f === 'subApproved'){
      list = list.filter(u => isApprovedStatus(u.status));
    }

    list.sort((a,b)=>{
      const da = String(a.createdAt||a.date||'');
      const db = String(b.createdAt||b.date||'');
      return db.localeCompare(da);
    });

    resBody.innerHTML = '';
    if(!list.length){
      resEmpty.style.display = 'block';
      resSummary.textContent = '';
      return;
    }
    resEmpty.style.display = 'none';

    const total = users.length;
    const pending = users.filter(u => String(u.status||'').toLowerCase()==='pending').length;
    const approved = users.filter(u => isApprovedStatus(u.status)).length;
    resSummary.textContent = `Total: ${total} · Pending: ${pending} · Approved: ${approved}`;

    list.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.regId || '—'}</td>
        <td>${u.name || '—'}</td>
        <td>${u.email || '—'}</td>
        <td>${u.eircode || '—'}</td>
        <td>${u.status || 'pending'}</td>
        <td>${formatRoles(u)}</td>
        <td>
          <div class="actions" style="justify-content:flex-end; gap:0.35rem; flex-wrap:wrap;">
            <button type="button" class="btn ghost" class="btn-line small" data-act="view" data-email="${encodeURIComponent(u.email||'')}">Edit</button>
            <button type="button" class="btn small" data-act="approve" data-email="${encodeURIComponent(u.email||'')}" ${isApprovedStatus(u.status)?'disabled':''}>Approve</button>
          </div>
        </td>
      `;
      resBody.appendChild(tr);
    });

    resBody.querySelectorAll('button[data-act="view"]').forEach(btn=>{
      btn.addEventListener('click', ()=> openResident(decodeURIComponent(btn.dataset.email)));
    });
    resBody.querySelectorAll('button[data-act="approve"]').forEach(btn=>{
      btn.addEventListener('click', ()=> approveResident(decodeURIComponent(btn.dataset.email)));
    });
  }

  /* ---------------- Resident Modal ---------------- */
  const modal = document.getElementById('modalResident');
  const closeBtn = document.getElementById('btnCloseResident');
  closeBtn.addEventListener('click', ()=> closeResidentModal());

  ensureBackdrop(modal, closeResidentModal);

  function closeResidentModal(){
    modal.classList.remove('show');
    modal.style.display = 'none';
    selectedEmail = null;
  }

  function openResident(email){
    const users = loadUsers();
    const u = users.find(x => anwNormEmail(x.email) === anwNormEmail(email));
    if(!u) return;

    selectedEmail = u.email;

    document.getElementById('mRegId').value = u.regId || '—';
    document.getElementById('mStatus').value = u.status || 'pending';
    document.getElementById('mName').value = u.name || '';
    document.getElementById('mPhone').value = u.phone || '';
    document.getElementById('mEmail').value = u.email || '';
    document.getElementById('mEir').value = u.eircode || '';
    document.getElementById('mType').value = u.type || '';
    document.getElementById('mMgmt').value = u.managementCompany || '';

    document.getElementById('mCoord').checked = !!u.isCoordinator;
    document.getElementById('mVol').checked = !!u.isVolunteer;
    document.getElementById('mAlertAdmin').checked = !!u.isAlertAdmin;

    const vr = u.vol_roles || {};
    document.getElementById('mVStreet').checked = !!vr.streetWatch;
    document.getElementById('mVLeaf').checked = !!vr.leaflets;
    document.getElementById('mVTech').checked = !!vr.tech;
    document.getElementById('mVEld').checked = !!vr.elderly;
    document.getElementById('mVMeet').checked = !!vr.meetings;
    document.getElementById('mVTrans').checked = !!vr.translation;

    document.getElementById('btnApprove').disabled = isApprovedStatus(u.status);
    document.getElementById('mMsg').textContent = '';

    modal.style.display = 'flex';
    modal.classList.add('show');
  }

  function updateUserFromModal(u){
    u.name = document.getElementById('mName').value.trim();
    u.phone = document.getElementById('mPhone').value.trim();
    u.type = document.getElementById('mType').value;
    u.managementCompany = document.getElementById('mMgmt').value.trim();

    u.isCoordinator = document.getElementById('mCoord').checked;
    u.isVolunteer = document.getElementById('mVol').checked;

    u.vol_roles = u.vol_roles || {};
    u.vol_roles.streetWatch = document.getElementById('mVStreet').checked;
    u.vol_roles.leaflets    = document.getElementById('mVLeaf').checked;
    u.vol_roles.tech        = document.getElementById('mVTech').checked;
    u.vol_roles.elderly     = document.getElementById('mVEld').checked;
    u.vol_roles.meetings    = document.getElementById('mVMeet').checked;
    u.vol_roles.translation = document.getElementById('mVTrans').checked;
  }

  document.getElementById('btnSaveResident').addEventListener('click', ()=>{
    if(!selectedEmail) return;
    const users = loadUsers();
    const idx = users.findIndex(x => anwNormEmail(x.email) === anwNormEmail(selectedEmail));
    if(idx < 0) return;

    const u = users[idx];
    const prevStatus = String(u.status||'pending').toLowerCase();

    updateUserFromModal(u);

    // Saving does NOT change status
    u.status = prevStatus === 'pending' ? 'pending' : (u.status || 'approved');

    saveUsers(users);
    document.getElementById('mMsg').textContent = 'Saved. (Status changes only when you click Approve.)';
    renderResidents();
  });

  function approveResident(email){
    if(!confirm('Approve this resident? A registration number will be assigned if missing.')) return;

    const users = loadUsers();
    const idx = users.findIndex(x => anwNormEmail(x.email) === anwNormEmail(email));
    if(idx < 0) return;

    const u = users[idx];
    if(!u.regId){
      u.regId = anwNextRegId();
    }
    u.status = 'active';
    saveUsers(users);

    renderResidents();
    if(selectedEmail && anwNormEmail(selectedEmail) === anwNormEmail(u.email)){
      openResident(u.email);
    }
  }

  document.getElementById('btnApprove').addEventListener('click', ()=>{
    if(!selectedEmail) return;
    approveResident(selectedEmail);
  });

  document.getElementById('btnReject').addEventListener('click', ()=>{
    if(!selectedEmail) return;
    if(!confirm('Reject this registration? This will set status to rejected.')) return;

    const users = loadUsers();
    const idx = users.findIndex(x => anwNormEmail(x.email) === anwNormEmail(selectedEmail));
    if(idx < 0) return;

    users[idx].status = 'rejected';
    saveUsers(users);
    renderResidents();
    openResident(selectedEmail);
  });

  /* ---------------- Elections: Manage ---------------- */
  const elBody = document.getElementById('elBody');
  const elEmpty = document.getElementById('elEmpty');
  const elRole = document.getElementById('elRole');
  const elStatus = document.getElementById('elStatus');
  const elStart = document.getElementById('elStart');
  const elEnd = document.getElementById('elEnd');
  const elMsg = document.getElementById('elMsg');

  function roleKeyFromLabel(val){
    return String(val||'').toLowerCase();
  }

  function renderElections(){
    const elections = loadElections();
    elBody.innerHTML = '';
    if(!elections.length){
      elEmpty.style.display = 'block';
      return;
    }
    elEmpty.style.display = 'none';

    elections.forEach(e=>{
      const tr = document.createElement('tr');
      const winner = e.electedName || e.winnerName || e.electedEmail || '—';
      tr.innerHTML = `
        <td>${e.id || '—'}</td>
        <td>${e.role === 'assistant' ? 'Assistant Area Coordinator' : 'Area Coordinator'}</td>
        <td>${e.start || '—'} → ${e.end || '—'}</td>
        <td>${e.status || '—'}</td>
        <td>${winner}</td>
        <td>
          <div class="actions" style="justify-content:flex-end; gap:0.35rem; flex-wrap:wrap;">
            <button class="btn-line small" type="button" data-act="editEl" data-id="${e.id}">Edit</button>
            <button class="btn-line small" type="button" data-act="toggleEl" data-id="${e.id}">${String(e.status||'').toLowerCase()==='open'?'Close':'Open'}</button>
            <button class="btn-line small" type="button" data-act="delEl" data-id="${e.id}">Delete</button>
          </div>
        </td>
      `;
      elBody.appendChild(tr);
    });

    elBody.querySelectorAll('button[data-act="editEl"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        const elections = loadElections();
        const e = elections.find(x => String(x.id) === String(id));
        if(!e) return;
        elRole.value = e.role || '';
        elStatus.value = e.status || 'open';
        elStart.value = e.start || '';
        elEnd.value = e.end || '';
        elMsg.textContent = `Editing election: ${e.id}`;
        window.__editingElectionId = e.id;
      });
    });

    elBody.querySelectorAll('button[data-act="delEl"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        if(!confirm('Delete this election?')) return;
        let elections = loadElections();
        elections = elections.filter(x => String(x.id) !== String(id));
        saveElections(elections);
        renderElections();
        renderResults();
      });
    });

    elBody.querySelectorAll('button[data-act="toggleEl"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        const elections = loadElections();
        const idx = elections.findIndex(x => String(x.id) === String(id));
        if(idx < 0) return;

        const e = elections[idx];
        const curr = String(e.status||'open').toLowerCase();
        if(curr === 'open'){
          closeElectionWithRules(elections, idx);
        } else {
          if(!confirm('Re-open this election?')) return;
          e.status = 'open';
          saveElections(elections);
          renderElections();
          renderResults();
        }
      });
    });
  }

  function clearElectionForm(){
    elRole.value = '';
    elStatus.value = 'open';
    elStart.value = '';
    elEnd.value = '';
    elMsg.textContent = '';
    window.__editingElectionId = null;
  }  document.getElementById('btnCreateElection').addEventListener('click', ()=>{
    const role = roleKeyFromLabel(elRole.value);
    if(!role){
      elMsg.textContent = 'Please select a role.';
      return;
    }
    const elections = loadElections();
    const id = window.__editingElectionId || ('EL-' + Date.now());

    const existingIdx = elections.findIndex(e => String(e.id) === String(id));
    const obj = {
      id,
      role,
      start: elStart.value || '',
      end: elEnd.value || '',
      status: elStatus.value || 'open',
      electedRegId: existingIdx >= 0 ? (elections[existingIdx].electedRegId || '') : '',
      electedEmail: existingIdx >= 0 ? (elections[existingIdx].electedEmail || '') : '',
      electedName: existingIdx >= 0 ? (elections[existingIdx].electedName || '') : ''
    };

    if(existingIdx >= 0){
      elections[existingIdx] = { ...elections[existingIdx], ...obj };
      elMsg.textContent = 'Election updated.';
    } else {
      elections.push(obj);
      elMsg.textContent = 'Election created.';
    }

    saveElections(elections);
    renderElections();
    renderResults();
    clearElectionForm();
  });

  /* ---------------- Elections: Candidates (Interest approvals) ---------------- */
  const candBody = document.getElementById('candBody');
  const candEmpty = document.getElementById('candEmpty');

  function renderCandidates(){
    const users = loadUsers();
    const interests = users
      .filter(u => u && u.interest && (u.interest.role || u.interest.text))
      .map(u => u);

    candBody.innerHTML = '';
    if(!interests.length){
      candEmpty.style.display = 'block';
      return;
    }
    candEmpty.style.display = 'none';

    interests.sort((a,b)=> String(b.interest?.date||'').localeCompare(String(a.interest?.date||'')));

    interests.forEach(u=>{
      const role = String(u.interest.role||'').toLowerCase();
      const roleLabel = role === 'assistant' ? 'Assistant Area Coordinator' : 'Area Coordinator';
      const st = String(u.interest.status||'pending').toLowerCase();

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${roleLabel}</td>
        <td>${u.regId || '—'}</td>
        <td>${u.name || '—'}</td>
        <td>${u.email || '—'}</td>
        <td>${st}</td>
        <td>
          <div class="actions" style="justify-content:flex-end; gap:0.35rem; flex-wrap:wrap;">
            <button class="btn-line small" type="button" data-act="viewInt" data-email="${encodeURIComponent(u.email||'')}">View</button>
            <button class="btn small" type="button" data-act="appInt" data-email="${encodeURIComponent(u.email||'')}" ${st==='approved'?'disabled':''}>Approve</button>
            <button class="btn-line small" type="button" data-act="rejInt" data-email="${encodeURIComponent(u.email||'')}">Reject</button>
          </div>
        </td>
      `;
      candBody.appendChild(tr);
    });

    candBody.querySelectorAll('button[data-act="viewInt"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const email = decodeURIComponent(b.dataset.email);
        openInterestPreview(email);
      });
    });

    candBody.querySelectorAll('button[data-act="appInt"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const email = decodeURIComponent(b.dataset.email);
        setInterestStatus(email, 'approved');
      });
    });

    candBody.querySelectorAll('button[data-act="rejInt"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const email = decodeURIComponent(b.dataset.email);
        setInterestStatus(email, 'rejected');
      });
    });
  }

  /* Interest modal wiring */
  const modalInterest = document.getElementById('modalInterest');
  const btnCloseInterest = document.getElementById('btnCloseInterest');
  const btnInterestApprove = document.getElementById('btnInterestApprove');
  const btnInterestReject  = document.getElementById('btnInterestReject');

  function closeInterestModal(){
    modalInterest.classList.remove('show');
    modalInterest.style.display = 'none';
    window.__interestEmail = null;
  }

  ensureBackdrop(modalInterest, closeInterestModal);
  btnCloseInterest.addEventListener('click', closeInterestModal);

  btnInterestApprove.addEventListener('click', ()=>{
    if(!window.__interestEmail) return;
    setInterestStatus(window.__interestEmail, 'approved');
    closeInterestModal();
  });

  btnInterestReject.addEventListener('click', ()=>{
    if(!window.__interestEmail) return;
    setInterestStatus(window.__interestEmail, 'rejected');
    closeInterestModal();
  });

  function openInterestPreview(email){
    const users = loadUsers();
    const u = users.find(x => anwNormEmail(x.email) === anwNormEmail(email));
    if(!u || !u.interest) return;

    document.getElementById('iName').value = u.name || 'Candidate';
    document.getElementById('iEmail').value = u.email || '—';
    document.getElementById('iRole').value = (String(u.interest.role||'').toLowerCase()==='assistant')
      ? 'Assistant Area Coordinator'
      : 'Area Coordinator';
    document.getElementById('iStatus').value = u.interest.status || 'pending';
    document.getElementById('iDate').value = u.interest.date || '';
    document.getElementById('iText').value = u.interest.text || '';

    window.__interestEmail = u.email;

    const st = String(u.interest.status||'pending').toLowerCase();
    btnInterestApprove.disabled = (st === 'approved');

    modalInterest.style.display = 'flex';
    modalInterest.classList.add('show');
  }

  function setInterestStatus(email, status){
    if(!confirm(`Set interest status to ${status}?`)) return;
    const users = loadUsers();
    const idx = users.findIndex(x => anwNormEmail(x.email) === anwNormEmail(email));
    if(idx < 0) return;

    users[idx].interest = users[idx].interest || {};
    users[idx].interest.status = status;
    saveUsers(users);

    renderCandidates();
    renderResults();
  }

  /* ---------------- Elections: Results ---------------- */
  const resultsBox = document.getElementById('resultsBox');

  function computeResultsForRole(role){
    const users = loadUsers();
    const votes = loadVotes();

    const approvedHouseholds = users
      .filter(u => isApprovedStatus(u.status) && u.regId)
      .map(u => u.regId);

    const totalHouseholds = approvedHouseholds.length;

    const candidates = users.filter(u =>
      u.regId &&
      u.interest &&
      String(u.interest.role||'').toLowerCase() === role &&
      String(u.interest.status||'').toLowerCase() === 'approved'
    );

    const tally = {};
    candidates.forEach(c => {
      tally[c.regId] = { regId: c.regId, name: c.name || 'Candidate', email: c.email || '', votes: 0 };
    });

    Object.keys(votes || {}).forEach(k=>{
      if(!k.endsWith('|' + role)) return;
      const voterReg = k.split('|')[0];
      if(!approvedHouseholds.includes(voterReg)) return;

      const votedReg = votes[k];
      if(tally[votedReg]) tally[votedReg].votes += 1;
    });

    const rows = Object.values(tally).sort((a,b)=> b.votes - a.votes);
    const leader = rows[0] || null;
    const leaderPct = leader && totalHouseholds ? (leader.votes / totalHouseholds) * 100 : 0;

    return { totalHouseholds, rows, leader, leaderPct };
  }

  function renderResults(){
    resultsBox.innerHTML = '';

    const roles = ['area','assistant'];

    roles.forEach(role=>{
      const box = document.createElement('div');
      box.className = 'card';
      box.style.background = '#f9fafb';

      const { totalHouseholds, rows, leader, leaderPct } = computeResultsForRole(role);
      const roleLabel = role === 'assistant' ? 'Assistant Area Coordinator' : 'Area Coordinator';

      let html = `<h4 style="margin-top:0;">${roleLabel}</h4>`;
      html += `<p class="tiny muted" style="margin-top:0.25rem;">Approved households: ${totalHouseholds}</p>`;

      if(!rows.length){
        html += `<p class="tiny muted">No approved candidates for this role.</p>`;
        box.innerHTML = html;
        resultsBox.appendChild(box);
        return;
      }

      html += `<div style="overflow-x:auto;"><table style="width:100%;">
        <thead><tr><th>Reg No</th><th>Name</th><th>Votes</th><th>% of households</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        const pct = totalHouseholds ? ((r.votes/totalHouseholds)*100) : 0;
        html += `<tr><td>${r.regId}</td><td>${r.name}</td><td>${r.votes}</td><td>${pct.toFixed(1)}%</td></tr>`;
      });
      html += `</tbody></table></div>`;

      if(leader){
        html += `<p class="tiny" style="margin-top:0.5rem;"><strong>Leader:</strong> ${leader.name} (${leader.votes} vote(s), ${leaderPct.toFixed(1)}%)</p>`;
      }
      box.innerHTML = html;
      resultsBox.appendChild(box);
    });
  }

  /* ✅ NEW: persist elected winner into anw_users (profile sync) */
  function markElectedWinner(role, leader, electionId){
    if(!leader || !leader.regId) return;

    const users = loadUsers();

    // clear previous elected for same role (keep only one winner per role)
    users.forEach(u=>{
      if(!u) return;
      if(String(u.electedRole||'').toLowerCase() === role){
        delete u.electedRole;
        delete u.electedAt;
        delete u.electedElectionId;
      }
    });

    const idx = users.findIndex(u => String(u.regId||'') === String(leader.regId));
    if(idx >= 0){
      users[idx].electedRole = role;
      users[idx].electedAt = new Date().toISOString().slice(0,10);
      users[idx].electedElectionId = electionId || '';
    }

    saveUsers(users);
  }

  function closeElectionWithRules(elections, idx){
    const e = elections[idx];
    const role = String(e.role||'').toLowerCase();

    const { totalHouseholds, leader, leaderPct } = computeResultsForRole(role);

    if(!confirm(`Close this election now?`)) return;

    if(leader && totalHouseholds > 0 && leaderPct >= 60){
      e.status = 'closed';
      e.electedRegId = leader.regId;
      e.electedName = leader.name;
      e.electedEmail = leader.email;

      // ✅ NEW: sync into user profile
      markElectedWinner(role, leader, e.id);

      saveElections(elections);
      renderElections();
      renderResults();
      return;
    }

    const msg = leader
      ? `Leader is at ${leaderPct.toFixed(1)}% (needs 60%). Close anyway WITHOUT declaring a winner?`
      : 'No votes/candidates found. Close anyway?';

    if(!confirm(msg)) return;

    e.status = 'closed';
    e.electedRegId = '';
    e.electedName = '';
    e.electedEmail = '';
    saveElections(elections);
    renderElections();
    renderResults();
  }

  /* ---------------- Tools ---------------- */
  const toolsArea = document.getElementById('toolsArea');
  const toolsMsg = document.getElementById('toolsMsg');

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const dump = {
      [KEY_USERS]: loadUsers(),
      [KEY_ELECTIONS]: loadElections(),
      [KEY_VOTES]: loadVotes()
    };
    toolsArea.value = JSON.stringify(dump, null, 2);
    toolsMsg.textContent = 'Exported into the text area.';
  });

  document.getElementById('btnImport').addEventListener('click', ()=>{
    const raw = toolsArea.value.trim();
    if(!raw) { toolsMsg.textContent = 'Paste JSON first.'; return; }
    if(!confirm('Import will overwrite current data for users, elections and votes. Continue?')) return;
    try{
      const obj = JSON.parse(raw);
      if(obj && obj[KEY_USERS]) saveUsers(obj[KEY_USERS]);
      if(obj && obj[KEY_ELECTIONS]) saveElections(obj[KEY_ELECTIONS]);
      if(obj && obj[KEY_VOTES]) saveVotes(obj[KEY_VOTES]);
      toolsMsg.textContent = 'Imported.';
      renderResidents();
      renderElections();
      renderCandidates();
      renderResults();
    }catch(e){
      toolsMsg.textContent = 'Invalid JSON.';
    }
  });

  document.getElementById('btnClearSession').addEventListener('click', async ()=>{
    if(!confirm('Clear current session (logged user)?')) return;
    await anwSave(ANW_KEYS.LOGGED, null);
    toolsMsg.textContent = 'Session cleared.';
  });

  document.getElementById('btnResetAll').addEventListener('click', async ()=>{
    await anwSave(KEY_USERS, null);
    await anwSave(KEY_ELECTIONS, null);
    await anwSave(KEY_VOTES, null);
    toolsMsg.textContent = 'All data reset.';
    renderResidents();
    renderElections();
    renderCandidates();
    renderResults();
  });

  /* ---------------- Init ---------------- */
  renderResidents();
  renderElections();
  renderCandidates();
  renderResults();

  showElectSub('subManage');
})();
</script>

</body>
</html>
